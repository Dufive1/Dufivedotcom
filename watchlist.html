<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DUFIVE | The Queue</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:ital,wght@0,600;0,700;1,600&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root, [data-theme="light"] {
      --bg: #fafafa; --bg-secondary: #f5f5f5; --card-bg: #ffffff;
      --text: #0a0a0a; --text-secondary: #737373; --text-muted: #a3a3a3;
      --accent: #2563eb; --accent-hover: #1d4ed8;
      --border: #e5e5e5; --border-light: #f5f5f5;
      --greg: #ea580c; --greg-bg: rgba(234, 88, 12, 0.08);
      --peer: #2563eb; --peer-bg: rgba(37, 99, 235, 0.08);
      --shadow: 0 1px 3px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.02);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.06), 0 4px 6px -2px rgba(0,0,0,0.03);
      --radius: 8px; --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      --overlay-bg: rgba(0,0,0,0.6);
      --success: #16a34a;
    }
    [data-theme="dark"] {
      --bg: #0a0a0a; --bg-secondary: #171717; --card-bg: #1c1c1e;
      --text: #f5f5f5; --text-secondary: #a3a3a3; --text-muted: #6b7280;
      --accent: #3b82f6; --accent-hover: #60a5fa;
      --border: #2d2d2d; --border-light: #1f1f1f;
      --greg: #fb923c; --greg-bg: rgba(251, 146, 60, 0.1);
      --peer: #60a5fa; --peer-bg: rgba(96, 165, 250, 0.1);
      --shadow: 0 1px 3px rgba(0,0,0,0.3); --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.4);
      --overlay-bg: rgba(0,0,0,0.75);
      --success: #22c55e;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg); color: var(--text);
      line-height: 1.5; -webkit-font-smoothing: antialiased;
    }
    .container { max-width: 860px; margin: 0 auto; padding: 0 24px 60px; }

    /* ───── Nav ───── */
    nav {
      display: flex; justify-content: space-between; align-items: center;
      padding: 24px 0; margin-bottom: 32px;
      border-bottom: 1px solid var(--border);
    }
    .brand {
      font-family: 'Playfair Display', serif; font-size: 1.25rem; font-weight: 700;
      color: var(--text); text-decoration: none; letter-spacing: -0.02em;
    }
    .nav-controls { display: flex; gap: 8px; align-items: center; }
    .nav-link {
      font-size: 0.8rem; font-weight: 600; color: var(--text-secondary);
      text-decoration: none; padding: 6px 12px; border-radius: 6px; transition: var(--transition);
    }
    .nav-link:hover { color: var(--accent); background: var(--border-light); }
    .nav-link.active { color: var(--accent); }
    .theme-toggle {
      width: 34px; height: 34px; border-radius: 50%; border: 1px solid var(--border);
      background: var(--card-bg); cursor: pointer; font-size: 1rem; transition: var(--transition);
      display: flex; align-items: center; justify-content: center; color: var(--text);
    }
    .theme-toggle:hover { background: var(--border-light); border-color: var(--accent); }

    /* ───── Header ───── */
    header { text-align: center; margin-bottom: 32px; }
    .page-title {
      font-family: 'Playfair Display', serif; font-size: clamp(1.6rem, 4vw, 2.4rem);
      font-weight: 700; letter-spacing: -0.03em; margin-bottom: 6px;
    }
    .tagline { font-size: 0.9rem; color: var(--text-muted); }
    .queue-count {
      display: inline-block; font-size: 0.8rem; font-weight: 700; color: var(--accent);
      background: var(--border-light); border: 1px solid var(--border);
      padding: 4px 12px; border-radius: 20px; margin-top: 10px;
    }

    /* ───── Add Film Section ───── */
    .add-section {
      margin-bottom: 32px; padding: 20px; background: var(--card-bg);
      border: 1px solid var(--border); border-radius: 12px; box-shadow: var(--shadow);
    }
    .add-section.hidden { display: none; }
    .add-label {
      font-size: 0.75rem; font-weight: 600; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 10px;
    }
    .search-row { display: flex; gap: 8px; position: relative; }
    .search-input {
      flex: 1; padding: 10px 14px; font-size: 0.9rem; font-family: inherit;
      border: 1px solid var(--border); border-radius: 8px; background: var(--bg);
      color: var(--text); outline: none; transition: var(--transition);
    }
    .search-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
    .search-input::placeholder { color: var(--text-muted); }

    /* Search results dropdown */
    .search-results {
      position: absolute; top: 100%; left: 0; right: 0; z-index: 50;
      margin-top: 4px; background: var(--card-bg); border: 1px solid var(--border);
      border-radius: 10px; box-shadow: var(--shadow-lg); max-height: 320px;
      overflow-y: auto; display: none;
    }
    .search-results.visible { display: block; }
    .search-result {
      display: flex; align-items: center; gap: 12px; padding: 10px 14px;
      cursor: pointer; transition: var(--transition); border-bottom: 1px solid var(--border-light);
    }
    .search-result:last-child { border-bottom: none; }
    .search-result:hover { background: var(--border-light); }
    .search-result-poster {
      width: 36px; height: 54px; border-radius: 4px; object-fit: cover;
      background: var(--border-light); flex-shrink: 0;
    }
    .search-result-info { flex: 1; min-width: 0; }
    .search-result-title {
      font-size: 0.85rem; font-weight: 600; color: var(--text);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .search-result-meta { font-size: 0.7rem; color: var(--text-muted); }
    .search-result-actions { display: flex; gap: 4px; flex-shrink: 0; }
    .search-result-add {
      font-size: 0.65rem; font-weight: 700; color: var(--accent);
      background: none; border: 1px solid var(--accent); border-radius: 6px;
      padding: 4px 8px; cursor: pointer; transition: var(--transition); white-space: nowrap;
    }
    .search-result-add:hover { background: var(--accent); color: #fff; }
    .search-result-add.greg { color: var(--greg); border-color: var(--greg); }
    .search-result-add.greg:hover { background: var(--greg); color: #fff; }
    .search-result-add.peer { color: var(--peer); border-color: var(--peer); }
    .search-result-add.peer:hover { background: var(--peer); color: #fff; }
    .search-result.in-queue .search-result-add {
      color: var(--text-muted); border-color: var(--border); cursor: default;
    }
    .search-no-results {
      padding: 16px; text-align: center; font-size: 0.85rem; color: var(--text-muted);
    }

    /* ───── Filter chips ───── */
    .filters {
      display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; margin-bottom: 24px;
    }
    .filter-chip {
      font-size: 0.75rem; font-weight: 600; padding: 6px 14px; border-radius: 20px;
      border: 1px solid var(--border); background: var(--card-bg); color: var(--text-secondary);
      cursor: pointer; transition: var(--transition); user-select: none;
    }
    .filter-chip:hover { border-color: var(--accent); color: var(--accent); }
    .filter-chip.active { background: var(--accent); color: #fff; border-color: var(--accent); }

    /* ───── Login prompt ───── */
    .login-prompt {
      text-align: center; padding: 16px; margin-bottom: 24px;
      font-size: 0.85rem; color: var(--text-muted);
      border: 1px dashed var(--border); border-radius: 10px; background: var(--bg-secondary);
    }

    /* ───── Queue Grid ───── */
    .queue-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 16px;
    }
    @media (max-width: 480px) {
      .queue-grid { grid-template-columns: repeat(3, 1fr); gap: 10px; }
    }

    .queue-card {
      background: var(--card-bg); border: 1px solid var(--border); border-radius: 10px;
      overflow: hidden; box-shadow: var(--shadow); transition: var(--transition);
      animation: fadeUp 0.3s ease forwards; opacity: 0;
      position: relative;
    }
    .queue-card:hover { box-shadow: var(--shadow-lg); transform: translateY(-2px); }

    .queue-poster {
      aspect-ratio: 2/3; background: var(--border-light); overflow: hidden;
      position: relative;
    }
    .queue-poster img {
      width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease;
    }
    .queue-card:hover .queue-poster img { transform: scale(1.04); }
    .queue-poster-fallback {
      width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;
      padding: 12px; text-align: center;
      background: linear-gradient(135deg, var(--border-light) 0%, var(--border) 100%);
    }
    .queue-poster-fallback span {
      font-family: 'Playfair Display', serif; font-size: 0.85rem; font-weight: 700;
      color: var(--text-muted); line-height: 1.2;
    }

    /* Assigned-to badge */
    .assigned-badge {
      position: absolute; top: 6px; left: 6px; font-size: 0.6rem; font-weight: 700;
      padding: 2px 7px; border-radius: 4px; text-transform: uppercase;
      letter-spacing: 0.04em; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
    }
    .assigned-badge.greg { background: rgba(234,88,12,0.85); color: #fff; }
    .assigned-badge.peer { background: rgba(37,99,235,0.85); color: #fff; }
    .assigned-badge.both { background: rgba(80,80,80,0.8); color: #fff; }
    /* Suggested-by tag (bottom) */
    .suggested-tag {
      font-size: 0.6rem; color: var(--text-muted); margin-top: 2px;
    }

    /* Remove button */
    .queue-remove {
      position: absolute; top: 6px; right: 6px; width: 22px; height: 22px;
      border-radius: 50%; background: rgba(0,0,0,0.6); color: #fff; border: none;
      font-size: 0.75rem; cursor: pointer; display: none; align-items: center;
      justify-content: center; transition: var(--transition); backdrop-filter: blur(4px);
    }
    .queue-card:hover .queue-remove { display: flex; }
    .queue-remove:hover { background: #ef4444; }

    .queue-info { padding: 8px 10px 10px; }
    .queue-title {
      font-size: 0.78rem; font-weight: 600; color: var(--text); line-height: 1.3;
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .queue-note {
      font-size: 0.68rem; color: var(--text-muted); margin-top: 3px; font-style: italic;
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .queue-date { font-size: 0.6rem; color: var(--text-muted); margin-top: 4px; }

    /* ───── Empty State ───── */
    .empty-state {
      text-align: center; padding: 60px 20px; color: var(--text-muted);
    }
    .empty-icon { font-size: 3rem; margin-bottom: 12px; }
    .empty-title {
      font-family: 'Playfair Display', serif; font-size: 1.3rem; font-weight: 700;
      color: var(--text-secondary); margin-bottom: 6px;
    }
    .empty-text { font-size: 0.85rem; max-width: 300px; margin: 0 auto; }

    /* ───── Recently Watched (cleared from queue) ───── */
    .watched-section { margin-top: 48px; }
    .watched-header {
      font-size: 0.75rem; font-weight: 600; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 12px;
      padding-bottom: 8px; border-bottom: 1px solid var(--border-light);
    }
    .watched-list { display: flex; flex-direction: column; gap: 8px; }
    .watched-item {
      display: flex; align-items: center; gap: 10px; padding: 8px 12px;
      background: var(--bg-secondary); border-radius: 8px; font-size: 0.8rem;
      color: var(--text-secondary); opacity: 0.7;
    }
    .watched-item-check { color: var(--success); font-size: 0.9rem; }
    .watched-item-title { flex: 1; }
    .watched-item-date { font-size: 0.7rem; color: var(--text-muted); }

    /* ───── Toast ───── */
    .toast {
      position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(100px);
      background: var(--card-bg); border: 1px solid var(--border); color: var(--text);
      padding: 10px 20px; border-radius: 10px; font-size: 0.85rem; font-weight: 500;
      box-shadow: var(--shadow-lg); z-index: 999; transition: transform 0.3s ease;
      pointer-events: none;
    }
    .toast.show { transform: translateX(-50%) translateY(0); }

    /* ───── Footer ───── */
    .footer {
      text-align: center; padding: 32px 0; margin-top: 40px;
      border-top: 1px solid var(--border-light); font-size: 0.7rem; color: var(--text-muted);
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ───── Loading ───── */
    .loading {
      text-align: center; padding: 40px; color: var(--text-muted); font-size: 0.9rem;
    }
  </style>
</head>
<body>

<div class="container">
  <nav>
    <a href="/" class="brand">DUFIVE</a>
    <div class="nav-controls">
      <a href="/" class="nav-link">Ledger</a>
      <a href="disagreements.html" class="nav-link">Debates</a>
      <a href="watchlist.html" class="nav-link active">Queue</a>
      <button id="theme-toggle" class="theme-toggle" title="Toggle dark mode">
        <span id="theme-icon">&#9790;</span>
      </button>
    </div>
  </nav>

  <header>
    <h1 class="page-title">The Queue</h1>
    <p class="tagline">Films to watch. Drop one in, the other sees it.</p>
    <div class="queue-count" id="queue-count"></div>
  </header>

  <!-- Login prompt for guests -->
  <div class="login-prompt" id="login-prompt">
    Log in on the <a href="/" style="color:var(--accent)">Ledger</a> to add films to the queue.
  </div>

  <!-- Add film search (only visible when logged in) -->
  <div class="add-section hidden" id="add-section">
    <div class="add-label">Add a film to the queue</div>
    <div class="search-row">
      <input type="text" class="search-input" id="film-search" placeholder="Search Greg's films..." autocomplete="off" />
      <div class="search-results" id="search-results"></div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters" id="filters">
    <div class="filter-chip active" data-filter="all">All</div>
    <div class="filter-chip" data-filter="greg">For Greg</div>
    <div class="filter-chip" data-filter="peer">For Peer</div>
    <div class="filter-chip" data-filter="both">Must Watch</div>
  </div>

  <!-- Queue grid -->
  <div id="queue-area">
    <div class="loading" id="loading">Loading queue...</div>
    <div class="queue-grid" id="queue-grid"></div>
    <div class="empty-state" id="empty-state" style="display:none">
      <div class="empty-icon">&#127910;</div>
      <div class="empty-title">Nothing in the queue</div>
      <div class="empty-text">Add a film above and it'll show up here for both of you.</div>
    </div>
  </div>

  <!-- Recently watched (auto-completed) -->
  <div class="watched-section" id="watched-section" style="display:none">
    <div class="watched-header">Recently cleared</div>
    <div class="watched-list" id="watched-list"></div>
  </div>

  <div class="footer">
    DUFIVE &mdash; The Ledger
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  // ───── Config ─────
  const SB_URL = 'https://brgxorrpfberfcyeugzq.supabase.co';
  const SB_KEY = 'sb_publishable_VbVFBh-gtIBAbr9Qtp240w_GS8Kn4Jf';
  const ACTIONS_URL = 'https://brgxorrpfberfcyeugzq.supabase.co/functions/v1/bright-function';
  const supabaseClient = window.supabase.createClient(SB_URL, SB_KEY);

  let currentUser = null;
  let authToken = null;
  let allGregFilms = []; // Cache for search
  let queueItems = [];
  let watchedItems = [];
  let activeFilter = 'all';

  // ───── Auth (shared with main page via localStorage) ─────
  function loadSession() {
    const reviewer = localStorage.getItem('reviewer');
    const token = localStorage.getItem('session_token');
    if (reviewer && token) {
      currentUser = reviewer;
      authToken = token;
    }
  }

  function isAdmin() { return currentUser === 'admin'; }
  function canAct() { return !!currentUser; }

  // ───── Theme ─────
  const savedTheme = localStorage.getItem('dufive-theme') || 'light';
  document.documentElement.setAttribute('data-theme', savedTheme);
  document.getElementById('theme-icon').textContent = savedTheme === 'dark' ? '\u2600' : '\u263E';
  document.getElementById('theme-toggle').addEventListener('click', () => {
    const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('dufive-theme', next);
    document.getElementById('theme-icon').textContent = next === 'dark' ? '\u2600' : '\u263E';
  });

  // ───── Toast ─────
  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2500);
  }

  // ───── Fetch all Greg films for search ─────
  async function fetchGregFilms() {
    const BATCH = 1000;
    let all = [], from = 0, more = true;
    while (more) {
      const { data } = await supabaseClient
        .from('greg_films')
        .select('movie_key, title, poster_url, letterboxd_url')
        .order('title', { ascending: true })
        .range(from, from + BATCH - 1);
      const rows = data || [];
      all = all.concat(rows);
      more = rows.length === BATCH;
      from += BATCH;
    }
    return all;
  }

  // ───── Fetch watchlist ─────
  async function fetchWatchlist() {
    const { data } = await supabaseClient
      .from('watchlist')
      .select('*')
      .order('added_at', { ascending: false });
    const items = data || [];
    queueItems = items.filter(i => i.status === 'queued');
    watchedItems = items.filter(i => i.status === 'watched').slice(0, 10);
  }

  // ───── Render ─────
  function render() {
    const grid = document.getElementById('queue-grid');
    const empty = document.getElementById('empty-state');
    const loading = document.getElementById('loading');
    const countEl = document.getElementById('queue-count');
    const watchedSection = document.getElementById('watched-section');
    const watchedList = document.getElementById('watched-list');

    loading.style.display = 'none';
    grid.innerHTML = '';

    // Apply filter
    const filtered = activeFilter === 'all'
      ? queueItems
      : queueItems.filter(i => (i.assigned_to || 'both') === activeFilter);

    // Queue count
    countEl.textContent = queueItems.length === 0
      ? 'Queue empty'
      : filtered.length + ' of ' + queueItems.length + ' film' + (queueItems.length !== 1 ? 's' : '');

    // Update filter chip counts
    document.querySelectorAll('.filter-chip').forEach(chip => {
      chip.classList.toggle('active', chip.dataset.filter === activeFilter);
    });

    if (filtered.length === 0) {
      empty.style.display = '';
      grid.style.display = 'none';
    } else {
      empty.style.display = 'none';
      grid.style.display = '';

      filtered.forEach((item, idx) => {
        const card = document.createElement('div');
        card.className = 'queue-card';
        card.style.animationDelay = (idx * 0.04) + 's';

        // Poster
        const poster = document.createElement('div');
        poster.className = 'queue-poster';

        if (item.poster_url) {
          const img = document.createElement('img');
          img.src = item.poster_url;
          img.alt = item.title;
          img.loading = 'lazy';
          img.onerror = function() {
            this.style.display = 'none';
            const fb = document.createElement('div');
            fb.className = 'queue-poster-fallback';
            fb.innerHTML = '<span>' + escHtml(item.title) + '</span>';
            poster.appendChild(fb);
          };
          poster.appendChild(img);
        } else {
          const fb = document.createElement('div');
          fb.className = 'queue-poster-fallback';
          fb.innerHTML = '<span>' + escHtml(item.title) + '</span>';
          poster.appendChild(fb);
        }

        // Assigned-to badge
        const assignedTo = item.assigned_to || 'both';
        const badge = document.createElement('div');
        badge.className = 'assigned-badge ' + assignedTo;
        badge.textContent = assignedTo === 'both' ? 'Must Watch' : 'For ' + assignedTo;
        poster.appendChild(badge);

        // Remove button (logged-in users only)
        if (canAct()) {
          const rm = document.createElement('button');
          rm.className = 'queue-remove';
          rm.innerHTML = '&times;';
          rm.title = 'Remove from queue';
          rm.onclick = (e) => { e.stopPropagation(); removeFromQueue(item.movie_key, item.title); };
          poster.appendChild(rm);
        }

        card.appendChild(poster);

        // Info
        const info = document.createElement('div');
        info.className = 'queue-info';

        const title = document.createElement('div');
        title.className = 'queue-title';
        title.textContent = item.title;
        info.appendChild(title);

        if (item.note) {
          const note = document.createElement('div');
          note.className = 'queue-note';
          note.textContent = '"' + item.note + '"';
          info.appendChild(note);
        }

        const suggested = document.createElement('div');
        suggested.className = 'suggested-tag';
        suggested.textContent = 'Added by ' + (item.suggested_by || 'admin') + ' \u2022 ' + formatDate(item.added_at);
        info.appendChild(suggested);

        card.appendChild(info);

        // Click to open on Letterboxd
        card.style.cursor = 'pointer';
        card.onclick = () => {
          if (item.letterboxd_url) window.open(item.letterboxd_url, '_blank');
        };

        grid.appendChild(card);
      });
    }

    // Recently watched
    if (watchedItems.length > 0) {
      watchedSection.style.display = '';
      watchedList.innerHTML = '';
      watchedItems.forEach(item => {
        const row = document.createElement('div');
        row.className = 'watched-item';
        row.innerHTML =
          '<span class="watched-item-check">&#10003;</span>' +
          '<span class="watched-item-title">' + escHtml(item.title) + '</span>' +
          '<span class="watched-item-date">' + (item.watched_at ? formatDate(item.watched_at) : '') + '</span>';
        watchedList.appendChild(row);
      });
    } else {
      watchedSection.style.display = 'none';
    }
  }

  // ───── Search ─────
  const searchInput = document.getElementById('film-search');
  const searchResults = document.getElementById('search-results');
  let searchTimeout = null;

  searchInput.addEventListener('input', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(doSearch, 200);
  });

  searchInput.addEventListener('focus', () => {
    if (searchInput.value.trim().length >= 2) doSearch();
  });

  document.addEventListener('click', (e) => {
    if (!e.target.closest('.search-row')) {
      searchResults.classList.remove('visible');
    }
  });

  function doSearch() {
    const q = searchInput.value.trim().toLowerCase();
    if (q.length < 2) { searchResults.classList.remove('visible'); return; }

    const queueKeys = new Set(queueItems.map(i => i.movie_key));
    const matches = allGregFilms
      .filter(f => f.title.toLowerCase().includes(q))
      .slice(0, 15);

    if (matches.length === 0) {
      searchResults.innerHTML = '<div class="search-no-results">No films found for "' + escHtml(q) + '"</div>';
      searchResults.classList.add('visible');
      return;
    }

    searchResults.innerHTML = '';
    matches.forEach(film => {
      const inQueue = queueKeys.has(film.movie_key);
      const row = document.createElement('div');
      row.className = 'search-result' + (inQueue ? ' in-queue' : '');

      // Poster thumbnail
      if (film.poster_url) {
        const img = document.createElement('img');
        img.className = 'search-result-poster';
        img.src = film.poster_url;
        img.alt = '';
        img.loading = 'lazy';
        row.appendChild(img);
      } else {
        const ph = document.createElement('div');
        ph.className = 'search-result-poster';
        ph.style.background = 'var(--border)';
        row.appendChild(ph);
      }

      // Info
      const info = document.createElement('div');
      info.className = 'search-result-info';
      const t = document.createElement('div');
      t.className = 'search-result-title';
      t.textContent = film.title;
      info.appendChild(t);

      if (film.greg_rating) {
        const meta = document.createElement('div');
        meta.className = 'search-result-meta';
        meta.textContent = 'Greg: ' + '\u2605'.repeat(film.greg_rating);
        info.appendChild(meta);
      }

      row.appendChild(info);

      // Add buttons — assign to Greg, Peer, or Both
      const actions = document.createElement('div');
      actions.className = 'search-result-actions';
      if (inQueue) {
        const tag = document.createElement('span');
        tag.className = 'search-result-add';
        tag.textContent = 'In Queue';
        tag.style.cursor = 'default';
        tag.style.color = 'var(--text-muted)';
        tag.style.borderColor = 'var(--border)';
        actions.appendChild(tag);
      } else {
        [['greg', 'G'], ['peer', 'P'], ['both', 'Both']].forEach(([who, label]) => {
          const btn = document.createElement('button');
          btn.className = 'search-result-add ' + (who === 'both' ? '' : who);
          btn.textContent = '+ ' + label;
          btn.title = who === 'both' ? 'Must watch for both' : 'For ' + who;
          btn.onclick = (e) => { e.stopPropagation(); addToQueue(film, who); };
          actions.appendChild(btn);
        });
      }
      row.appendChild(actions);

      searchResults.appendChild(row);
    });

    searchResults.classList.add('visible');
  }

  // ───── Actions ─────
  async function addToQueue(film, assignedTo) {
    try {
      const res = await fetch(ACTIONS_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + authToken,
        },
        body: JSON.stringify({
          action: 'watchlist_add',
          movieKey: film.movie_key,
          data: {
            title: film.title,
            posterUrl: film.poster_url || null,
            note: null,
            assignedTo: assignedTo || 'both',
          }
        })
      });
      if (!res.ok) throw new Error('Failed');
      const label = assignedTo === 'both' ? 'Must Watch' : 'for ' + assignedTo;
      showToast('Added "' + film.title + '" \u2014 ' + label);
      searchInput.value = '';
      searchResults.classList.remove('visible');
      await fetchWatchlist();
      render();
    } catch (e) {
      showToast('Error adding film');
    }
  }

  async function removeFromQueue(movieKey, title) {
    try {
      const res = await fetch(ACTIONS_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + authToken,
        },
        body: JSON.stringify({ action: 'watchlist_remove', movieKey, data: {} })
      });
      if (!res.ok) throw new Error('Failed');
      showToast('Removed "' + title + '"');
      await fetchWatchlist();
      render();
    } catch (e) {
      showToast('Error removing film');
    }
  }

  // ───── Realtime ─────
  function subscribeRealtime() {
    supabaseClient
      .channel('watchlist-changes')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'watchlist' }, async () => {
        await fetchWatchlist();
        render();
      })
      .subscribe();
  }

  // ───── Helpers ─────
  function escHtml(str) {
    const d = document.createElement('div');
    d.textContent = str || '';
    return d.innerHTML;
  }

  function formatDate(iso) {
    if (!iso) return '';
    const d = new Date(iso);
    const now = new Date();
    const diff = now - d;
    if (diff < 60000) return 'just now';
    if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
    if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
    if (diff < 604800000) return Math.floor(diff / 86400000) + 'd ago';
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  }

  // ───── Filter clicks ─────
  document.querySelectorAll('.filter-chip').forEach(chip => {
    chip.addEventListener('click', () => {
      activeFilter = chip.dataset.filter;
      render();
    });
  });

  // ───── Init ─────
  async function init() {
    loadSession();

    // Show/hide UI based on login
    if (canAct()) {
      document.getElementById('add-section').classList.remove('hidden');
      document.getElementById('login-prompt').style.display = 'none';
    }

    // Load data
    const [_, __] = await Promise.all([
      fetchGregFilms().then(f => allGregFilms = f),
      fetchWatchlist()
    ]);

    render();
    subscribeRealtime();
  }

  init();
</script>

</body>
</html>
