<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DUFIVE | Suggestions</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:ital,wght@0,600;0,700;1,600&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root, [data-theme="light"] {
      --bg: #fafafa; --bg-secondary: #f5f5f5; --card-bg: #ffffff;
      --text: #0a0a0a; --text-secondary: #737373; --text-muted: #a3a3a3;
      --accent: #2563eb; --accent-hover: #1d4ed8;
      --border: #e5e5e5; --border-light: #f5f5f5;
      --greg: #ea580c; --greg-bg: rgba(234, 88, 12, 0.08);
      --peer: #2563eb; --peer-bg: rgba(37, 99, 235, 0.08);
      --shadow: 0 1px 3px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.02);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.06), 0 4px 6px -2px rgba(0,0,0,0.03);
      --radius: 8px; --transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      --overlay-bg: rgba(0,0,0,0.6);
      --success: #16a34a;
      --priority-high: #ef4444;
      --priority-high-glow: rgba(239, 68, 68, 0.15);
    }
    [data-theme="dark"] {
      --bg: #0a0a0a; --bg-secondary: #171717; --card-bg: #1c1c1e;
      --text: #f5f5f5; --text-secondary: #a3a3a3; --text-muted: #6b7280;
      --accent: #3b82f6; --accent-hover: #60a5fa;
      --border: #2d2d2d; --border-light: #1f1f1f;
      --greg: #fb923c; --greg-bg: rgba(251, 146, 60, 0.1);
      --peer: #60a5fa; --peer-bg: rgba(96, 165, 250, 0.1);
      --shadow: 0 1px 3px rgba(0,0,0,0.3); --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.4);
      --overlay-bg: rgba(0,0,0,0.75);
      --success: #22c55e;
      --priority-high: #f87171;
      --priority-high-glow: rgba(248, 113, 113, 0.2);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg); color: var(--text);
      line-height: 1.5; -webkit-font-smoothing: antialiased;
    }
    .container { max-width: 860px; margin: 0 auto; padding: 0 24px 60px; }

    /* ───── Nav ───── */
    nav {
      display: flex; justify-content: space-between; align-items: center;
      padding: 24px 0; margin-bottom: 32px;
      border-bottom: 1px solid var(--border);
    }
    .brand {
      font-family: 'Playfair Display', serif; font-size: 1.25rem; font-weight: 700;
      color: var(--text); text-decoration: none; letter-spacing: -0.02em;
    }
    .nav-controls { display: flex; gap: 8px; align-items: center; }
    .hamburger {
      display: none; background: none; border: 1px solid var(--border);
      border-radius: 6px; padding: 6px 8px; cursor: pointer;
      font-size: 1.2rem; line-height: 1; color: var(--text);
      transition: var(--transition);
    }
    .hamburger:hover { background: var(--border-light); }
    .nav-link {
      font-size: 0.8rem; font-weight: 600; color: var(--text-secondary);
      text-decoration: none; padding: 6px 12px; border-radius: 6px; transition: var(--transition);
    }
    .nav-link:hover { color: var(--accent); background: var(--border-light); }
    .nav-link.active { color: var(--accent); }
    .theme-toggle {
      width: 34px; height: 34px; border-radius: 50%; border: 1px solid var(--border);
      background: var(--card-bg); cursor: pointer; font-size: 1rem; transition: var(--transition);
      display: flex; align-items: center; justify-content: center; color: var(--text);
    }
    .theme-toggle:hover { background: var(--border-light); border-color: var(--accent); }

    /* ───── Header ───── */
    header { text-align: center; margin-bottom: 32px; }
    .page-title {
      font-family: 'Playfair Display', serif; font-size: clamp(1.6rem, 4vw, 2.4rem);
      font-weight: 700; letter-spacing: -0.03em; margin-bottom: 6px;
    }
    .tagline { font-size: 0.9rem; color: var(--text-muted); }
    .queue-count {
      display: inline-block; font-size: 0.8rem; font-weight: 700; color: var(--accent);
      background: var(--border-light); border: 1px solid var(--border);
      padding: 4px 12px; border-radius: 20px; margin-top: 10px;
    }

    /* ───── Add Film Section (always visible) ───── */
    .add-section {
      margin-bottom: 32px; padding: 20px; background: var(--card-bg);
      border: 1px solid var(--border); border-radius: 12px; box-shadow: var(--shadow);
    }
    .add-label {
      font-size: 0.75rem; font-weight: 600; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 10px;
    }
    .search-row { display: flex; gap: 8px; position: relative; }
    .search-input {
      flex: 1; padding: 10px 14px; font-size: 0.9rem; font-family: inherit;
      border: 1px solid var(--border); border-radius: 8px; background: var(--bg);
      color: var(--text); outline: none; transition: var(--transition);
    }
    .search-input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(37,99,235,0.1); }
    .search-input::placeholder { color: var(--text-muted); }

    /* Search results dropdown */
    .search-results {
      position: absolute; top: 100%; left: 0; right: 0; z-index: 50;
      margin-top: 4px; background: var(--card-bg); border: 1px solid var(--border);
      border-radius: 10px; box-shadow: var(--shadow-lg); max-height: 320px;
      overflow-y: auto; display: none;
    }
    .search-results.visible { display: block; }
    .search-result {
      display: flex; align-items: center; gap: 12px; padding: 10px 14px;
      cursor: pointer; transition: var(--transition); border-bottom: 1px solid var(--border-light);
    }
    .search-result:last-child { border-bottom: none; }
    .search-result:hover { background: var(--border-light); }
    .search-result-poster {
      width: 36px; height: 54px; border-radius: 4px; object-fit: cover;
      background: var(--border-light); flex-shrink: 0;
    }
    .search-result-info { flex: 1; min-width: 0; }
    .search-result-title {
      font-size: 0.85rem; font-weight: 600; color: var(--text);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .search-result-meta { font-size: 0.7rem; color: var(--text-muted); }
    .search-result-actions { display: flex; gap: 4px; flex-shrink: 0; }
    .search-result-add {
      font-size: 0.65rem; font-weight: 700; color: var(--accent);
      background: none; border: 1px solid var(--accent); border-radius: 6px;
      padding: 4px 8px; cursor: pointer; transition: var(--transition); white-space: nowrap;
    }
    .search-result-add:hover { background: var(--accent); color: #fff; }
    .search-result-add.greg { color: var(--greg); border-color: var(--greg); }
    .search-result-add.greg:hover { background: var(--greg); color: #fff; }
    .search-result-add.peer { color: var(--peer); border-color: var(--peer); }
    .search-result-add.peer:hover { background: var(--peer); color: #fff; }
    .search-result.in-queue .search-result-add {
      color: var(--text-muted); border-color: var(--border); cursor: default;
    }
    .search-no-results {
      padding: 16px; text-align: center; font-size: 0.85rem; color: var(--text-muted);
    }
    .search-divider {
      padding: 8px 14px; font-size: 0.7rem; font-weight: 600; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.06em; background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-light);
    }
    .search-external-btn {
      display: block; width: 100%; padding: 12px; text-align: center;
      font-size: 0.8rem; font-weight: 600; color: var(--accent); cursor: pointer;
      background: none; border: none; border-top: 1px solid var(--border-light);
      transition: var(--transition); font-family: inherit;
    }
    .search-external-btn:hover { background: var(--border-light); }
    .search-loading {
      padding: 12px; text-align: center; font-size: 0.8rem; color: var(--text-muted);
    }

    /* ───── Filter chips ───── */
    .filters {
      display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; margin-bottom: 24px;
    }
    .filter-chip {
      font-size: 0.75rem; font-weight: 600; padding: 6px 14px; border-radius: 20px;
      border: 1px solid var(--border); background: var(--card-bg); color: var(--text-secondary);
      cursor: pointer; transition: var(--transition); user-select: none;
    }
    .filter-chip:hover { border-color: var(--accent); color: var(--accent); }
    .filter-chip.active { background: var(--accent); color: #fff; border-color: var(--accent); }

    /* ───── Queue Grid ───── */
    .queue-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 16px;
    }
    @media (max-width: 480px) {
      .queue-grid { grid-template-columns: repeat(3, 1fr); gap: 10px; }
    }

    .queue-card {
      background: var(--card-bg); border: 1px solid var(--border); border-radius: 10px;
      overflow: hidden; box-shadow: var(--shadow); transition: var(--transition);
      animation: fadeUp 0.3s ease forwards; opacity: 0;
      position: relative;
    }
    .queue-card:hover { box-shadow: var(--shadow-lg); transform: translateY(-2px); }

    /* Priority: colored left border + glow */
    .queue-card.priority-high {
      border-left: 4px solid var(--priority-high);
      box-shadow: var(--shadow), -2px 0 8px var(--priority-high-glow);
    }
    .queue-card.priority-high:hover {
      box-shadow: var(--shadow-lg), -2px 0 12px var(--priority-high-glow);
    }
    .queue-card.priority-low {
      border-left: 3px solid var(--border);
      opacity: 0.75;
    }
    .queue-card.priority-low:hover { opacity: 1; }

    .queue-poster {
      aspect-ratio: 2/3; background: var(--border-light); overflow: hidden;
      position: relative;
    }
    .queue-poster img {
      width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease;
    }
    .queue-card:hover .queue-poster img { transform: scale(1.04); }
    .queue-poster-fallback {
      width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;
      padding: 12px; text-align: center;
      background: linear-gradient(135deg, var(--border-light) 0%, var(--border) 100%);
    }
    .queue-poster-fallback span {
      font-family: 'Playfair Display', serif; font-size: 0.85rem; font-weight: 700;
      color: var(--text-muted); line-height: 1.2;
    }

    /* Remove button on poster hover */
    .queue-remove {
      position: absolute; top: 6px; right: 6px; width: 22px; height: 22px;
      border-radius: 50%; background: rgba(0,0,0,0.6); color: #fff; border: none;
      font-size: 0.75rem; cursor: pointer; display: none; align-items: center;
      justify-content: center; transition: var(--transition); backdrop-filter: blur(4px);
      z-index: 4;
    }
    .queue-card:hover .queue-remove { display: flex; }
    .queue-remove:hover { background: #ef4444; }

    /* Info area below poster */
    .queue-info { padding: 8px 10px 10px; }
    .queue-title {
      font-size: 0.78rem; font-weight: 600; color: var(--text); line-height: 1.3;
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* Tags row (assignment + priority) */
    .card-tags { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 4px; }
    .card-tag {
      font-size: 0.58rem; font-weight: 700; padding: 1px 6px; border-radius: 3px;
      text-transform: uppercase; letter-spacing: 0.03em; line-height: 1.5;
    }
    .card-tag.greg { color: var(--greg); background: var(--greg-bg); }
    .card-tag.peer { color: var(--peer); background: var(--peer-bg); }
    .card-tag.both { color: var(--text-muted); background: var(--border-light); }
    .card-tag.high { color: var(--priority-high); background: rgba(239,68,68,0.08); }
    .card-tag.low { color: var(--text-muted); background: var(--border-light); }

    .suggested-tag {
      font-size: 0.6rem; color: var(--text-muted); margin-top: 2px;
    }
    .queue-note {
      font-size: 0.68rem; color: var(--text-muted); margin-top: 3px; font-style: italic;
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* Reviewer controls (priority dropdown + assignment) */
    .reviewer-controls {
      display: flex; gap: 4px; margin-top: 5px; align-items: center;
    }
    .reviewer-controls select {
      font-size: 0.6rem; font-family: inherit; padding: 2px 4px;
      border: 1px solid var(--border); border-radius: 4px;
      background: var(--bg); color: var(--text); cursor: pointer;
      outline: none; transition: var(--transition);
    }
    .reviewer-controls select:focus { border-color: var(--accent); }

    /* ───── Empty State ───── */
    .empty-state {
      text-align: center; padding: 60px 20px; color: var(--text-muted);
    }
    .empty-icon { font-size: 3rem; margin-bottom: 12px; }
    .empty-title {
      font-family: 'Playfair Display', serif; font-size: 1.3rem; font-weight: 700;
      color: var(--text-secondary); margin-bottom: 6px;
    }
    .empty-text { font-size: 0.85rem; max-width: 300px; margin: 0 auto; }

    /* ───── Recently Watched (cleared from queue) ───── */
    .watched-section { margin-top: 48px; }
    .watched-header {
      font-size: 0.75rem; font-weight: 600; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 12px;
      padding-bottom: 8px; border-bottom: 1px solid var(--border-light);
    }
    .watched-list { display: flex; flex-direction: column; gap: 8px; }
    .watched-item {
      display: flex; align-items: center; gap: 10px; padding: 8px 12px;
      background: var(--bg-secondary); border-radius: 8px; font-size: 0.8rem;
      color: var(--text-secondary); opacity: 0.7;
    }
    .watched-item-check { color: var(--success); font-size: 0.9rem; }
    .watched-item-title { flex: 1; }
    .watched-item-date { font-size: 0.7rem; color: var(--text-muted); }

    /* ───── Toast ───── */
    .toast {
      position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(100px);
      background: var(--card-bg); border: 1px solid var(--border); color: var(--text);
      padding: 10px 20px; border-radius: 10px; font-size: 0.85rem; font-weight: 500;
      box-shadow: var(--shadow-lg); z-index: 999; transition: transform 0.3s ease;
      pointer-events: none;
    }
    .toast.show { transform: translateX(-50%) translateY(0); }

    /* ───── Footer ───── */
    .footer {
      text-align: center; padding: 32px 0; margin-top: 40px;
      border-top: 1px solid var(--border-light); font-size: 0.7rem; color: var(--text-muted);
    }

    @keyframes fadeUp {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ───── Loading ───── */
    .loading {
      text-align: center; padding: 40px; color: var(--text-muted); font-size: 0.9rem;
    }

    /* ───── Responsive: Mobile ───── */
    @media (max-width: 600px) {
      .container { padding: 0 16px 40px; }

      nav {
        flex-direction: row; justify-content: space-between; align-items: center;
        padding: 16px 0; margin-bottom: 24px; position: relative;
      }
      .hamburger { display: block; }
      .nav-controls {
        display: none; position: absolute; top: 100%; left: 0; right: 0;
        flex-direction: column; align-items: stretch;
        background: var(--card-bg); border: 1px solid var(--border);
        border-radius: 10px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        padding: 8px; gap: 2px; z-index: 100;
      }
      .nav-controls.open { display: flex; }
      .nav-controls .nav-link { padding: 10px 14px; font-size: 0.9rem; border-radius: 8px; }
      .nav-controls .theme-toggle {
        width: 100%; border-radius: 8px; justify-content: flex-start;
        padding: 10px 14px; gap: 8px; font-size: 0.9rem; border: none;
      }

      /* Bigger dropdowns on mobile for easier tapping */
      .reviewer-controls { gap: 6px; }
      .reviewer-controls select {
        font-size: 0.72rem; padding: 4px 6px; min-height: 28px;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <nav>
    <a href="/" class="brand">DUFIVE</a>
    <button class="hamburger" id="hamburger" aria-label="Menu">&#9776;</button>
    <div class="nav-controls" id="nav-controls">
      <a href="/" class="nav-link">Ledger</a>
      <a href="disagreements.html" class="nav-link">Debates</a>
      <a href="watchlist.html" class="nav-link active">Suggestions</a>
      <button id="theme-toggle" class="theme-toggle" title="Toggle dark mode">
        <span id="theme-icon">&#9790;</span>
      </button>
    </div>
  </nav>

  <header>
    <h1 class="page-title">Suggestions</h1>
    <p class="tagline">Suggest a film. Anyone can add one.</p>
    <div class="queue-count" id="queue-count"></div>
  </header>

  <!-- Add film search — always visible, anyone can suggest -->
  <div class="add-section" id="add-section">
    <div class="add-label">Suggest a film</div>
    <div class="search-row">
      <input type="text" class="search-input" id="film-search" placeholder="Search for a film..." autocomplete="off" />
      <div class="search-results" id="search-results"></div>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters" id="filters">
    <div class="filter-chip active" data-filter="all">All</div>
    <div class="filter-chip" data-filter="high">High Priority</div>
    <div class="filter-chip" data-filter="greg">For Greg</div>
    <div class="filter-chip" data-filter="peer">For Peer</div>
  </div>

  <!-- Queue grid -->
  <div id="queue-area">
    <div class="loading" id="loading">Loading suggestions...</div>
    <div class="queue-grid" id="queue-grid"></div>
    <div class="empty-state" id="empty-state" style="display:none">
      <div class="empty-icon">&#127910;</div>
      <div class="empty-title">No suggestions yet</div>
      <div class="empty-text">Search for a film above and suggest it. Anyone can add one.</div>
    </div>
  </div>

  <!-- Recently watched (auto-completed) -->
  <div class="watched-section" id="watched-section" style="display:none">
    <div class="watched-header">Recently cleared</div>
    <div class="watched-list" id="watched-list"></div>
  </div>

  <div class="footer">
    DUFIVE &mdash; The Ledger
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  // ───── Config ─────
  const SB_URL = 'https://brgxorrpfberfcyeugzq.supabase.co';
  const SB_KEY = 'sb_publishable_VbVFBh-gtIBAbr9Qtp240w_GS8Kn4Jf';
  const ACTIONS_URL = 'https://brgxorrpfberfcyeugzq.supabase.co/functions/v1/bright-function';
  const SEARCH_URL = 'https://brgxorrpfberfcyeugzq.supabase.co/functions/v1/search-films';
  const supabaseClient = window.supabase.createClient(SB_URL, SB_KEY);

  let currentUser = null;
  let authToken = null;
  let allGregFilms = [];
  let queueItems = [];
  let watchedItems = [];
  let activeFilter = 'all';

  // ───── Auth (shared with main page via localStorage) ─────
  function loadSession() {
    const reviewer = localStorage.getItem('reviewer');
    const token = localStorage.getItem('session_token');
    if (reviewer && token) {
      currentUser = reviewer;
      authToken = token;
    }
  }

  function isAdmin() { return currentUser === 'admin'; }
  function canAct() { return !!currentUser; }

  // ───── Theme ─────
  const savedTheme = localStorage.getItem('dufive-theme') || 'light';
  document.documentElement.setAttribute('data-theme', savedTheme);
  document.getElementById('theme-icon').textContent = savedTheme === 'dark' ? '\u2600' : '\u263E';
  // Hamburger toggle
  document.getElementById('hamburger').addEventListener('click', (e) => {
    e.stopPropagation();
    document.getElementById('nav-controls').classList.toggle('open');
  });
  document.addEventListener('click', (e) => {
    if (!e.target.closest('nav')) document.getElementById('nav-controls').classList.remove('open');
  });

  document.getElementById('theme-toggle').addEventListener('click', () => {
    const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('dufive-theme', next);
    document.getElementById('theme-icon').textContent = next === 'dark' ? '\u2600' : '\u263E';
  });

  // ───── Toast ─────
  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2500);
  }

  // ───── Fetch all Greg films for search ─────
  async function fetchGregFilms() {
    const BATCH = 1000;
    let all = [], from = 0, more = true;
    while (more) {
      const { data } = await supabaseClient
        .from('greg_films')
        .select('movie_key, title, poster_url, letterboxd_url')
        .order('title', { ascending: true })
        .range(from, from + BATCH - 1);
      const rows = data || [];
      all = all.concat(rows);
      more = rows.length === BATCH;
      from += BATCH;
    }
    return all;
  }

  // ───── Fetch watchlist ─────
  async function fetchWatchlist() {
    const { data } = await supabaseClient
      .from('watchlist')
      .select('*')
      .order('added_at', { ascending: false });
    const items = data || [];
    queueItems = items.filter(i => i.status === 'queued');
    watchedItems = items.filter(i => i.status === 'watched').slice(0, 10);
  }

  // ───── Render ─────
  function render() {
    const grid = document.getElementById('queue-grid');
    const empty = document.getElementById('empty-state');
    const loading = document.getElementById('loading');
    const countEl = document.getElementById('queue-count');
    const watchedSection = document.getElementById('watched-section');
    const watchedList = document.getElementById('watched-list');

    loading.style.display = 'none';
    grid.innerHTML = '';

    // Apply filter
    let filtered;
    if (activeFilter === 'all') {
      filtered = [...queueItems];
    } else if (activeFilter === 'high') {
      filtered = queueItems.filter(i => (i.priority || 'medium') === 'high');
    } else {
      filtered = queueItems.filter(i => (i.assigned_to || '') === activeFilter);
    }

    // Sort: high priority first, then medium, then low; within each tier newest first
    const priorityOrder = { high: 0, medium: 1, low: 2 };
    filtered.sort((a, b) => {
      const pa = priorityOrder[a.priority || 'medium'] ?? 1;
      const pb = priorityOrder[b.priority || 'medium'] ?? 1;
      if (pa !== pb) return pa - pb;
      return new Date(b.added_at) - new Date(a.added_at);
    });

    // Count
    countEl.textContent = queueItems.length === 0
      ? 'No suggestions yet'
      : filtered.length + ' of ' + queueItems.length + ' film' + (queueItems.length !== 1 ? 's' : '');

    // Update active chip
    document.querySelectorAll('.filter-chip').forEach(chip => {
      chip.classList.toggle('active', chip.dataset.filter === activeFilter);
    });

    if (filtered.length === 0) {
      empty.style.display = '';
      grid.style.display = 'none';
    } else {
      empty.style.display = 'none';
      grid.style.display = '';

      filtered.forEach((item, idx) => {
        const card = document.createElement('div');
        card.className = 'queue-card';
        card.style.animationDelay = (idx * 0.04) + 's';

        // Apply priority border class
        const priority = item.priority || 'medium';
        if (priority === 'high') card.classList.add('priority-high');
        if (priority === 'low') card.classList.add('priority-low');

        // Poster
        const poster = document.createElement('div');
        poster.className = 'queue-poster';

        if (item.poster_url) {
          const img = document.createElement('img');
          img.src = item.poster_url;
          img.alt = item.title;
          img.loading = 'lazy';
          img.onerror = function() {
            this.style.display = 'none';
            const fb = document.createElement('div');
            fb.className = 'queue-poster-fallback';
            fb.innerHTML = '<span>' + escHtml(item.title) + '</span>';
            poster.appendChild(fb);
          };
          poster.appendChild(img);
        } else {
          const fb = document.createElement('div');
          fb.className = 'queue-poster-fallback';
          fb.innerHTML = '<span>' + escHtml(item.title) + '</span>';
          poster.appendChild(fb);
        }

        // Remove button (logged-in users only)
        if (canAct()) {
          const rm = document.createElement('button');
          rm.className = 'queue-remove';
          rm.innerHTML = '&times;';
          rm.title = 'Remove';
          rm.onclick = (e) => { e.stopPropagation(); removeFromQueue(item.movie_key, item.title); };
          poster.appendChild(rm);
        }

        card.appendChild(poster);

        // Info area
        const info = document.createElement('div');
        info.className = 'queue-info';

        const title = document.createElement('div');
        title.className = 'queue-title';
        title.textContent = item.title;
        info.appendChild(title);

        // Tags: assignment + priority (text below title, not on poster)
        const tags = document.createElement('div');
        tags.className = 'card-tags';

        const assignedTo = item.assigned_to;
        if (assignedTo === 'greg') {
          const t = document.createElement('span');
          t.className = 'card-tag greg';
          t.textContent = 'For Greg';
          tags.appendChild(t);
        } else if (assignedTo === 'peer') {
          const t = document.createElement('span');
          t.className = 'card-tag peer';
          t.textContent = 'For Peer';
          tags.appendChild(t);
        } else if (assignedTo === 'both') {
          const t = document.createElement('span');
          t.className = 'card-tag both';
          t.textContent = 'For Both';
          tags.appendChild(t);
        }

        if (priority === 'high') {
          const t = document.createElement('span');
          t.className = 'card-tag high';
          t.textContent = 'High';
          tags.appendChild(t);
        } else if (priority === 'low') {
          const t = document.createElement('span');
          t.className = 'card-tag low';
          t.textContent = 'Low';
          tags.appendChild(t);
        }

        if (tags.childElementCount > 0) info.appendChild(tags);

        // Note
        if (item.note) {
          const note = document.createElement('div');
          note.className = 'queue-note';
          note.textContent = '"' + item.note + '"';
          info.appendChild(note);
        }

        // Suggested by
        const suggested = document.createElement('div');
        suggested.className = 'suggested-tag';
        suggested.textContent = (item.suggested_by || 'visitor') + ' \u2022 ' + formatDate(item.added_at);
        info.appendChild(suggested);

        // Reviewer power tools: priority + assignment dropdowns
        if (canAct()) {
          const controls = document.createElement('div');
          controls.className = 'reviewer-controls';

          // Priority dropdown
          const priSel = document.createElement('select');
          priSel.title = 'Set priority';
          ['high', 'medium', 'low'].forEach(v => {
            const opt = document.createElement('option');
            opt.value = v;
            opt.textContent = v === 'high' ? 'High' : v === 'low' ? 'Low' : 'Normal';
            if (v === priority) opt.selected = true;
            priSel.appendChild(opt);
          });
          priSel.onchange = (e) => {
            e.stopPropagation();
            updateItem(item.movie_key, { priority: priSel.value });
          };
          priSel.onclick = (e) => e.stopPropagation();
          controls.appendChild(priSel);

          // Assignment dropdown
          const asnSel = document.createElement('select');
          asnSel.title = 'Assign to';
          [['', 'Unassigned'], ['greg', 'Greg'], ['peer', 'Peer'], ['both', 'Both']].forEach(([v, label]) => {
            const opt = document.createElement('option');
            opt.value = v;
            opt.textContent = label;
            if (v === (assignedTo || '')) opt.selected = true;
            asnSel.appendChild(opt);
          });
          asnSel.onchange = (e) => {
            e.stopPropagation();
            updateItem(item.movie_key, { assignedTo: asnSel.value || null });
          };
          asnSel.onclick = (e) => e.stopPropagation();
          controls.appendChild(asnSel);

          info.appendChild(controls);
        }

        card.appendChild(info);

        // Click to open on Letterboxd
        card.style.cursor = 'pointer';
        card.onclick = () => {
          if (item.letterboxd_url) window.open(item.letterboxd_url, '_blank');
        };

        grid.appendChild(card);
      });
    }

    // Recently watched
    if (watchedItems.length > 0) {
      watchedSection.style.display = '';
      watchedList.innerHTML = '';
      watchedItems.forEach(item => {
        const row = document.createElement('div');
        row.className = 'watched-item';
        row.innerHTML =
          '<span class="watched-item-check">&#10003;</span>' +
          '<span class="watched-item-title">' + escHtml(item.title) + '</span>' +
          '<span class="watched-item-date">' + (item.watched_at ? formatDate(item.watched_at) : '') + '</span>';
        watchedList.appendChild(row);
      });
    } else {
      watchedSection.style.display = 'none';
    }
  }

  // ───── Search ─────
  const searchInput = document.getElementById('film-search');
  const searchResults = document.getElementById('search-results');
  let searchTimeout = null;

  searchInput.addEventListener('input', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(doSearch, 200);
  });

  searchInput.addEventListener('focus', () => {
    if (searchInput.value.trim().length >= 2) doSearch();
  });

  document.addEventListener('click', (e) => {
    if (!e.target.closest('.search-row')) {
      searchResults.classList.remove('visible');
    }
  });

  function buildResultRow(film, queueKeys) {
    const inQueue = queueKeys.has(film.movie_key);
    const row = document.createElement('div');
    row.className = 'search-result' + (inQueue ? ' in-queue' : '');

    // Poster thumbnail
    if (film.poster_url) {
      const img = document.createElement('img');
      img.className = 'search-result-poster';
      img.src = film.poster_url;
      img.alt = '';
      img.loading = 'lazy';
      row.appendChild(img);
    } else {
      const ph = document.createElement('div');
      ph.className = 'search-result-poster';
      ph.style.background = 'var(--border)';
      row.appendChild(ph);
    }

    // Info
    const info = document.createElement('div');
    info.className = 'search-result-info';
    const t = document.createElement('div');
    t.className = 'search-result-title';
    t.textContent = film.title + (film.year ? ' (' + film.year + ')' : '');
    info.appendChild(t);

    if (film.source) {
      const meta = document.createElement('div');
      meta.className = 'search-result-meta';
      meta.textContent = film.source;
      info.appendChild(meta);
    }

    row.appendChild(info);

    // Add buttons
    const actions = document.createElement('div');
    actions.className = 'search-result-actions';
    if (inQueue) {
      const tag = document.createElement('span');
      tag.className = 'search-result-add';
      tag.textContent = 'Added';
      tag.style.cursor = 'default';
      tag.style.color = 'var(--text-muted)';
      tag.style.borderColor = 'var(--border)';
      actions.appendChild(tag);
    } else if (canAct()) {
      // Logged-in users: G / P / Both assignment buttons
      [['greg', 'G'], ['peer', 'P'], ['both', 'Both']].forEach(([who, label]) => {
        const btn = document.createElement('button');
        btn.className = 'search-result-add ' + (who === 'both' ? '' : who);
        btn.textContent = '+ ' + label;
        btn.title = who === 'both' ? 'For both' : 'For ' + who;
        btn.onclick = (e) => { e.stopPropagation(); addToQueue(film, who); };
        actions.appendChild(btn);
      });
    } else {
      // Visitors: single "+ Suggest" button (no assignment)
      const btn = document.createElement('button');
      btn.className = 'search-result-add';
      btn.textContent = '+ Suggest';
      btn.onclick = (e) => { e.stopPropagation(); addToQueue(film, null); };
      actions.appendChild(btn);
    }
    row.appendChild(actions);
    return row;
  }

  function doSearch() {
    const q = searchInput.value.trim().toLowerCase();
    if (q.length < 2) { searchResults.classList.remove('visible'); return; }

    const queueKeys = new Set(queueItems.map(i => i.movie_key));

    // Local results from Greg's library
    const localMatches = allGregFilms
      .filter(f => f.title.toLowerCase().includes(q))
      .slice(0, 8)
      .map(f => ({ ...f, source: 'In Greg\u2019s library' }));

    searchResults.innerHTML = '';

    if (localMatches.length > 0) {
      const header = document.createElement('div');
      header.className = 'search-divider';
      header.textContent = 'Greg\u2019s Library';
      searchResults.appendChild(header);

      localMatches.forEach(film => {
        searchResults.appendChild(buildResultRow(film, queueKeys));
      });
    }

    // Always show "Search Letterboxd" button for external search
    const extBtn = document.createElement('button');
    extBtn.className = 'search-external-btn';
    extBtn.textContent = '\uD83C\uDF10 Search all of Letterboxd for \u201C' + escHtml(searchInput.value.trim()) + '\u201D';
    extBtn.onclick = () => searchExternal(searchInput.value.trim());
    searchResults.appendChild(extBtn);

    searchResults.classList.add('visible');
  }

  async function searchExternal(query) {
    const queueKeys = new Set(queueItems.map(i => i.movie_key));
    const localKeys = new Set(allGregFilms.map(f => f.movie_key));

    const extBtns = searchResults.querySelectorAll('.search-external-btn');
    extBtns.forEach(b => { b.textContent = 'Searching Letterboxd...'; b.disabled = true; });

    try {
      const res = await fetch(SEARCH_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query })
      });
      const data = await res.json();
      const results = (data.results || []).filter(r => !localKeys.has(r.movieKey));

      extBtns.forEach(b => b.remove());

      if (results.length > 0) {
        const header = document.createElement('div');
        header.className = 'search-divider';
        header.textContent = 'From Letterboxd';
        searchResults.appendChild(header);

        results.forEach(r => {
          const film = {
            movie_key: r.movieKey,
            title: r.title,
            year: r.year || '',
            poster_url: r.posterUrl,
            source: r.year ? r.year : 'Letterboxd',
          };
          searchResults.appendChild(buildResultRow(film, queueKeys));
        });
      } else {
        const noRes = document.createElement('div');
        noRes.className = 'search-no-results';
        noRes.textContent = 'No additional results on Letterboxd';
        searchResults.appendChild(noRes);
      }
    } catch (e) {
      extBtns.forEach(b => { b.textContent = 'Search failed \u2014 try again'; b.disabled = false; });
    }
  }

  // ───── Actions ─────
  async function addToQueue(film, assignedTo) {
    try {
      const headers = { 'Content-Type': 'application/json' };
      // Only include auth if logged in
      if (authToken) headers['Authorization'] = 'Bearer ' + authToken;

      const res = await fetch(ACTIONS_URL, {
        method: 'POST',
        headers,
        body: JSON.stringify({
          action: 'watchlist_add',
          movieKey: film.movie_key,
          data: {
            title: film.title,
            posterUrl: film.poster_url || null,
            note: null,
            assignedTo: assignedTo,
          }
        })
      });
      if (!res.ok) throw new Error('Failed');
      showToast('Added "' + film.title + '"');
      searchInput.value = '';
      searchResults.classList.remove('visible');
      await fetchWatchlist();
      render();
    } catch (e) {
      showToast('Error adding film');
    }
  }

  async function updateItem(movieKey, updates) {
    try {
      const res = await fetch(ACTIONS_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + authToken,
        },
        body: JSON.stringify({
          action: 'watchlist_update',
          movieKey,
          data: updates
        })
      });
      if (!res.ok) throw new Error('Failed');
      await fetchWatchlist();
      render();
    } catch (e) {
      showToast('Error updating');
    }
  }

  async function removeFromQueue(movieKey, title) {
    try {
      const res = await fetch(ACTIONS_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + authToken,
        },
        body: JSON.stringify({ action: 'watchlist_remove', movieKey, data: {} })
      });
      if (!res.ok) throw new Error('Failed');
      showToast('Removed "' + title + '"');
      await fetchWatchlist();
      render();
    } catch (e) {
      showToast('Error removing film');
    }
  }

  // ───── Realtime ─────
  function subscribeRealtime() {
    supabaseClient
      .channel('watchlist-changes')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'watchlist' }, async () => {
        await fetchWatchlist();
        render();
      })
      .subscribe();
  }

  // ───── Helpers ─────
  function escHtml(str) {
    const d = document.createElement('div');
    d.textContent = str || '';
    return d.innerHTML;
  }

  function formatDate(iso) {
    if (!iso) return '';
    const d = new Date(iso);
    const now = new Date();
    const diff = now - d;
    if (diff < 60000) return 'just now';
    if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
    if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
    if (diff < 604800000) return Math.floor(diff / 86400000) + 'd ago';
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  }

  // ───── Filter clicks ─────
  document.querySelectorAll('.filter-chip').forEach(chip => {
    chip.addEventListener('click', () => {
      activeFilter = chip.dataset.filter;
      render();
    });
  });

  // ───── Init ─────
  async function init() {
    loadSession();

    // Load data (Greg films for search + watchlist)
    const [_, __] = await Promise.all([
      fetchGregFilms().then(f => allGregFilms = f),
      fetchWatchlist()
    ]);

    render();
    subscribeRealtime();
  }

  init();
</script>

</body>
</html>
