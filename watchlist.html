<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DUFIVE | The Queue</title>

  <!-- Open Graph / Social -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://dufive.com/watchlist.html" />
  <meta property="og:title" content="DUFIVE | The Queue" />
  <meta property="og:description" content="Films waiting for Greg and Peer. Add yours to the backlog." />
  <meta property="og:image" content="https://dufive.com/og-image.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="DUFIVE | The Queue" />
  <meta name="twitter:description" content="Films waiting for Greg and Peer. Add yours to the backlog." />
  <meta name="twitter:image" content="https://dufive.com/og-image.png" />
  <meta name="description" content="The Queue ‚Äî films waiting for Greg and Peer to watch and review on DUFIVE." />
  <meta name="theme-color" content="#0a0a0a" />
  <link rel="manifest" href="/manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=Instrument+Sans:wght@400;500;600;700&family=Lora:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;1,400;1,600&display=swap" rel="stylesheet">

  <style>
    :root, [data-theme="light"] {
      --bg: #f5f0eb; --bg-secondary: #ece7e1; --card-bg: transparent;
      --text: #1a1a1a; --text-secondary: #5c5c5c; --text-muted: #8c8580;
      --accent: #1a1a1a; --accent-hover: #000000;
      --border: #d4cfc9; --border-light: #e8e3dd;
      --greg: #c2410c; --greg-bg: rgba(194, 65, 12, 0.08);
      --peer: #1e40af; --peer-bg: rgba(30, 64, 175, 0.08);
      --shadow: none; --shadow-lg: none;
      --radius: 0px; --transition: all 0.15s ease;
      --overlay-bg: rgba(0,0,0,0.7);
      --success: #15803d;
      --priority-high: #c2410c;
      --priority-high-glow: rgba(194, 65, 12, 0.12);
      --skeleton-from: #e0dbd5; --skeleton-to: #ece7e1;
      --mono: 'IBM Plex Mono', monospace;
    }
    [data-theme="dark"] {
      --bg: #0f0f0f; --bg-secondary: #181816; --card-bg: transparent;
      --text: #e8e4df; --text-secondary: #9c9890; --text-muted: #6b6660;
      --accent: #e8e4df; --accent-hover: #ffffff;
      --border: #2a2824; --border-light: #1f1d1a;
      --greg: #fb923c; --greg-bg: rgba(251, 146, 60, 0.1);
      --peer: #93b4f5; --peer-bg: rgba(147, 180, 245, 0.1);
      --shadow: none; --shadow-lg: none;
      --overlay-bg: rgba(0,0,0,0.85);
      --success: #22c55e;
      --priority-high: #fb923c;
      --priority-high-glow: rgba(251, 146, 60, 0.15);
      --skeleton-from: #2a2824; --skeleton-to: #353330;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { overflow-x: hidden; }
    body {
      font-family: 'Instrument Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
      background: var(--bg); color: var(--text);
      line-height: 1.5; -webkit-font-smoothing: antialiased;
    }
    .container { max-width: 1400px; margin: 0 auto; padding: 0 32px; }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Nav ‚Äî Editorial ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    nav {
      display: flex; justify-content: space-between; align-items: center;
      padding: 28px 0; margin-bottom: 32px;
      border-bottom: 1px solid var(--border);
    }
    .brand {
      font-weight: 400; font-size: 0.55rem; line-height: 1;
      text-decoration: none; color: var(--text-muted);
      letter-spacing: 0.35em; text-transform: uppercase;
      display: flex; align-items: center; gap: 12px;
    }
    .brand-monogram {
      width: 80px; height: 80px; flex-shrink: 0;
      border: 4px solid var(--text);
      border-radius: 50%;
      position: relative;
      overflow: hidden;
      color: var(--text);
    }
    .brand-monogram .d, .brand-monogram .five {
      position: absolute;
      font-family: 'Lora', serif;
      font-weight: 700;
      font-size: 3.95rem;
      line-height: 1;
      color: var(--text);
    }
    .brand-monogram .d { top: 0px; left: -1px; }
    .brand-monogram .five { top: 12px; left: 36px; }
    .nav-controls { display: flex; gap: 16px; align-items: center; }
    .hamburger {
      display: none; background: none; border: 1px solid var(--border);
      border-radius: 0; padding: 6px 8px; cursor: pointer;
      font-size: 1.2rem; line-height: 1; color: var(--text);
      transition: var(--transition);
    }
    .hamburger:hover { border-color: var(--text); }
    .nav-link {
      font-size: 0.7rem; font-weight: 500; letter-spacing: 0.1em; text-transform: uppercase;
      color: var(--text-muted); text-decoration: none; padding: 4px 0; border-radius: 0;
      transition: var(--transition);
    }
    .nav-link:hover { color: var(--text); text-decoration: underline; text-underline-offset: 4px; background: none; }
    .nav-link.active { color: var(--text); text-decoration: underline; text-underline-offset: 4px; }
    .theme-toggle {
      width: 32px; height: 32px; border-radius: 0; border: none;
      background: none; cursor: pointer; font-size: 1rem; transition: var(--transition);
      display: flex; align-items: center; justify-content: center; color: var(--text-muted);
    }
    .theme-toggle:hover { color: var(--text); }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    header { margin-bottom: 24px; }
    .page-title {
      font-family: 'Playfair Display', serif; font-size: clamp(3rem, 8vw, 5.5rem);
      line-height: 1.05; font-weight: 400; letter-spacing: -0.03em; margin-bottom: 16px;
    }
    .tagline {
      font-family: var(--mono); font-size: 0.85rem; color: var(--text-muted);
      letter-spacing: 0.08em; text-transform: uppercase;
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Add Film Section (always visible) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .add-section {
      margin-bottom: 32px; padding: 20px 0; background: transparent;
      border: none; border-bottom: 1px solid var(--border); border-radius: 0;
    }
    .add-label {
      font-size: 0.65rem; font-weight: 600; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 10px;
    }
    .add-row { display: flex; justify-content: space-between; align-items: center; gap: 16px; }
    .search-row { display: flex; gap: 8px; position: relative; max-width: 360px; flex: 0 1 360px; }
    .search-input {
      flex: 1; padding: 10px 0; font-size: 0.9rem; font-family: inherit;
      border: none; border-bottom: 1px solid var(--border); border-radius: 0;
      background: transparent; color: var(--text); outline: none; transition: var(--transition);
    }
    .search-input:focus { border-bottom-color: var(--text); }
    .search-input::placeholder { color: var(--text-muted); letter-spacing: 0.02em; }

    /* Search results dropdown */
    .search-results {
      position: absolute; top: 100%; left: 0; right: 0; z-index: 50;
      margin-top: 4px; background: var(--bg); border: 1px solid var(--border);
      border-radius: 0; max-height: 320px;
      overflow-y: auto; display: none;
    }
    .search-results.visible { display: block; }
    .search-result {
      display: flex; align-items: center; gap: 12px; padding: 10px 14px;
      cursor: pointer; transition: var(--transition); border-bottom: 1px solid var(--border-light);
    }
    .search-result:last-child { border-bottom: none; }
    .search-result:hover { background: var(--border-light); }
    .search-result-poster {
      width: 36px; height: 54px; border-radius: 0; object-fit: cover;
      background: var(--border-light); flex-shrink: 0;
    }
    .search-result-info { flex: 1; min-width: 0; }
    .search-result-title {
      font-size: 0.85rem; font-weight: 600; color: var(--text);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .search-result-meta { font-size: 0.7rem; color: var(--text-muted); }
    .search-result-actions { display: flex; gap: 4px; flex-shrink: 0; }
    .search-result-add {
      font-size: 0.65rem; font-weight: 700; color: var(--accent);
      background: none; border: 1px solid var(--accent); border-radius: 0;
      padding: 4px 8px; cursor: pointer; transition: var(--transition); white-space: nowrap;
      letter-spacing: 0.04em; text-transform: uppercase;
    }
    .search-result-add:hover { background: var(--accent); color: #fff; }
    .search-result-add.greg { color: var(--greg); border-color: var(--greg); }
    .search-result-add.greg:hover { background: var(--greg); color: #fff; }
    .search-result-add.peer { color: var(--peer); border-color: var(--peer); }
    .search-result-add.peer:hover { background: var(--peer); color: #fff; }
    .search-result.in-queue .search-result-add {
      color: var(--text-muted); border-color: var(--border); cursor: default;
    }
    .search-no-results {
      padding: 16px; text-align: center; font-size: 0.85rem; color: var(--text-muted);
    }
    .search-divider {
      padding: 8px 14px; font-size: 0.7rem; font-weight: 600; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.06em; background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-light);
    }
    .search-external-btn {
      display: block; width: 100%; padding: 12px; text-align: center;
      font-size: 0.8rem; font-weight: 600; color: var(--accent); cursor: pointer;
      background: none; border: none; border-top: 1px solid var(--border-light);
      transition: var(--transition); font-family: inherit;
    }
    .search-external-btn:hover { background: var(--border-light); }
    .search-loading {
      padding: 12px; text-align: center; font-size: 0.8rem; color: var(--text-muted);
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Filter chips ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .filters {
      display: flex; gap: 4px; flex-wrap: wrap; justify-content: center; margin-bottom: 24px; align-items: center;
    }
    .filter-chip {
      font-size: 0.7rem; font-weight: 500; padding: 4px 0; border-radius: 0;
      border: none; background: none; color: var(--text-muted);
      cursor: pointer; transition: var(--transition); user-select: none;
      letter-spacing: 0.1em; text-transform: uppercase;
    }
    .filter-chip::before { content: '/'; margin-right: 4px; color: var(--border); }
    .filter-chip:first-child::before { content: none; }
    .filter-chip:hover { color: var(--text); }
    .filter-chip.active { color: var(--text); font-weight: 700; text-decoration: underline; text-underline-offset: 4px; text-decoration-thickness: 2px; }

    /* The Choice button */
    .pick-btn {
      font-size: 0.7rem; font-weight: 600; padding: 8px 20px; border-radius: 0;
      border: 1px solid var(--text); background: none; color: var(--text);
      cursor: pointer; transition: var(--transition); user-select: none;
      display: inline-flex; align-items: center; gap: 6px;
      letter-spacing: 0.1em; text-transform: uppercase; white-space: nowrap;
      flex-shrink: 0;
    }
    .pick-btn:hover { background: var(--text); color: var(--bg); }

    /* Pick overlay */
    .pick-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.85);
      backdrop-filter: blur(14px); -webkit-backdrop-filter: blur(14px);
      z-index: 10000; display: flex; align-items: center; justify-content: center;
      flex-direction: column; gap: 20px;
    }
    .pick-card {
      background: var(--bg); border: 1px solid var(--border); border-radius: 0; padding: 32px;
      text-align: center; max-width: 340px; width: 90%;
      animation: pickReveal 0.6s cubic-bezier(.4,0,.2,1);
    }
    @keyframes pickReveal {
      0% { opacity: 0; transform: translateY(12px); }
      100% { opacity: 1; transform: translateY(0); }
    }
    .pick-poster { width: 180px; height: 270px; border-radius: 0; object-fit: cover; margin: 0 auto 16px; border: 1px solid var(--text); }
    .pick-poster-fallback {
      width: 180px; height: 270px; border-radius: 0; margin: 0 auto 16px;
      background: var(--bg-secondary); border: 1px solid var(--border);
      display: flex; align-items: center; justify-content: center;
      font-size: 1.2rem; color: var(--text-muted); opacity: 0.5;
    }
    .pick-title { font-family: 'Playfair Display', serif; font-size: 1.3rem; font-weight: 400; color: var(--text); margin-bottom: 4px; }
    .pick-subtitle { font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 16px; letter-spacing: 0.06em; }
    .pick-actions { display: flex; gap: 10px; justify-content: center; }
    .pick-actions button {
      padding: 8px 20px; border-radius: 0; font-size: 0.75rem; font-weight: 600; cursor: pointer; border: none; transition: var(--transition); letter-spacing: 0.06em; text-transform: uppercase;
    }
    .pick-again { background: transparent; color: var(--text); border: 1px solid var(--border) !important; }
    .pick-again:hover { border-color: var(--text) !important; }
    .pick-close { background: var(--text); color: var(--bg); }
    .pick-close:hover { opacity: 0.8; }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Queue Grid ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .queue-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 24px 16px;
    }
    @media (max-width: 480px) {
      .queue-grid { grid-template-columns: repeat(3, 1fr); gap: 16px 10px; }
    }

    .queue-card {
      background: transparent; border: none; border-radius: 0;
      overflow: visible;
      opacity: 0; transform: translateY(16px);
      transition: opacity 0.5s cubic-bezier(.4,0,.2,1), transform 0.5s cubic-bezier(.4,0,.2,1);
      position: relative;
    }
    .queue-card.visible { opacity: 1; transform: translateY(0); }
    .queue-card:hover { transform: none; }

    /* Priority: subtle top border indicator */
    .queue-card.priority-high .queue-poster {
      border-color: var(--priority-high);
    }
    .queue-card.priority-low {
      opacity: 0.7;
    }
    .queue-card.priority-low:hover { opacity: 1; }

    .queue-poster {
      aspect-ratio: 2/3; background: var(--border-light); overflow: hidden;
      position: relative; border: 1px solid var(--text);
    }
    .queue-card:hover .queue-poster img,
    .queue-card:hover .queue-poster .queue-poster-fallback { opacity: 0.85; }
    .queue-poster img {
      width: 100%; height: 100%; object-fit: cover; object-position: center 20%;
      transition: opacity 0.15s ease;
    }

    /* ‚ïê‚ïê‚ïê Film Detail Overlay (enlarged poster + info) ‚ïê‚ïê‚ïê */
    .film-detail-overlay {
      position: fixed; inset: 0;
      background: var(--overlay-bg); backdrop-filter: blur(6px);
      display: flex; align-items: center; justify-content: center;
      z-index: 10000; padding: 24px;
      animation: fdFadeIn 0.25s ease;
    }
    @keyframes fdFadeIn { from { opacity: 0; } to { opacity: 1; } }
    .film-detail-card {
      background: var(--bg); border: 1px solid var(--border);
      display: flex; gap: 24px; max-width: 600px; width: 100%;
      padding: 24px;
      animation: fdSlideUp 0.3s cubic-bezier(0.4,0,0.2,1);
      max-height: 85vh; overflow-y: auto;
    }
    @keyframes fdSlideUp {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .fd-poster {
      width: 200px; min-width: 200px; flex-shrink: 0;
    }
    .fd-poster img {
      width: 100%; aspect-ratio: 2/3; object-fit: cover; border: 1px solid var(--text);
    }
    .fd-poster-fallback {
      width: 100%; aspect-ratio: 2/3;
      background: var(--bg-secondary); border: 1px solid var(--border);
      display: flex; align-items: center; justify-content: center;
      font-family: 'Playfair Display', serif; font-size: 1rem; color: var(--text-muted);
    }
    .fd-info {
      flex: 1; display: flex; flex-direction: column; gap: 8px; min-width: 0;
    }
    .fd-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.25rem; font-weight: 700;
      letter-spacing: -0.02em; color: var(--text); line-height: 1.2;
    }
    .fd-meta {
      font-family: var(--mono); font-size: 0.7rem;
      color: var(--text-muted); text-transform: uppercase;
      letter-spacing: 0.06em; line-height: 1.4;
    }
    .fd-cast {
      font-family: var(--mono); font-size: 0.65rem;
      color: var(--text-secondary); letter-spacing: 0.03em; line-height: 1.4;
    }
    .fd-tagline {
      font-family: 'Lora', serif; font-size: 0.8rem;
      font-style: italic; color: var(--text-secondary); line-height: 1.4;
    }
    .fd-genres { display: flex; flex-wrap: wrap; gap: 4px; }
    .fd-genre {
      font-family: var(--mono); font-size: 0.55rem;
      text-transform: uppercase; letter-spacing: 0.08em;
      padding: 2px 6px; border: 1px solid var(--border); color: var(--text-secondary);
    }
    .fd-synopsis {
      font-family: 'Lora', serif; font-size: 0.8rem;
      font-style: italic; color: var(--text); line-height: 1.6; margin-top: 4px;
    }
    .fd-loading {
      font-family: var(--mono); font-size: 0.75rem;
      color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em;
      padding: 40px 0; text-align: center;
    }
    @media (max-width: 600px) {
      .film-detail-card { flex-direction: column; gap: 16px; padding: 20px; }
      .fd-poster { width: 140px; min-width: 140px; align-self: center; }
      .fd-title { font-size: 1.1rem; }
    }
    .queue-poster-fallback {
      width: 100%; height: 100%; display: flex; flex-direction: column;
      align-items: center; justify-content: flex-end;
      padding: 14px 10px; text-align: center; position: relative; overflow: hidden;
      background: var(--bg-secondary); border: 1px solid var(--border);
    }
    .queue-poster-fallback span {
      font-family: 'Playfair Display', serif; font-size: 0.8rem; font-weight: 700;
      color: var(--text-muted); line-height: 1.2; position: relative; z-index: 1;
    }

    /* Remove button on poster hover */
    .queue-remove {
      position: absolute; top: 6px; right: 6px; width: 20px; height: 20px;
      border-radius: 0; background: rgba(0,0,0,0.7); color: #fff; border: none;
      font-size: 0.7rem; cursor: pointer; display: none; align-items: center;
      justify-content: center; transition: var(--transition);
      z-index: 4;
    }
    .queue-card:hover .queue-remove { display: flex; }
    .queue-remove:hover { background: #dc2626; }

    /* Info area below poster */
    .queue-info { padding: 8px 0 0; }
    .queue-title {
      font-size: 0.75rem; font-weight: 500; color: var(--text); line-height: 1.3;
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* Tags row (assignment + priority) */
    .card-tags { display: flex; gap: 4px; flex-wrap: wrap; margin-top: 4px; }
    .card-tag {
      font-size: 0.55rem; font-weight: 700; padding: 1px 4px; border-radius: 0;
      text-transform: uppercase; letter-spacing: 0.06em; line-height: 1.5;
    }
    .card-tag.greg { color: var(--greg); background: var(--greg-bg); }
    .card-tag.peer { color: var(--peer); background: var(--peer-bg); }
    .card-tag.both { color: var(--text-muted); background: var(--border-light); }
    .card-tag.high { color: var(--priority-high); background: rgba(239,68,68,0.08); }
    .card-tag.low { color: var(--text-muted); background: var(--border-light); }

    .suggested-tag {
      font-size: 0.6rem; color: var(--text-muted); margin-top: 2px;
    }
    .queue-note {
      font-size: 0.68rem; color: var(--text-muted); margin-top: 3px; font-style: italic;
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* Pill toggle buttons (priority + assignment) */
    .pill-controls {
      display: flex; gap: 3px; margin-top: 5px; align-items: center; flex-wrap: wrap;
    }
    .pill-group { display: flex; gap: 2px; align-items: center; }
    .pill-group + .pill-group { margin-left: 4px; }
    .pill-btn {
      font-family: var(--mono); font-size: 0.5rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.06em;
      padding: 2px 5px; border: 1px solid var(--border); border-radius: 0;
      background: transparent; color: var(--text-muted);
      cursor: pointer; transition: var(--transition); white-space: nowrap;
    }
    .pill-btn:hover { border-color: var(--text); color: var(--text); }
    .pill-btn.active {
      background: var(--text); color: var(--bg); border-color: var(--text);
    }

    /* "Watched" button */
    .queue-watched-btn {
      font-family: var(--mono); font-size: 0.55rem; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.08em;
      padding: 4px 10px; margin-top: 6px;
      border: 1px solid var(--text); border-radius: 0;
      background: transparent; color: var(--text);
      cursor: pointer; transition: var(--transition); width: 100%;
    }
    .queue-watched-btn:hover { background: var(--text); color: var(--bg); }

    /* Days on queue ‚Äî poster corner stamp */
    .queue-days-stamp {
      position: absolute; top: 0; left: 0;
      font-family: var(--mono); font-size: 0.5rem; font-weight: 700;
      color: #fff; background: rgba(0,0,0,0.6);
      padding: 3px 6px; letter-spacing: 0.03em;
      line-height: 1; z-index: 3;
      text-transform: lowercase;
      pointer-events: none;
    }

    /* Position badge ‚Äî top-right of poster */
    .queue-position-badge {
      position: absolute; top: 0; right: 0;
      font-family: var(--mono); font-size: 0.6rem; font-weight: 700;
      color: #fff; background: rgba(0,0,0,0.65);
      padding: 3px 7px; letter-spacing: 0.02em;
      line-height: 1; z-index: 3;
      cursor: default;
    }
    .queue-position-badge.editable { cursor: pointer; }
    .queue-position-badge.editable:hover { background: rgba(0,0,0,0.85); }
    .queue-position-badge.next-up {
      background: var(--text); color: var(--bg);
      font-size: 0.5rem; letter-spacing: 0.06em; text-transform: uppercase;
    }
    /* Inline position edit input */
    .queue-position-input {
      width: 36px; padding: 2px 4px; font-family: var(--mono); font-size: 0.6rem;
      font-weight: 700; text-align: center; border: 1px solid var(--text);
      border-radius: 0; background: var(--bg); color: var(--text); outline: none;
    }

    /* "NEW" badge ‚Äî for recently added items */
    .queue-new-badge {
      font-family: var(--mono); font-size: 0.5rem; font-weight: 700;
      color: var(--priority-high); letter-spacing: 0.08em; text-transform: uppercase;
      display: inline-block; margin-left: 4px;
    }

    /* "REWATCH" tag */
    .card-tag.rewatch {
      color: var(--text-secondary); background: var(--border-light);
      font-style: italic;
    }

    /* "Next Up" pin button */
    .queue-pin-btn {
      position: absolute; bottom: 6px; right: 6px;
      width: 22px; height: 22px; border-radius: 0;
      background: rgba(0,0,0,0.7); color: #fff; border: none;
      font-size: 0.65rem; cursor: pointer; display: none;
      align-items: center; justify-content: center;
      transition: var(--transition); z-index: 4;
      line-height: 1;
    }
    .queue-card:hover .queue-pin-btn { display: flex; }
    .queue-pin-btn:hover { background: var(--text); }
    .queue-pin-btn.is-first { display: none !important; }

    /* Pinned position badge ‚Äî locked look */
    .queue-position-badge.pinned {
      background: var(--text); color: var(--bg);
      font-size: 0.5rem; letter-spacing: 0.06em; text-transform: uppercase;
      cursor: default;
    }
    .queue-position-badge.pinned:hover { background: var(--text); }

    /* Pinned card ‚Äî subtle visual distinction */
    .queue-card.is-pinned .queue-poster {
      border-width: 2px;
    }
    /* Suggested-by line below poster */
    .queue-suggested {
      font-family: var(--mono); font-size: 0.5rem;
      color: var(--text-muted); letter-spacing: 0.04em;
      margin-top: 2px;
    }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Confirm Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .confirm-overlay {
      position: fixed; inset: 0;
      background: var(--overlay-bg); backdrop-filter: blur(4px);
      display: flex; align-items: center; justify-content: center;
      z-index: 10000;
    }
    .confirm-panel {
      background: var(--bg); border: 1px solid var(--border);
      max-width: 360px; width: 90%; padding: 28px; text-align: center;
    }
    .confirm-title {
      font-family: 'Playfair Display', serif; font-size: 1.1rem; font-weight: 400;
      color: var(--text); margin-bottom: 8px; line-height: 1.3;
    }
    .confirm-subtitle {
      font-size: 0.8rem; color: var(--text-muted); margin-bottom: 20px; line-height: 1.4;
    }
    .confirm-actions { display: flex; gap: 10px; justify-content: center; }
    .confirm-btn {
      font-family: var(--mono); font-size: 0.65rem; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.08em;
      padding: 8px 20px; border-radius: 0; cursor: pointer; transition: var(--transition);
    }
    .confirm-btn.primary {
      background: var(--text); color: var(--bg); border: 1px solid var(--text);
    }
    .confirm-btn.primary:hover { opacity: 0.8; }
    .confirm-btn.secondary {
      background: transparent; color: var(--text); border: 1px solid var(--border);
    }
    .confirm-btn.secondary:hover { border-color: var(--text); }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Empty State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .empty-state {
      text-align: center; padding: 60px 20px; color: var(--text-muted);
    }
    .empty-icon { font-size: 3rem; margin-bottom: 12px; }
    .empty-title {
      font-family: 'Playfair Display', serif; font-size: 1.3rem; font-weight: 400;
      color: var(--text-secondary); margin-bottom: 6px;
    }
    .empty-text { font-size: 0.85rem; max-width: 300px; margin: 0 auto; }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Recently Watched (cleared from queue) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .watched-section { margin-top: 48px; }
    .watched-header {
      font-size: 0.75rem; font-weight: 600; color: var(--text-muted);
      text-transform: uppercase; letter-spacing: 0.06em; margin-bottom: 12px;
      padding-bottom: 8px; border-bottom: 1px solid var(--border-light);
    }
    .watched-list { display: flex; flex-direction: column; gap: 8px; }
    .watched-item {
      display: flex; align-items: center; gap: 10px; padding: 8px 0;
      background: transparent; border-bottom: 1px solid var(--border-light); border-radius: 0; font-size: 0.8rem;
      color: var(--text-secondary); opacity: 0.7;
    }
    .watched-item-check { color: var(--success); font-size: 0.9rem; }
    .watched-item-title { flex: 1; }
    .watched-item-date { font-size: 0.7rem; color: var(--text-muted); }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .toast {
      position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(100px);
      background: var(--text); border: none; color: var(--bg);
      padding: 10px 20px; border-radius: 0; font-size: 0.8rem; font-weight: 500;
      letter-spacing: 0.02em;
      z-index: 999; transition: transform 0.3s ease;
      pointer-events: none;
    }
    .toast.show { transform: translateX(-50%) translateY(0); }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Footer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .site-footer {
      margin-top: 60px;
      padding: 24px 0;
      border-top: 1px solid var(--border-light);
      text-align: center;
    }
    .footer-support {
      display: inline-block;
      font-size: 0.7rem;
      color: var(--text-muted);
      text-decoration: none;
      padding: 8px 20px;
      border: 1px solid var(--border);
      border-radius: 0;
      transition: var(--transition);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }
    .footer-support:hover {
      color: var(--text);
      border-color: var(--text);
    }
    .footer-copy {
      font-size: 0.65rem;
      color: var(--text-muted);
      margin-top: 12px;
      opacity: 0.6;
    }

    /* scroll-triggered animation handled by IntersectionObserver */

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Loading ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    .loading {
      text-align: center; padding: 40px; color: var(--text-muted); font-size: 0.9rem;
    }
    /* Skeleton loading */
    .skeleton-queue {
      background: transparent; border: none; border-radius: 0; overflow: visible;
    }
    .skeleton-queue-poster {
      aspect-ratio: 2/3;
      background: linear-gradient(90deg, var(--skeleton-from) 25%, var(--skeleton-to) 50%, var(--skeleton-from) 75%);
      background-size: 200% 100%; animation: shimmer 1.5s infinite;
    }
    .skeleton-queue-info { padding: 8px 0; display: flex; flex-direction: column; gap: 6px; }
    .skeleton-queue-line {
      height: 12px; border-radius: 0;
      background: linear-gradient(90deg, var(--skeleton-from) 25%, var(--skeleton-to) 50%, var(--skeleton-from) 75%);
      background-size: 200% 100%; animation: shimmer 1.5s infinite;
    }
    .skeleton-queue-line.short { width: 50%; }
    @keyframes shimmer { to { background-position: -200% 0; } }

    /* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Responsive: Mobile ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
    @media (max-width: 600px) {
      .container { padding: 0 16px 40px; }

      nav {
        flex-direction: row; justify-content: space-between; align-items: center;
        padding: 16px 0; margin-bottom: 32px; position: relative;
      }
      .brand { font-size: 0.5rem; }
      .brand-monogram { width: 56px; height: 56px; border-width: 3px; }
      .brand-monogram .d, .brand-monogram .five { font-size: 2.75rem; }
      .brand-monogram .d { top: 0px; left: -1px; }
      .brand-monogram .five { top: 8px; left: 25px; }
      .hamburger { display: block; }
      .nav-controls {
        display: none; position: absolute; top: 100%; left: 0; right: 0;
        flex-direction: column; align-items: stretch;
        background: var(--bg); border: 1px solid var(--border);
        border-radius: 0;
        padding: 8px; gap: 2px; z-index: 100;
      }
      .nav-controls.open { display: flex; }
      .nav-controls .nav-link { padding: 10px 14px; font-size: 0.8rem; border-radius: 0; text-decoration: none; }
      .nav-controls .theme-toggle {
        width: 100%; border-radius: 0; justify-content: flex-start;
        padding: 10px 14px; gap: 8px; font-size: 0.8rem; border: none;
      }

      .add-row { flex-direction: column; align-items: stretch; gap: 12px; }
      .search-row { max-width: 100%; flex: 1; }

      /* Pill buttons: slightly larger on mobile for easier tapping */
      .pill-btn { font-size: 0.55rem; padding: 3px 6px; }
      .queue-watched-btn { font-size: 0.6rem; padding: 5px 10px; }

      /* Position badge + pin always visible on mobile (no hover) */
      .queue-pin-btn { display: flex; }
      .queue-pin-btn.is-first { display: none !important; }
      .queue-remove { display: flex; }
    }
  </style>
</head>
<body>

<div class="container">
  <nav>
    <a href="/" class="brand"><span class="brand-monogram"><span class="d">D</span><span class="five">5</span></span>dufive</a>
    <button class="hamburger" id="hamburger" aria-label="Menu">&#9776;</button>
    <div class="nav-controls" id="nav-controls">
      <a href="/" class="nav-link">The Ledger</a>
      <a href="watchlist.html" class="nav-link active">The Queue</a>
      <button id="theme-toggle" class="theme-toggle" title="Toggle dark mode">
        <span id="theme-icon">&#9790;</span>
      </button>
    </div>
  </nav>

  <header>
    <h1 class="page-title">The Queue.</h1>
    <p class="tagline" id="queue-tagline">Current status: loading the backlog.</p>
  </header>

  <!-- Add film search ‚Äî always visible, anyone can add -->
  <div class="add-section" id="add-section">
    <div class="add-label">Add to the Queue</div>
    <div class="add-row">
      <div class="search-row">
        <input type="text" class="search-input" id="film-search" placeholder="Search for a film..." autocomplete="off" />
        <div class="search-results" id="search-results"></div>
      </div>
      <button class="pick-btn" id="pick-btn" title="Pick a random film from the queue">The Choice</button>
    </div>
  </div>

  <!-- Filters -->
  <div class="filters" id="filters">
    <div class="filter-chip active" data-filter="all">All</div>
    <div class="filter-chip" data-filter="high">High Priority</div>
    <div class="filter-chip" data-filter="greg">For Greg</div>
    <div class="filter-chip" data-filter="peer">For Peer</div>
  </div>

  <!-- Queue grid -->
  <div id="queue-area">
    <div class="queue-grid" id="loading">
      <div class="skeleton-queue"><div class="skeleton-queue-poster"></div><div class="skeleton-queue-info"><div class="skeleton-queue-line"></div><div class="skeleton-queue-line short"></div></div></div>
      <div class="skeleton-queue"><div class="skeleton-queue-poster"></div><div class="skeleton-queue-info"><div class="skeleton-queue-line"></div><div class="skeleton-queue-line short"></div></div></div>
      <div class="skeleton-queue"><div class="skeleton-queue-poster"></div><div class="skeleton-queue-info"><div class="skeleton-queue-line"></div><div class="skeleton-queue-line short"></div></div></div>
      <div class="skeleton-queue"><div class="skeleton-queue-poster"></div><div class="skeleton-queue-info"><div class="skeleton-queue-line"></div><div class="skeleton-queue-line short"></div></div></div>
      <div class="skeleton-queue"><div class="skeleton-queue-poster"></div><div class="skeleton-queue-info"><div class="skeleton-queue-line"></div><div class="skeleton-queue-line short"></div></div></div>
      <div class="skeleton-queue"><div class="skeleton-queue-poster"></div><div class="skeleton-queue-info"><div class="skeleton-queue-line"></div><div class="skeleton-queue-line short"></div></div></div>
    </div>
    <div class="queue-grid" id="queue-grid"></div>
    <div class="empty-state" id="empty-state" style="display:none">
      <div class="empty-icon">‚Äî</div>
      <div class="empty-title">The queue is empty.</div>
      <div class="empty-text">Search for a film above to add it.</div>
    </div>
  </div>

  <!-- Recently watched (auto-completed) -->
  <div class="watched-section" id="watched-section" style="display:none">
    <div class="watched-header">Recently cleared</div>
    <div class="watched-list" id="watched-list"></div>
  </div>

  <footer class="site-footer">
    <a href="https://venmo.com/Greg-Dufore" target="_blank" rel="noopener" class="footer-support">Support the Ledger</a>
    <div class="footer-copy">DUFIVE &mdash; Consistently Inconsistent</div>
  </footer>
</div>

<div class="toast" id="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Config ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const SB_URL = 'https://brgxorrpfberfcyeugzq.supabase.co';
  const SB_KEY = 'sb_publishable_VbVFBh-gtIBAbr9Qtp240w_GS8Kn4Jf';
  const ACTIONS_URL = 'https://brgxorrpfberfcyeugzq.supabase.co/functions/v1/bright-function';
  const SEARCH_URL = 'https://brgxorrpfberfcyeugzq.supabase.co/functions/v1/search-films';
  if (!window.supabase) {
    document.getElementById('queue-grid').innerHTML =
      '<p style="text-align:center;padding:40px;color:var(--text-muted);">Loading failed ‚Äî please refresh the page.</p>';
    throw new Error('Supabase library not loaded');
  }
  const supabaseClient = window.supabase.createClient(SB_URL, SB_KEY);

  const TMDB_KEY = 'bfb6e869cd271ba3ac952a29f9279f09';
  const TMDB_BASE = 'https://api.themoviedb.org/3';
  const tmdbCache = {};

  let currentUser = null;
  let authToken = null;
  let allGregFilms = [];
  let queueItems = [];
  let watchedItems = [];
  let activeFilter = 'all';

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Auth (shared with main page via localStorage) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function loadSession() {
    const reviewer = localStorage.getItem('reviewer');
    const token = localStorage.getItem('session_token');
    if (reviewer && token) {
      currentUser = reviewer;
      authToken = token;
    }
  }

  function isAdmin() { return currentUser === 'admin'; }
  function canAct() { return !!currentUser; }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Theme ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const savedTheme = localStorage.getItem('dufive-theme') || 'light';
  document.documentElement.setAttribute('data-theme', savedTheme);
  document.getElementById('theme-icon').textContent = savedTheme === 'dark' ? '\u2600' : '\u263E';
  // Hamburger toggle
  document.getElementById('hamburger').addEventListener('click', (e) => {
    e.stopPropagation();
    document.getElementById('nav-controls').classList.toggle('open');
  });
  document.addEventListener('click', (e) => {
    if (!e.target.closest('nav')) document.getElementById('nav-controls').classList.remove('open');
  });

  document.getElementById('theme-toggle').addEventListener('click', () => {
    const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('dufive-theme', next);
    document.getElementById('theme-icon').textContent = next === 'dark' ? '\u2600' : '\u263E';
  });

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function showToast(msg) {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2500);
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Fetch all Greg films for search ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function fetchGregFilms() {
    const BATCH = 1000;
    let all = [], from = 0, more = true;
    while (more) {
      const { data } = await supabaseClient
        .from('greg_films')
        .select('movie_key, title, poster_url, letterboxd_url')
        .order('title', { ascending: true })
        .range(from, from + BATCH - 1);
      const rows = data || [];
      all = all.concat(rows);
      more = rows.length === BATCH;
      from += BATCH;
    }
    return all;
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Fetch watchlist ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function fetchWatchlist() {
    // Try ordering by sort_order first; fall back to added_at if column doesn't exist yet
    let resp = await supabaseClient
      .from('watchlist')
      .select('*')
      .order('sort_order', { ascending: true, nullsFirst: false });

    if (resp.error || !resp.data) {
      // sort_order column may not exist yet ‚Äî fall back to added_at
      resp = await supabaseClient
        .from('watchlist')
        .select('*')
        .order('added_at', { ascending: false });
    }

    const items = resp.data || [];
    queueItems = items.filter(i => i.status === 'queued');
    watchedItems = items.filter(i => i.status === 'watched').slice(0, 10);
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ TMDB Details ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function fetchTMDBDetails(rawTitle, year) {
    const txt = document.createElement('textarea');
    txt.innerHTML = rawTitle;
    let title = txt.value;

    const yearMatch = title.match(/\s*\((\d{4})\)\s*$/);
    if (yearMatch) {
      if (!year) year = yearMatch[1];
      title = title.replace(/\s*\(\d{4}\)\s*$/, '').trim();
    }

    const cacheKey = title + '-' + (year || '');
    if (tmdbCache[cacheKey]) return tmdbCache[cacheKey];
    try {
      let searchUrl = TMDB_BASE + '/search/movie?api_key=' + TMDB_KEY + '&query=' + encodeURIComponent(title);
      if (year) searchUrl += '&year=' + year;
      let searchRes = await fetch(searchUrl);
      if (!searchRes.ok) return null;
      let searchData = await searchRes.json();

      if ((!searchData.results || searchData.results.length === 0) && year) {
        const fallbackUrl = TMDB_BASE + '/search/movie?api_key=' + TMDB_KEY + '&query=' + encodeURIComponent(title);
        searchRes = await fetch(fallbackUrl);
        if (!searchRes.ok) return null;
        searchData = await searchRes.json();
      }

      if (!searchData.results || searchData.results.length === 0) return null;
      const movieId = searchData.results[0].id;

      const detailUrl = TMDB_BASE + '/movie/' + movieId + '?api_key=' + TMDB_KEY + '&append_to_response=credits';
      const detailRes = await fetch(detailUrl);
      if (!detailRes.ok) return null;
      const d = await detailRes.json();

      const director = d.credits?.crew?.find(c => c.job === 'Director')?.name || '';
      const genres = (d.genres || []).map(g => g.name).slice(0, 3);
      const runtime = d.runtime ? d.runtime + ' min' : '';
      const cast = (d.credits?.cast || []).slice(0, 4).map(c => c.name);
      const tagline = d.tagline || '';

      const result = {
        title: d.title || title,
        year: d.release_date ? d.release_date.substring(0, 4) : (year || ''),
        director, runtime, genres, cast, tagline,
        overview: d.overview || '',
      };
      tmdbCache[cacheKey] = result;
      return result;
    } catch (e) {
      console.error('[TMDB] Error:', e);
      return null;
    }
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Render ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function render() {
    const grid = document.getElementById('queue-grid');
    const empty = document.getElementById('empty-state');
    const loading = document.getElementById('loading');
    const countEl = document.getElementById('queue-tagline');
    const watchedSection = document.getElementById('watched-section');
    const watchedList = document.getElementById('watched-list');

    loading.style.display = 'none';
    grid.innerHTML = '';

    // Apply filter
    let filtered;
    if (activeFilter === 'all') {
      filtered = [...queueItems];
    } else if (activeFilter === 'high') {
      filtered = queueItems.filter(i => (i.priority || 'medium') === 'high');
    } else {
      filtered = queueItems.filter(i => (i.assigned_to || '') === activeFilter);
    }

    // Sort by sort_order (manual position); fallback to priority+date for items without sort_order
    filtered.sort((a, b) => {
      const sa = a.sort_order ?? 9999;
      const sb = b.sort_order ?? 9999;
      if (sa !== sb) return sa - sb;
      return new Date(b.added_at) - new Date(a.added_at);
    });

    // Count
    countEl.textContent = queueItems.length === 0
      ? 'The backlog is empty.'
      : 'Current status: ' + queueItems.length + ' film' + (queueItems.length !== 1 ? 's' : '') + ' in the backlog.';

    // Update active chip
    document.querySelectorAll('.filter-chip').forEach(chip => {
      chip.classList.toggle('active', chip.dataset.filter === activeFilter);
    });

    if (filtered.length === 0) {
      empty.style.display = '';
      grid.style.display = 'none';
    } else {
      empty.style.display = 'none';
      grid.style.display = '';

      filtered.forEach((item, idx) => {
        const card = document.createElement('div');
        card.className = 'queue-card';
        card.style.animationDelay = (idx * 0.04) + 's';

        // Apply priority border class
        const priority = item.priority || 'medium';
        if (priority === 'high') card.classList.add('priority-high');
        if (priority === 'low') card.classList.add('priority-low');

        // Poster
        const poster = document.createElement('div');
        poster.className = 'queue-poster';

        if (item.poster_url) {
          const img = document.createElement('img');
          img.src = item.poster_url;
          img.alt = item.title;
          img.loading = 'lazy';
          img.onerror = function() {
            this.style.display = 'none';
            const fb = document.createElement('div');
            fb.className = 'queue-poster-fallback';
            fb.innerHTML = '<span>' + escHtml(item.title) + '</span>';
            poster.appendChild(fb);
          };
          poster.appendChild(img);
        } else {
          const fb = document.createElement('div');
          fb.className = 'queue-poster-fallback';
          fb.innerHTML = '<span>' + escHtml(item.title) + '</span>';
          poster.appendChild(fb);
        }

        // Days on queue stamp (top-left corner)
        const daysOnQueue = Math.floor((Date.now() - new Date(item.added_at).getTime()) / 86400000);
        const stamp = document.createElement('div');
        stamp.className = 'queue-days-stamp';
        stamp.textContent = daysOnQueue + 'd on queue';
        poster.appendChild(stamp);

        // Position badge (top-right corner)
        const displayPos = idx + 1;
        const isPinned = item.pinned === true;
        const posBadge = document.createElement('div');

        if (isPinned) {
          // Pinned item: show lock icon, not editable (unless admin)
          card.classList.add('is-pinned');
          posBadge.className = 'queue-position-badge pinned';
          posBadge.textContent = '\uD83D\uDD12 #' + displayPos; // üîí #1
          if (isAdmin()) {
            posBadge.title = 'Pinned by admin. Click to change position.';
            posBadge.style.cursor = 'pointer';
            posBadge.onclick = (e) => {
              e.stopPropagation();
              const input = document.createElement('input');
              input.type = 'number'; input.min = '1'; input.max = '' + filtered.length;
              input.value = displayPos; input.className = 'queue-position-input';
              posBadge.replaceWith(input); input.focus(); input.select();
              const commit = () => {
                const newPos = parseInt(input.value, 10);
                if (!isNaN(newPos) && newPos >= 1 && newPos !== displayPos) {
                  updateItem(item.movie_key, { sortOrder: newPos });
                } else { input.replaceWith(posBadge); }
              };
              input.addEventListener('blur', commit);
              input.addEventListener('keydown', (ev) => {
                if (ev.key === 'Enter') { ev.preventDefault(); input.blur(); }
                if (ev.key === 'Escape') { input.value = displayPos; input.blur(); }
              });
            };
          }
        } else {
          // Normal item
          posBadge.className = 'queue-position-badge' + (canAct() ? ' editable' : '');
          if (displayPos === 1) {
            posBadge.classList.add('next-up');
            posBadge.textContent = 'Next Up';
          } else {
            posBadge.textContent = '#' + displayPos;
          }

          if (canAct()) {
            posBadge.title = 'Click to change position';
            posBadge.onclick = (e) => {
              e.stopPropagation();
              const input = document.createElement('input');
              input.type = 'number'; input.min = '1'; input.max = '' + filtered.length;
              input.value = displayPos; input.className = 'queue-position-input';
              posBadge.replaceWith(input); input.focus(); input.select();
              const commit = () => {
                const newPos = parseInt(input.value, 10);
                if (!isNaN(newPos) && newPos >= 1 && newPos !== displayPos) {
                  updateItem(item.movie_key, { sortOrder: newPos });
                } else { input.replaceWith(posBadge); }
              };
              input.addEventListener('blur', commit);
              input.addEventListener('keydown', (ev) => {
                if (ev.key === 'Enter') { ev.preventDefault(); input.blur(); }
                if (ev.key === 'Escape') { input.value = displayPos; input.blur(); }
              });
            };
          }
        }
        poster.appendChild(posBadge);

        // "Next Up" pin button (logged-in only, not on pinned or #1 items)
        if (canAct() && !isPinned) {
          const pin = document.createElement('button');
          pin.className = 'queue-pin-btn' + (displayPos === 1 ? ' is-first' : '');
          pin.innerHTML = '&#9650;'; // ‚ñ≤ up arrow
          pin.title = 'Move to #1 (Next Up)';
          pin.onclick = (e) => {
            e.stopPropagation();
            updateItem(item.movie_key, { sortOrder: 1 });
          };
          poster.appendChild(pin);
        }

        // Remove button (logged-in only; pinned items only removable by admin)
        if (canAct() && (!isPinned || isAdmin())) {
          const rm = document.createElement('button');
          rm.className = 'queue-remove';
          rm.innerHTML = '&times;';
          rm.title = 'Remove';
          rm.onclick = (e) => { e.stopPropagation(); removeFromQueue(item.movie_key, item.title); };
          poster.appendChild(rm);
        }

        card.appendChild(poster);

        // Info area
        const info = document.createElement('div');
        info.className = 'queue-info';

        // Title + NEW badge
        const titleRow = document.createElement('div');
        titleRow.className = 'queue-title';
        titleRow.textContent = item.title;

        // "NEW" badge for items added within last 48 hours
        const hoursAgo = (Date.now() - new Date(item.added_at).getTime()) / 3600000;
        if (hoursAgo < 48) {
          const newBadge = document.createElement('span');
          newBadge.className = 'queue-new-badge';
          newBadge.textContent = 'NEW';
          titleRow.appendChild(newBadge);
        }
        info.appendChild(titleRow);

        // Tags: assignment + priority + rewatch (read-only for visitors, pills for logged-in)
        const assignedTo = item.assigned_to;

        // Always show tag chips for visitors; logged-in users get pills below but still see rewatch tag
        if (!canAct()) {
          const tags = document.createElement('div');
          tags.className = 'card-tags';
          if (assignedTo === 'greg') { const t = document.createElement('span'); t.className = 'card-tag greg'; t.textContent = 'For Greg'; tags.appendChild(t); }
          else if (assignedTo === 'peer') { const t = document.createElement('span'); t.className = 'card-tag peer'; t.textContent = 'For Peer'; tags.appendChild(t); }
          else if (assignedTo === 'both') { const t = document.createElement('span'); t.className = 'card-tag both'; t.textContent = 'For Both'; tags.appendChild(t); }
          if (priority === 'high') { const t = document.createElement('span'); t.className = 'card-tag high'; t.textContent = 'High'; tags.appendChild(t); }
          else if (priority === 'low') { const t = document.createElement('span'); t.className = 'card-tag low'; t.textContent = 'Low'; tags.appendChild(t); }
          if (item.is_rewatch) { const t = document.createElement('span'); t.className = 'card-tag rewatch'; t.textContent = 'Rewatch'; tags.appendChild(t); }
          if (tags.childElementCount > 0) info.appendChild(tags);
        } else if (item.is_rewatch) {
          // Logged-in view: show rewatch tag above pills
          const tags = document.createElement('div');
          tags.className = 'card-tags';
          const t = document.createElement('span'); t.className = 'card-tag rewatch'; t.textContent = 'Rewatch';
          tags.appendChild(t);
          info.appendChild(tags);
        }

        // Note
        if (item.note) {
          const note = document.createElement('div');
          note.className = 'queue-note';
          note.textContent = '\u201C' + item.note + '\u201D';
          info.appendChild(note);
        }

        // Suggested by
        const suggested = document.createElement('div');
        suggested.className = 'queue-suggested';
        suggested.textContent = 'added by ' + (item.suggested_by || 'visitor');
        info.appendChild(suggested);

        // Reviewer power tools: pill toggles + watched button
        // Pinned items: only admin gets controls; non-admin sees static tags instead
        if (canAct() && isPinned && !isAdmin()) {
          // Non-admin viewing a pinned item: show static tags (like visitor view)
          const tags = document.createElement('div');
          tags.className = 'card-tags';
          if (assignedTo === 'greg') { const t = document.createElement('span'); t.className = 'card-tag greg'; t.textContent = 'For Greg'; tags.appendChild(t); }
          else if (assignedTo === 'peer') { const t = document.createElement('span'); t.className = 'card-tag peer'; t.textContent = 'For Peer'; tags.appendChild(t); }
          else if (assignedTo === 'both') { const t = document.createElement('span'); t.className = 'card-tag both'; t.textContent = 'For Both'; tags.appendChild(t); }
          if (priority === 'high') { const t = document.createElement('span'); t.className = 'card-tag high'; t.textContent = 'High'; tags.appendChild(t); }
          if (item.is_rewatch) { const t = document.createElement('span'); t.className = 'card-tag rewatch'; t.textContent = 'Rewatch'; tags.appendChild(t); }
          if (tags.childElementCount > 0) info.appendChild(tags);
        } else if (canAct()) {
          const controls = document.createElement('div');
          controls.className = 'pill-controls';

          // Priority pill group
          const priGroup = document.createElement('div');
          priGroup.className = 'pill-group';
          ['high', 'medium', 'low'].forEach(v => {
            const btn = document.createElement('button');
            btn.className = 'pill-btn' + (v === priority ? ' active' : '');
            btn.textContent = v === 'medium' ? 'Norm' : v.charAt(0).toUpperCase() + v.slice(1);
            btn.onclick = (e) => {
              e.stopPropagation();
              updateItem(item.movie_key, { priority: v });
            };
            priGroup.appendChild(btn);
          });
          controls.appendChild(priGroup);

          // Assignment pill group
          const asnGroup = document.createElement('div');
          asnGroup.className = 'pill-group';
          [['greg', 'Greg'], ['peer', 'Peer'], ['both', 'Both']].forEach(([v, label]) => {
            const btn = document.createElement('button');
            btn.className = 'pill-btn' + (v === (assignedTo || '') ? ' active' : '');
            btn.textContent = label;
            btn.onclick = (e) => {
              e.stopPropagation();
              updateItem(item.movie_key, { assignedTo: v });
            };
            asnGroup.appendChild(btn);
          });
          controls.appendChild(asnGroup);

          info.appendChild(controls);

          // "Watched" button
          const watchedBtn = document.createElement('button');
          watchedBtn.className = 'queue-watched-btn';
          watchedBtn.textContent = 'Watched';
          watchedBtn.onclick = (e) => {
            e.stopPropagation();
            showConfirmModal(
              'Move \u201C' + escHtml(item.title) + '\u201D to The Ledger?',
              'This film will be removed from the queue and added to the main page.',
              () => markAsWatched(item)
            );
          };
          info.appendChild(watchedBtn);
        }

        card.appendChild(info);

        // Click poster to open enlarged detail overlay
        poster.style.cursor = 'pointer';
        poster.addEventListener('click', (e) => {
          if (e.target.closest('.queue-remove')) return;
          openFilmDetail(item);
        });

        grid.appendChild(card);
      });
    }

    // Recently watched
    if (watchedItems.length > 0) {
      watchedSection.style.display = '';
      watchedList.innerHTML = '';
      watchedItems.forEach(item => {
        const row = document.createElement('div');
        row.className = 'watched-item';
        row.innerHTML =
          '<span class="watched-item-check">&#10003;</span>' +
          '<span class="watched-item-title">' + escHtml(item.title) + '</span>' +
          '<span class="watched-item-date">' + (item.watched_at ? formatDate(item.watched_at) : '') + '</span>';
        watchedList.appendChild(row);
      });
    } else {
      watchedSection.style.display = 'none';
    }
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Search ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const searchInput = document.getElementById('film-search');
  const searchResults = document.getElementById('search-results');
  let searchTimeout = null;

  searchInput.addEventListener('input', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(doSearch, 200);
  });

  searchInput.addEventListener('focus', () => {
    if (searchInput.value.trim().length >= 2) doSearch();
  });

  document.addEventListener('click', (e) => {
    if (!e.target.closest('.search-row')) {
      searchResults.classList.remove('visible');
    }
  });

  function buildResultRow(film, queueKeys) {
    const inQueue = queueKeys.has(film.movie_key);
    const row = document.createElement('div');
    row.className = 'search-result' + (inQueue ? ' in-queue' : '');

    // Poster thumbnail
    if (film.poster_url) {
      const img = document.createElement('img');
      img.className = 'search-result-poster';
      img.src = film.poster_url;
      img.alt = '';
      img.loading = 'lazy';
      row.appendChild(img);
    } else {
      const ph = document.createElement('div');
      ph.className = 'search-result-poster';
      ph.style.background = 'var(--border)';
      row.appendChild(ph);
    }

    // Info
    const info = document.createElement('div');
    info.className = 'search-result-info';
    const t = document.createElement('div');
    t.className = 'search-result-title';
    t.textContent = film.title + (film.year ? ' (' + film.year + ')' : '');
    info.appendChild(t);

    if (film.source) {
      const meta = document.createElement('div');
      meta.className = 'search-result-meta';
      meta.textContent = film.source;
      info.appendChild(meta);
    }

    row.appendChild(info);

    // Add buttons
    const actions = document.createElement('div');
    actions.className = 'search-result-actions';
    if (inQueue) {
      const tag = document.createElement('span');
      tag.className = 'search-result-add';
      tag.textContent = 'Added';
      tag.style.cursor = 'default';
      tag.style.color = 'var(--text-muted)';
      tag.style.borderColor = 'var(--border)';
      actions.appendChild(tag);
    } else if (canAct()) {
      // Logged-in users: G / P / Both assignment buttons
      [['greg', 'G'], ['peer', 'P'], ['both', 'Both']].forEach(([who, label]) => {
        const btn = document.createElement('button');
        btn.className = 'search-result-add ' + (who === 'both' ? '' : who);
        btn.textContent = '+ ' + label;
        btn.title = who === 'both' ? 'For both' : 'For ' + who;
        btn.onclick = (e) => { e.stopPropagation(); addToQueue(film, who); };
        actions.appendChild(btn);
      });
    } else {
      // Visitors: single "+ Queue" button (defaults to "both")
      const btn = document.createElement('button');
      btn.className = 'search-result-add';
      btn.textContent = '+ Queue';
      btn.onclick = (e) => { e.stopPropagation(); addToQueue(film, 'both'); };
      actions.appendChild(btn);
    }
    row.appendChild(actions);
    return row;
  }

  function doSearch() {
    const q = searchInput.value.trim().toLowerCase();
    if (q.length < 2) { searchResults.classList.remove('visible'); return; }

    const queueKeys = new Set(queueItems.map(i => i.movie_key));

    // Local results from Greg's library
    const localMatches = allGregFilms
      .filter(f => f.title.toLowerCase().includes(q))
      .slice(0, 8)
      .map(f => ({ ...f, source: 'In Greg\u2019s library' }));

    searchResults.innerHTML = '';

    if (localMatches.length > 0) {
      const header = document.createElement('div');
      header.className = 'search-divider';
      header.textContent = 'Greg\u2019s Library';
      searchResults.appendChild(header);

      localMatches.forEach(film => {
        searchResults.appendChild(buildResultRow(film, queueKeys));
      });
    }

    // Always show "Search Letterboxd" button for external search
    const extBtn = document.createElement('button');
    extBtn.className = 'search-external-btn';
    extBtn.textContent = '\uD83C\uDF10 Search all movies for \u201C' + escHtml(searchInput.value.trim()) + '\u201D';
    extBtn.onclick = () => searchExternal(searchInput.value.trim());
    searchResults.appendChild(extBtn);

    searchResults.classList.add('visible');
  }

  async function searchExternal(query) {
    const queueKeys = new Set(queueItems.map(i => i.movie_key));
    const localKeys = new Set(allGregFilms.map(f => f.movie_key));

    const extBtns = searchResults.querySelectorAll('.search-external-btn');
    extBtns.forEach(b => { b.textContent = 'Searching...'; b.disabled = true; });

    try {
      const res = await fetch(SEARCH_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query })
      });
      const data = await res.json();
      const results = (data.results || []).filter(r => !localKeys.has(r.movieKey));

      extBtns.forEach(b => b.remove());

      if (results.length > 0) {
        const header = document.createElement('div');
        header.className = 'search-divider';
        header.textContent = 'Search Results';
        searchResults.appendChild(header);

        results.forEach(r => {
          const film = {
            movie_key: r.movieKey,
            title: r.title,
            year: r.year || '',
            poster_url: r.posterUrl,
            source: r.year ? r.year : 'TMDB',
          };
          searchResults.appendChild(buildResultRow(film, queueKeys));
        });
      } else {
        const noRes = document.createElement('div');
        noRes.className = 'search-no-results';
        noRes.textContent = 'No additional results found';
        searchResults.appendChild(noRes);
      }
    } catch (e) {
      extBtns.forEach(b => { b.textContent = 'Search failed \u2014 try again'; b.disabled = false; });
    }
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Actions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function addToQueue(film, assignedTo) {
    try {
      const headers = { 'Content-Type': 'application/json' };
      // Only include auth if logged in
      if (authToken) headers['Authorization'] = 'Bearer ' + authToken;

      const res = await fetch(ACTIONS_URL, {
        method: 'POST',
        headers,
        body: JSON.stringify({
          action: 'watchlist_add',
          movieKey: film.movie_key,
          data: {
            title: film.title,
            posterUrl: film.poster_url || null,
            note: null,
            assignedTo: assignedTo,
          }
        })
      });
      if (!res.ok) throw new Error('Failed');
      showToast('Added "' + film.title + '"');
      searchInput.value = '';
      searchResults.classList.remove('visible');
      await fetchWatchlist();
      render();
    } catch (e) {
      showToast('Error adding film');
    }
  }

  async function updateItem(movieKey, updates) {
    try {
      const res = await fetch(ACTIONS_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + authToken,
        },
        body: JSON.stringify({
          action: 'watchlist_update',
          movieKey,
          data: updates
        })
      });
      if (!res.ok) throw new Error('Failed');
      await fetchWatchlist();
      render();
    } catch (e) {
      showToast('Error updating');
    }
  }

  async function removeFromQueue(movieKey, title) {
    try {
      const res = await fetch(ACTIONS_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + authToken,
        },
        body: JSON.stringify({ action: 'watchlist_remove', movieKey, data: {} })
      });
      if (!res.ok) throw new Error('Failed');
      showToast('Removed \u201C' + title + '\u201D');
      await fetchWatchlist();
      render();
    } catch (e) {
      showToast('Error removing film');
    }
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Mark as Watched ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function markAsWatched(item) {
    try {
      const res = await fetch(ACTIONS_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + authToken,
        },
        body: JSON.stringify({
          action: 'watchlist_watched',
          movieKey: item.movie_key,
          data: { title: item.title, posterUrl: item.poster_url || null }
        })
      });
      if (!res.ok) throw new Error('Failed');
      showToast('Moved to The Ledger');
      await fetchWatchlist();
      render();
    } catch (e) {
      showToast('Error moving film');
    }
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Confirmation Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function showConfirmModal(title, subtitle, onConfirm) {
    // Remove any existing modal
    const existing = document.getElementById('confirm-modal');
    if (existing) existing.remove();

    const overlay = document.createElement('div');
    overlay.className = 'confirm-overlay';
    overlay.id = 'confirm-modal';

    overlay.innerHTML = `
      <div class="confirm-panel">
        <div class="confirm-title">${title}</div>
        <div class="confirm-subtitle">${subtitle}</div>
        <div class="confirm-actions">
          <button class="confirm-btn secondary" id="confirm-cancel">Cancel</button>
          <button class="confirm-btn primary" id="confirm-ok">Confirm</button>
        </div>
      </div>
    `;

    document.body.appendChild(overlay);

    function dismiss() { overlay.remove(); }

    document.getElementById('confirm-cancel').onclick = dismiss;
    document.getElementById('confirm-ok').onclick = () => {
      dismiss();
      onConfirm();
    };
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) dismiss();
    });

    // Escape key
    function onKey(e) {
      if (e.key === 'Escape') { dismiss(); document.removeEventListener('keydown', onKey); }
    }
    document.addEventListener('keydown', onKey);
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Realtime ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function subscribeRealtime() {
    supabaseClient
      .channel('watchlist-changes')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'watchlist' }, async () => {
        await fetchWatchlist();
        render();
      })
      .subscribe();
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function escHtml(str) {
    const d = document.createElement('div');
    d.textContent = str || '';
    return d.innerHTML;
  }

  function formatDate(iso) {
    if (!iso) return '';
    const d = new Date(iso);
    const now = new Date();
    const diff = now - d;
    if (diff < 60000) return 'just now';
    if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
    if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
    if (diff < 604800000) return Math.floor(diff / 86400000) + 'd ago';
    return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Filter clicks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.querySelectorAll('.filter-chip').forEach(chip => {
    chip.addEventListener('click', () => {
      activeFilter = chip.dataset.filter;
      render();
    });
  });

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Pick for Us ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.getElementById('pick-btn').addEventListener('click', () => {
    if (queueItems.length === 0) { alert('No films in the queue!'); return; }
    pickRandom();
  });

  function pickRandom() {
    // Weight by priority: high = 3, medium = 2, low = 1
    const weights = queueItems.map(item => {
      if (item.priority === 'high') return 3;
      if (item.priority === 'low') return 1;
      return 2;
    });
    const totalWeight = weights.reduce((a, b) => a + b, 0);
    let rand = Math.random() * totalWeight;
    let picked = queueItems[0];
    for (let i = 0; i < queueItems.length; i++) {
      rand -= weights[i];
      if (rand <= 0) { picked = queueItems[i]; break; }
    }
    showPickOverlay(picked);
  }

  function showPickOverlay(item) {
    // Remove existing overlay if any
    const existing = document.getElementById('pick-overlay');
    if (existing) existing.remove();

    const overlay = document.createElement('div');
    overlay.className = 'pick-overlay';
    overlay.id = 'pick-overlay';

    const posterHtml = item.poster_url
      ? `<img class="pick-poster" src="${item.poster_url}" alt="${escHtml(item.title)}" onerror="this.outerHTML='<div class=\\'pick-poster-fallback\\'>D5</div>'">`
      : `<div class="pick-poster-fallback">D5</div>`;

    const subtitle = item.suggested_by ? `Queued by ${item.suggested_by}` : '';

    overlay.innerHTML = `
      <div class="pick-card">
        ${posterHtml}
        <div class="pick-title">${escHtml(item.title)}</div>
        ${subtitle ? `<div class="pick-subtitle">${subtitle}</div>` : ''}
        <div class="pick-actions">
          <button class="pick-again" id="pick-again-btn">Another Choice</button>
          <button class="pick-close" id="pick-close-btn">Accept</button>
        </div>
      </div>
    `;

    document.body.appendChild(overlay);
    document.body.style.overflow = 'hidden';

    document.getElementById('pick-again-btn').onclick = () => {
      overlay.remove();
      pickRandom();
    };
    document.getElementById('pick-close-btn').onclick = () => {
      overlay.remove();
      document.body.style.overflow = '';
    };
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) {
        overlay.remove();
        document.body.style.overflow = '';
      }
    });
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Film Detail Overlay ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function openFilmDetail(item) {
    closeFilmDetail(); // close any existing

    const overlay = document.createElement('div');
    overlay.className = 'film-detail-overlay';
    overlay.id = 'film-detail-overlay';

    const card = document.createElement('div');
    card.className = 'film-detail-card';

    // Poster side
    const posterCol = document.createElement('div');
    posterCol.className = 'fd-poster';
    if (item.poster_url) {
      const img = document.createElement('img');
      img.src = item.poster_url;
      img.alt = item.title;
      img.onerror = function() {
        this.outerHTML = '<div class="fd-poster-fallback">D5</div>';
      };
      posterCol.appendChild(img);
    } else {
      const fb = document.createElement('div');
      fb.className = 'fd-poster-fallback';
      fb.textContent = 'D5';
      posterCol.appendChild(fb);
    }
    card.appendChild(posterCol);

    // Info side
    const infoCol = document.createElement('div');
    infoCol.className = 'fd-info';
    infoCol.innerHTML = '<div class="fd-loading">Loading\u2026</div>';
    card.appendChild(infoCol);

    overlay.appendChild(card);
    document.body.appendChild(overlay);
    document.body.style.overflow = 'hidden';

    // Dismiss on click outside card
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) closeFilmDetail();
    });

    // Fetch TMDB data
    fetchTMDBDetails(item.title).then(data => {
      if (data) {
        const genreHtml = data.genres.map(g => '<span class="fd-genre">' + g + '</span>').join('');
        const metaParts = [data.director, data.runtime, data.year].filter(Boolean);
        const castLine = data.cast.length ? data.cast.join(', ') : '';
        infoCol.innerHTML =
          '<div class="fd-title">' + escHtml(data.title) + '</div>' +
          '<div class="fd-meta">' + metaParts.join(' \u2022 ') + '</div>' +
          (castLine ? '<div class="fd-cast">' + castLine + '</div>' : '') +
          (genreHtml ? '<div class="fd-genres">' + genreHtml + '</div>' : '') +
          (data.tagline ? '<div class="fd-tagline">\u201C' + escHtml(data.tagline) + '\u201D</div>' : '') +
          (data.overview ? '<div class="fd-synopsis">' + escHtml(data.overview) + '</div>' : '');
      } else {
        infoCol.innerHTML = '<div class="fd-loading">No details found</div>';
      }
    });
  }

  function closeFilmDetail() {
    const el = document.getElementById('film-detail-overlay');
    if (el) { el.remove(); document.body.style.overflow = ''; }
  }

  // Escape key: close film detail overlay
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeFilmDetail();
  });

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function init() {
    loadSession();

    // Load data (Greg films for search + watchlist)
    const [_, __] = await Promise.all([
      fetchGregFilms().then(f => allGregFilms = f),
      fetchWatchlist()
    ]);

    render();
    subscribeRealtime();
  }

  init();

  // ‚îÄ‚îÄ‚îÄ Scroll-triggered card entrance animations ‚îÄ‚îÄ‚îÄ
  const queueObserver = new IntersectionObserver((entries) => {
    entries.forEach((entry, i) => {
      if (entry.isIntersecting) {
        setTimeout(() => entry.target.classList.add('visible'), i * 60);
        queueObserver.unobserve(entry.target);
      }
    });
  }, { threshold: 0.08, rootMargin: '0px 0px -40px 0px' });

  const queueGrid = document.getElementById('queue-grid');
  if (queueGrid) {
    new MutationObserver(() => {
      queueGrid.querySelectorAll('.queue-card:not(.visible)').forEach(c => queueObserver.observe(c));
    }).observe(queueGrid, { childList: true, subtree: true });
  }

  // ‚îÄ‚îÄ‚îÄ Register Service Worker ‚îÄ‚îÄ‚îÄ
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/sw.js').catch(() => {});
  }
</script>

</body>
</html>
