<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DUFIVE | The Ledger</title>

  <!-- Open Graph / Social -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://dufive.com/" />
  <meta property="og:title" content="DUFIVE | The Ledger" />
  <meta property="og:description" content="Unanimously Divided. A collaborative film review ledger." />
  <meta property="og:image" content="https://dufive.com/og-image.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="DUFIVE | The Ledger" />
  <meta name="twitter:description" content="Unanimously Divided." />
  <meta name="twitter:image" content="https://dufive.com/og-image.png" />
  <meta name="description" content="Unanimously Divided. A collaborative film review ledger by Greg and Peer." />
  <meta name="theme-color" content="#0a0a0a" />
  <link rel="manifest" href="/manifest.json" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="DUFIVE" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&family=Instrument+Sans:wght@400;500;600;700&family=Lora:wght@400;500;600;700&family=Playfair+Display:ital,wght@0,400;0,500;0,600;0,700;1,400;1,600&display=swap" rel="stylesheet">

  <style>
    /* ───── Theme Variables — Criterion Editorial ───── */
    :root,
    [data-theme="light"] {
      --bg: #f5f0eb;
      --bg-secondary: #ece7e1;
      --card-bg: transparent;
      --text: #1a1a1a;
      --text-secondary: #5c5c5c;
      --text-muted: #8c8580;
      --accent: #1a1a1a;
      --accent-hover: #000000;
      --border: #d4cfc9;
      --border-light: #e8e3dd;
      --greg: #c2410c;
      --greg-bg: rgba(194, 65, 12, 0.08);
      --peer: #1e40af;
      --peer-bg: rgba(30, 64, 175, 0.08);
      --shadow: none;
      --shadow-lg: none;
      --radius: 0px;
      --transition: all 0.15s ease;
      --skeleton-from: #e0dbd5;
      --skeleton-to: #ece7e1;
      --overlay-bg: rgba(0, 0, 0, 0.7);
      --badge-bg: #c2410c;
      --success: #15803d;
      --mono: 'IBM Plex Mono', monospace;
    }

    [data-theme="dark"] {
      --bg: #0f0f0f;
      --bg-secondary: #181816;
      --card-bg: transparent;
      --text: #e8e4df;
      --text-secondary: #9c9890;
      --text-muted: #6b6660;
      --accent: #e8e4df;
      --accent-hover: #ffffff;
      --border: #2a2824;
      --border-light: #1f1d1a;
      --greg: #fb923c;
      --greg-bg: rgba(251, 146, 60, 0.1);
      --peer: #93b4f5;
      --peer-bg: rgba(147, 180, 245, 0.1);
      --shadow: none;
      --shadow-lg: none;
      --skeleton-from: #2a2824;
      --skeleton-to: #353330;
      --overlay-bg: rgba(0, 0, 0, 0.85);
      --badge-bg: #fb923c;
      --success: #22c55e;
    }

    /* ───── Reset & Base ───── */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { overflow-x: hidden; }

    body {
      font-family: 'Instrument Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      line-height: 1.6;
      transition: background 0.3s ease, color 0.3s ease;
      overscroll-behavior-y: contain;
    }

    .container { max-width: 1400px; margin: 0 auto; padding: 0 32px; }

    /* ───── Toast Notifications ───── */
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 10000;
      display: flex;
      flex-direction: column;
      gap: 8px;
      pointer-events: none;
    }

    .toast {
      background: var(--text);
      color: var(--bg);
      border: none;
      padding: 12px 20px;
      border-radius: 0;
      font-size: 0.8rem;
      font-weight: 500;
      letter-spacing: 0.02em;
      display: flex;
      align-items: center;
      gap: 10px;
      pointer-events: auto;
      animation: toastIn 0.3s ease forwards;
      max-width: 360px;
    }
    .toast.leaving { animation: toastOut 0.3s ease forwards; }
    .toast.success { border-left: 3px solid var(--success); }
    .toast.error { border-left: 3px solid #dc2626; }
    .toast.info { border-left: 3px solid var(--text-muted); }

    .toast-icon { font-size: 1.125rem; flex-shrink: 0; }

    @keyframes toastIn {
      from { opacity: 0; transform: translateX(40px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes toastOut {
      from { opacity: 1; transform: translateX(0); }
      to { opacity: 0; transform: translateX(40px); }
    }

    /* ───── Pull to Refresh ───── */
    .pull-indicator {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%) translateY(-60px);
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 0;
      padding: 10px 20px;
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--text-secondary);
      box-shadow: none;
      z-index: 9000;
      transition: transform 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .pull-indicator.visible { transform: translateX(-50%) translateY(0); }
    .pull-indicator .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ───── Scroll to Top ───── */
    .scroll-top-btn {
      position: fixed;
      bottom: 32px;
      right: 32px;
      width: 40px;
      height: 40px;
      border-radius: 0;
      background: var(--text);
      color: var(--bg);
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      z-index: 100;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.3s ease, transform 0.3s ease;
      pointer-events: none;
    }
    .scroll-top-btn.visible {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }
    .scroll-top-btn:hover { opacity: 0.8; }
    .scroll-top-btn:active { opacity: 0.6; }

    /* ───── Navigation — Editorial ───── */
    nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 28px 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 32px;
    }

    .brand {
      font-weight: 400;
      font-size: 0.55rem;
      line-height: 1;
      text-decoration: none;
      color: var(--text-muted);
      letter-spacing: 0.35em;
      text-transform: uppercase;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .brand-monogram {
      width: 80px; height: 80px; flex-shrink: 0;
      border: 4px solid var(--text);
      border-radius: 50%;
      position: relative;
      overflow: hidden;
      color: var(--text);
    }
    .brand-monogram .d, .brand-monogram .five {
      position: absolute;
      font-family: 'Lora', serif;
      font-weight: 700;
      font-size: 3.95rem;
      line-height: 1;
      color: var(--text);
    }
    .brand-monogram .d { top: 0px; left: -1px; }
    .brand-monogram .five { top: 12px; left: 36px; }

    .nav-controls { display: flex; gap: 16px; align-items: center; }

    /* Hamburger button — hidden on desktop, shown on mobile */
    .hamburger {
      display: none; background: none; border: 1px solid var(--border);
      border-radius: 0; padding: 6px 8px; cursor: pointer;
      font-size: 1.2rem; line-height: 1; color: var(--text);
      transition: var(--transition);
    }
    .hamburger:hover { border-color: var(--text); }

    .nav-link {
      font-size: 0.7rem;
      font-weight: 500;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--text-muted);
      text-decoration: none;
      padding: 4px 0;
      border-radius: 0;
      transition: var(--transition);
      white-space: nowrap;
    }
    .nav-link:hover { color: var(--text); text-decoration: underline; text-underline-offset: 4px; background: none; }
    .nav-link.active { color: var(--text); text-decoration: underline; text-underline-offset: 4px; }

    .theme-toggle {
      cursor: pointer;
      padding: 4px;
      border-radius: 0;
      font-size: 1rem;
      transition: var(--transition);
      user-select: none;
      border: none;
      background: none;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .theme-toggle:hover { color: var(--text); }

    .auth-controls { display: flex; gap: 12px; align-items: center; }

    /* ───── Notification Bell ───── */
    .sync-btn {
      display: none;
      background: none;
      border: 1px solid var(--border-light);
      border-radius: 0;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 0.8125rem;
      color: var(--text-secondary);
      transition: var(--transition);
      white-space: nowrap;
    }
    .sync-btn.visible { display: inline-flex; align-items: center; gap: 6px; }
    .sync-btn:hover { background: var(--border-light); color: var(--text); }
    .sync-btn.syncing { opacity: 0.6; pointer-events: none; }
    .sync-btn .sync-icon { display: inline-block; transition: transform 0.3s; }
    .sync-btn.syncing .sync-icon { animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .notif-wrapper {
      position: relative;
      display: none;  /* hidden until logged in */
    }
    .notif-wrapper.visible { display: block; }
    .notif-bell {
      cursor: pointer;
      font-size: 1.25rem;
      padding: 6px 8px;
      border-radius: 0;
      transition: var(--transition);
      position: relative;
      user-select: none;
      line-height: 1;
    }
    .notif-bell:hover { background: var(--border-light); }
    .notif-badge {
      position: absolute;
      top: 2px;
      right: 2px;
      min-width: 16px;
      height: 16px;
      border-radius: 0;
      background: #dc2626;
      color: #fff;
      font-size: 0.6rem;
      font-weight: 800;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
      line-height: 1;
      border: 2px solid var(--bg);
    }
    .notif-badge.has-count { display: flex; }

    .notif-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      width: 320px;
      max-height: 400px;
      overflow-y: auto;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 0;
      box-shadow: none;
      z-index: 1000;
      display: none;
      animation: dropIn 0.2s ease;
    }
    .notif-dropdown.open { display: block; }
    @keyframes dropIn {
      from { opacity: 0; transform: translateY(-8px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .notif-header {
      padding: 12px 16px;
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--text-secondary);
      border-bottom: 1px solid var(--border);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .notif-item {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-light);
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }
    .notif-item:last-child { border-bottom: none; }
    .notif-item:hover { background: var(--border-light); }
    .notif-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Lora', serif;
      font-size: 0.7rem;
      font-weight: 700;
      color: var(--text);
      background: transparent;
      border: 1.5px solid var(--text);
      flex-shrink: 0;
    }
    .notif-avatar.greg { background: transparent; }
    .notif-avatar.peer { background: transparent; }
    .notif-text {
      font-size: 0.8rem;
      color: var(--text);
      line-height: 1.4;
      flex: 1;
    }
    .notif-text strong { font-weight: 700; }
    .notif-time {
      font-size: 0.7rem;
      color: var(--text-muted);
      margin-top: 2px;
    }
    .notif-empty {
      padding: 24px 16px;
      text-align: center;
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .login-trigger {
      cursor: pointer;
      font-size: 0.8125rem;
      font-weight: 600;
      letter-spacing: 0.03em;
      color: var(--text-secondary);
      transition: var(--transition);
      user-select: none;
      padding: 8px 16px;
      border-radius: 0;
      white-space: nowrap;
    }
    .login-trigger:hover { color: var(--accent); background: var(--border-light); }
    .login-trigger.greg-active { color: var(--greg); background: var(--greg-bg); }
    .login-trigger.peer-active { color: var(--peer); background: var(--peer-bg); }
    .login-trigger.admin-active { color: var(--text-secondary); background: var(--border-light); }

    .logout-btn {
      cursor: pointer;
      font-size: 0.8125rem;
      font-weight: 600;
      color: var(--text-muted);
      transition: var(--transition);
      display: none;
      padding: 8px 16px;
      border-radius: 0;
      white-space: nowrap;
    }
    .logout-btn.visible { display: block; }
    .logout-btn:hover { color: var(--text); background: var(--border-light); }

    /* ───── Header ───── */
    header { margin-bottom: 24px; }

    .page-title {
      font-family: 'Playfair Display', serif;
      font-size: clamp(3rem, 8vw, 5.5rem);
      line-height: 1.05;
      margin-bottom: 16px;
      font-weight: 400;
      letter-spacing: -0.03em;
    }

    .tagline {
      font-size: 0.85rem;
      color: var(--text-muted);
      letter-spacing: 0.08em;
      font-weight: 400;
      text-transform: uppercase;
    }

    /* ───── Stats Data Strip ───── */
    .stats-bar {
      display: flex;
      align-items: baseline;
      flex-wrap: wrap;
      gap: 0;
      margin-bottom: 20px;
      padding: 0;
      opacity: 0;
      transform: translateY(10px);
      transition: opacity 0.4s ease, transform 0.4s ease;
    }
    .stats-bar.visible { opacity: 1; transform: translateY(0); }

    .stat-card {
      display: inline-flex;
      align-items: baseline;
      gap: 6px;
      padding: 0 16px;
      border-right: 1px solid var(--border);
      background: none;
      border-radius: 0;
      box-shadow: none;
      white-space: nowrap;
    }
    .stat-card:first-child { padding-left: 0; }
    .stat-card:last-child { border-right: none; cursor: pointer; }
    .stat-card:hover { transform: none; }

    .stat-value {
      font-family: var(--mono);
      font-size: 0.85rem;
      font-weight: 600;
      letter-spacing: -0.01em;
      line-height: 1;
    }
    .stat-card:last-child .stat-value {
      font-size: 0.8rem;
      font-weight: 600;
    }
    .stat-card:last-child:hover .stat-value {
      text-decoration: underline;
      text-underline-offset: 3px;
    }
    .stat-value.greg-color { color: var(--greg); }
    .stat-value.peer-color { color: var(--peer); }
    .stat-value.accent-color { color: var(--text); }

    .stat-label {
      font-size: 0.65rem;
      font-weight: 500;
      color: var(--text-muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    /* ───── Pull Quote — Most Debated ───── */
    .pull-quote {
      margin-bottom: 40px;
      padding: 24px 0;
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
      text-align: center;
      display: none;
      cursor: pointer;
    }
    .pull-quote.visible { display: block; }
    .pull-quote-label {
      font-family: var(--mono);
      font-size: 0.6rem;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 10px;
    }
    .pull-quote-title {
      font-family: 'Playfair Display', serif;
      font-size: clamp(1.5rem, 4vw, 2.5rem);
      font-weight: 400;
      font-style: italic;
      line-height: 1.15;
      color: var(--text);
      letter-spacing: -0.02em;
    }
    .pull-quote-gap {
      font-family: var(--mono);
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-top: 10px;
      letter-spacing: 0.04em;
    }
    .pull-quote:hover .pull-quote-title {
      text-decoration: underline;
      text-underline-offset: 6px;
      text-decoration-thickness: 1px;
    }

    /* ───── Toolbar ───── */
    .toolbar {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .search-wrapper {
      flex: 0 1 320px;
      min-width: 180px;
      position: relative;
    }

    .search-input {
      width: 100%;
      padding: 12px 0;
      border: none;
      border-bottom: 1px solid var(--border);
      border-radius: 0;
      font-family: inherit;
      font-size: 0.9375rem;
      background: transparent;
      color: var(--text);
      transition: var(--transition);
    }
    .search-input:focus {
      outline: none;
      border-bottom-color: var(--text);
    }
    .search-input::placeholder { color: var(--text-muted); letter-spacing: 0.02em; }

    .search-clear {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      font-size: 0.875rem;
      color: var(--text-muted);
      padding: 4px 6px;
      border-radius: 0;
      display: none;
      line-height: 1;
      transition: var(--transition);
    }
    .search-clear:hover { color: var(--text); background: var(--border-light); }
    .search-clear.visible { display: block; }

    .sort-select {
      padding: 10px 28px 10px 0;
      border: none;
      border-bottom: 2px solid var(--border);
      border-radius: 0;
      font-family: inherit;
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      background: transparent;
      color: var(--text);
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' viewBox='0 0 24 24' fill='none' stroke='%235c5c5c' stroke-width='2.5'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 4px center;
      transition: var(--transition);
      white-space: nowrap;
    }
    .sort-select:focus { outline: none; border-bottom-color: var(--text); }

    /* ───── Log Film Button ───── */
    .log-film-btn {
      font-family: var(--mono);
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 8px 14px;
      border: 1px solid var(--text);
      background: transparent;
      color: var(--text);
      cursor: pointer;
      white-space: nowrap;
      transition: var(--transition);
    }
    .log-film-btn:hover { background: var(--text); color: var(--bg); }

    /* ───── Backup Button (admin only) ───── */
    .backup-btn {
      font-family: var(--mono);
      font-size: 0.6rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.08em;
      padding: 8px 12px;
      border: 1px solid var(--border); border-radius: 0;
      background: transparent; color: var(--text-muted);
      cursor: pointer; white-space: nowrap;
      transition: var(--transition);
    }
    .backup-btn:hover { border-color: var(--text); color: var(--text); }
    .backup-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* ───── Log Film Modal ───── */
    .log-film-overlay {
      position: fixed; inset: 0;
      background: var(--overlay-bg);
      backdrop-filter: blur(4px);
      display: none; align-items: flex-start; justify-content: center;
      z-index: 10000;
      padding: 80px 16px 16px;
      animation: fadeIn 0.2s ease;
    }
    .log-film-overlay.visible { display: flex; }
    .log-film-panel {
      background: var(--bg);
      border: 1px solid var(--border);
      max-width: 480px; width: 100%;
      padding: 28px;
      animation: slideUp 0.3s cubic-bezier(0.4,0,0.2,1);
      max-height: 80vh;
      display: flex; flex-direction: column;
    }
    .log-film-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.25rem; font-weight: 400;
      letter-spacing: -0.02em; color: var(--text);
      margin-bottom: 16px;
    }
    .log-film-search {
      width: 100%; padding: 10px 12px;
      border: 2px solid var(--text); border-radius: 0;
      font-family: inherit; font-size: 0.875rem;
      background: transparent; color: var(--text);
    }
    .log-film-search:focus { outline: none; }
    .log-film-search::placeholder { color: var(--text-muted); }
    .log-film-results {
      margin-top: 16px;
      overflow-y: auto;
      flex: 1;
      display: flex; flex-direction: column; gap: 0;
    }
    .log-film-row {
      display: flex; align-items: center; gap: 12px;
      padding: 10px 8px;
      border-bottom: 1px solid var(--border-light);
      cursor: pointer;
      transition: background 0.15s;
    }
    .log-film-row:hover { background: var(--border-light); }
    .log-film-row:last-child { border-bottom: none; }
    .log-film-poster {
      width: 36px; height: 54px;
      object-fit: cover;
      background: var(--border-light);
      flex-shrink: 0;
      border: 1px solid var(--border);
    }
    .log-film-poster-empty {
      width: 36px; height: 54px;
      background: var(--border-light);
      flex-shrink: 0;
      border: 1px solid var(--border);
      display: flex; align-items: center; justify-content: center;
      font-size: 0.5rem; color: var(--text-muted);
    }
    .log-film-info { flex: 1; min-width: 0; }
    .log-film-info-title {
      font-family: 'Playfair Display', serif;
      font-size: 0.85rem; font-weight: 700;
      color: var(--text);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .log-film-info-year {
      font-family: var(--mono);
      font-size: 0.65rem;
      color: var(--text-muted);
      letter-spacing: 0.04em;
    }
    .log-film-hint {
      font-family: var(--mono);
      font-size: 0.65rem;
      color: var(--text-muted);
      text-align: center;
      padding: 24px 0;
      letter-spacing: 0.04em;
    }

    /* ───── Delete Film Button ───── */
    .delete-film-btn {
      font-family: var(--mono);
      font-size: 0.55rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.06em;
      padding: 4px 8px; margin-top: 6px;
      border: 1px solid var(--border); border-radius: 0;
      background: transparent; color: var(--text-muted);
      cursor: pointer; transition: var(--transition);
      display: block; width: 100%; text-align: center;
      opacity: 0;
    }
    .entry:hover .delete-film-btn { opacity: 1; }
    .delete-film-btn:hover {
      border-color: #dc2626; color: #dc2626;
    }

    /* ───── Add to Queue Button ───── */
    .add-queue-btn {
      font-family: var(--mono);
      font-size: 0.55rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.06em;
      padding: 4px 8px; margin-top: 4px;
      border: 1px solid var(--border); border-radius: 0;
      background: transparent; color: var(--text-muted);
      cursor: pointer; transition: var(--transition);
      display: block; width: 100%; text-align: center;
      opacity: 0;
    }
    .entry:hover .add-queue-btn { opacity: 1; }
    .add-queue-btn:hover {
      border-color: var(--text); color: var(--text);
    }
    .add-queue-btn:disabled { opacity: 0.5; cursor: not-allowed; }

    /* ───── Confirmation Modal (shared) ───── */
    .confirm-overlay {
      position: fixed; inset: 0;
      background: var(--overlay-bg); backdrop-filter: blur(4px);
      display: flex; align-items: center; justify-content: center;
      z-index: 10001;
      animation: fadeIn 0.2s ease;
    }
    .confirm-panel {
      background: var(--bg); border: 1px solid var(--border);
      max-width: 380px; width: 90%; padding: 28px; text-align: center;
      animation: slideUp 0.3s cubic-bezier(0.4,0,0.2,1);
    }
    .confirm-title {
      font-family: 'Playfair Display', serif; font-size: 1.1rem; font-weight: 400;
      color: var(--text); margin-bottom: 8px; line-height: 1.3;
    }
    .confirm-subtitle {
      font-size: 0.8rem; color: var(--text-muted); margin-bottom: 20px; line-height: 1.4;
    }
    .confirm-actions { display: flex; gap: 10px; justify-content: center; }
    .confirm-btn {
      font-family: var(--mono); font-size: 0.65rem; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.08em;
      padding: 8px 20px; border-radius: 0; cursor: pointer; transition: var(--transition);
    }
    .confirm-btn.primary {
      background: var(--text); color: var(--bg); border: 1px solid var(--text);
    }
    .confirm-btn.primary:hover { opacity: 0.8; }
    .confirm-btn.secondary {
      background: transparent; color: var(--text); border: 1px solid var(--border);
    }
    .confirm-btn.secondary:hover { border-color: var(--text); }

    .filter-chips { display: flex; gap: 4px; flex-wrap: wrap; align-items: center; }

    .filter-chip {
      padding: 4px 0;
      border: none;
      border-radius: 0;
      font-size: 0.7rem;
      font-weight: 500;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--text-muted);
      cursor: pointer;
      transition: var(--transition);
      user-select: none;
      background: none;
      white-space: nowrap;
    }
    .filter-chip::before { content: '/'; margin-right: 4px; color: var(--border); }
    .filter-chip:first-child::before { content: none; }
    .filter-chip:hover { color: var(--text); }
    .filter-chip.active {
      color: var(--text);
      font-weight: 700;
      text-decoration: underline;
      text-underline-offset: 4px;
      text-decoration-thickness: 2px;
    }

    /* ───── Grid & Cards ───── */
    .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 40px 32px; }

    .entry {
      background: transparent;
      border-radius: 0;
      overflow: visible;
      box-shadow: none;
      transition: opacity 0.5s cubic-bezier(.4,0,.2,1), transform 0.5s cubic-bezier(.4,0,.2,1);
      border: none;
      opacity: 0;
      transform: translateY(24px);
      position: relative;
    }
    .entry.visible {
      opacity: 1;
      transform: translateY(0);
    }
    .entry:hover { transform: none; }
    .entry.no-animate {
      opacity: 1;
      transform: none;
      transition: none;
    }

    .new-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      background: var(--text);
      color: var(--bg);
      font-size: 0.55rem;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      padding: 3px 6px;
      border-radius: 0;
      z-index: 2;
    }

    .poster-frame {
      aspect-ratio: 2/3;
      background: var(--border-light);
      overflow: hidden;
      position: relative;
      border: 1px solid var(--text);
    }
    .entry:hover .poster-frame img,
    .entry:hover .poster-frame .poster-fallback { opacity: 0.85; }
    .poster-frame img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center 20%;
      display: block;
      transition: opacity 0.4s ease;
    }
    .poster-frame.revealed img,
    .poster-frame.revealed .poster-fallback { opacity: 0; }

    /* ═══ Poster Info Overlay (Fade Dissolve) ═══ */
    .poster-info {
      position: absolute; inset: 0;
      opacity: 0; pointer-events: none;
      transition: opacity 0.4s ease;
      background: var(--bg);
      border: none;
      padding: 16px 14px 32px;
      overflow-y: auto;
      display: flex; flex-direction: column; gap: 6px;
      z-index: 3;
    }
    .poster-frame.revealed .poster-info { opacity: 1; pointer-events: auto; }
    .poster-info-title {
      font-family: 'Playfair Display', serif;
      font-size: 1rem; font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--text);
      line-height: 1.2;
    }
    .poster-info-meta {
      font-family: var(--mono);
      font-size: 0.65rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      line-height: 1.4;
    }
    .poster-info-cast {
      font-family: var(--mono);
      font-size: 0.6rem;
      color: var(--text-secondary);
      letter-spacing: 0.03em;
      line-height: 1.4;
    }
    .poster-info-tagline {
      font-family: 'Lora', serif;
      font-size: 0.7rem;
      font-style: italic;
      color: var(--text-secondary);
      line-height: 1.4;
    }
    .poster-info-genres {
      display: flex; flex-wrap: wrap; gap: 4px;
    }
    .poster-info-genre {
      font-family: var(--mono);
      font-size: 0.55rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 2px 6px;
      border: 1px solid var(--border);
      color: var(--text-secondary);
    }
    .poster-info-synopsis {
      font-family: 'Lora', serif;
      font-size: 0.75rem;
      font-style: italic;
      color: var(--text);
      line-height: 1.5;
      margin-top: 2px;
    }
    .poster-info-loading {
      display: flex; align-items: center; justify-content: center;
      height: 100%;
      font-family: var(--mono);
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    /* Poster Fallback — editorial flat card */
    .poster-fallback {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      padding: 20px 16px;
      text-align: center;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
      transition: opacity 0.4s ease;
    }
    .poster-fallback-text {
      font-family: 'Playfair Display', serif;
      font-size: 1.15rem;
      font-weight: 700;
      color: var(--text-muted);
      line-height: 1.3;
      position: relative;
      z-index: 1;
    }
    .poster-fallback-icon {
      font-size: 1.2rem;
      margin-bottom: 10px;
      opacity: 0.4;
      position: relative;
      z-index: 1;
      color: var(--text-muted);
    }

    .entry-content { padding: 12px 0 0; }

    .entry-title {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 12px;
      line-height: 1.3;
      letter-spacing: -0.01em;
      color: var(--text);
    }

    .ratings-container {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }

    .rating-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      min-height: 36px;
    }

    .rating-label-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ───── User Avatars (Monotype Stamp) ───── */
    .avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Lora', serif;
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0;
      color: var(--text);
      background: transparent;
      border: 1.5px solid var(--text);
      flex-shrink: 0;
    }
    .avatar.greg-avatar { background: transparent; }
    .avatar.peer-avatar { background: transparent; }

    .rating-label {
      font-size: 0.65rem;
      font-weight: 600;
      color: var(--text-muted);
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }

    .rating-value {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
      font-weight: 400;
      letter-spacing: 0.12em;
    }

    .rating-value.editable {
      color: var(--text);
      cursor: pointer;
      transition: var(--transition);
      padding: 6px 10px;
      margin: -6px -10px;
      border-radius: 0;
    }
    .rating-value.editable:hover { background: var(--border-light); }

    .rating-value.blind-rating {
      color: var(--text-muted); font-style: italic; font-size: 0.85rem;
      letter-spacing: 0.05em; cursor: default; user-select: none;
    }

    /* Rating Reveal Animation */
    .reveal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.88);
      backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
      z-index: 10001; display: flex; align-items: center; justify-content: center;
      flex-direction: column; gap: 16px;
    }
    .reveal-card {
      text-align: center; max-width: 380px; width: 90%; padding: 36px 28px;
      background: var(--bg); border-radius: 0; border: 1px solid var(--border);
    }
    .reveal-title { font-size: 1rem; color: var(--text-secondary); margin-bottom: 8px; font-weight: 600; letter-spacing: 0.04em; }
    .reveal-movie { font-family: 'Playfair Display', serif; font-size: 1.5rem; font-weight: 700; color: var(--text); margin-bottom: 24px; }
    .reveal-ratings { display: flex; gap: 24px; justify-content: center; align-items: center; margin-bottom: 20px; }
    .reveal-col { text-align: center; }
    .reveal-name { font-size: 0.7rem; font-weight: 700; text-transform: uppercase; color: var(--text-secondary); letter-spacing: 0.06em; margin-bottom: 6px; }
    .reveal-stars { font-size: 1.6rem; }
    .reveal-hidden {
      font-size: 1.6rem; color: var(--text-muted);
      animation: revealFlip 0.8s ease 0.5s forwards;
    }
    @keyframes revealFlip {
      0% { transform: rotateX(0deg); opacity: 1; }
      40% { transform: rotateX(90deg); opacity: 0; }
      60% { transform: rotateX(90deg); opacity: 0; }
      100% { transform: rotateX(0deg); opacity: 1; }
    }
    .reveal-vs { font-weight: 800; font-size: 0.9rem; color: var(--text-secondary); }
    .reveal-gap { margin-top: 16px; font-weight: 700; font-size: 0.9rem; animation: fadeIn 0.8s ease 1.3s both; }
    .reveal-close-btn {
      margin-top: 16px; padding: 10px 28px; border-radius: 0;
      background: var(--text); color: var(--bg); border: none;
      font-weight: 600; cursor: pointer; font-size: 0.75rem;
      letter-spacing: 0.08em; text-transform: uppercase;
      animation: fadeIn 0.4s ease 1.6s both;
    }

    /* Achievement Badges — compact inline strip */
    .badges-section {
      display: flex; align-items: baseline; gap: 16px;
      margin-bottom: 28px; padding: 0;
      font-size: 0.65rem;
    }
    .badges-row {
      display: inline-flex; align-items: baseline; gap: 4px; flex-wrap: wrap;
    }
    .badges-row-label {
      font-family: var(--mono); font-size: 0.6rem; font-weight: 700; text-transform: uppercase;
      letter-spacing: 0.1em;
    }
    .badges-row-label.greg { color: var(--text); }
    .badges-row-label.peer { color: var(--text); }
    .badge-chip {
      display: inline-flex; align-items: center; gap: 3px;
      padding: 0 6px; border-radius: 0;
      background: transparent; border: none;
      font-size: 0.65rem; color: var(--text-secondary);
      cursor: default; transition: var(--transition);
      border-left: 1px solid var(--border); padding-left: 8px;
    }
    .badge-chip:first-of-type { border-left: none; padding-left: 0; }
    .badge-chip:hover {
      color: var(--text);
    }
    .badge-chip .badge-icon { font-size: 0.7rem; }
    .badge-chip .badge-name { font-weight: 500; letter-spacing: 0.02em; }
    .no-badges { font-size: 0.65rem; color: var(--text-muted); font-style: italic; }

    /* Keyboard Shortcuts Help */
    .shortcuts-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.75);
      backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
      z-index: 10002; display: none; align-items: center; justify-content: center;
      animation: fadeIn 0.15s ease;
    }
    .shortcuts-overlay.open { display: flex; }
    .shortcuts-panel {
      background: var(--bg); border: 1px solid var(--border); border-radius: 0; padding: 28px 32px;
      max-width: 380px; width: 90%;
    }
    .shortcuts-title {
      font-size: 1.1rem; font-weight: 700; margin-bottom: 16px; color: var(--text);
      display: flex; align-items: center; justify-content: space-between;
    }
    .shortcuts-close { background: none; border: none; color: var(--text-secondary); font-size: 1.2rem; cursor: pointer; }
    .shortcut-row {
      display: flex; align-items: center; justify-content: space-between;
      padding: 8px 0; border-bottom: 1px solid var(--border);
    }
    .shortcut-row:last-child { border-bottom: none; }
    .shortcut-desc { font-size: 0.85rem; color: var(--text); }
    .shortcut-key {
      background: var(--bg); border: 1px solid var(--border); border-radius: 0;
      padding: 3px 10px; font-size: 0.75rem; font-weight: 700;
      font-family: 'IBM Plex Mono', monospace; color: var(--text-secondary);
      min-width: 28px; text-align: center;
    }

    .unrated-prompt {
      font-size: 0.8125rem;
      color: var(--text-muted);
      font-style: italic;
      font-weight: 400;
    }
    .unrated-prompt.clickable {
      cursor: pointer;
      color: var(--text-secondary);
      font-style: normal;
      font-weight: 500;
      border: 1px dashed var(--text-secondary);
      padding: 4px 10px;
      border-radius: 0;
      opacity: 0.7;
      transition: var(--transition);
    }
    .unrated-prompt.clickable:hover { opacity: 1; background: rgba(37, 99, 235, 0.06); }

    /* ───── Rating Comparison Bar ───── */
    /* comparison bars removed – stars already show the rating */

    /* ───── Poster Corner Reaction Stamps ───── */
    .poster-badge {
      position: absolute;
      bottom: 8px;
      z-index: 3;
      width: auto;
      height: auto;
      padding: 6px 10px;
      border-radius: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.75rem;
      background: rgba(0,0,0,0.72);
      backdrop-filter: blur(4px);
      border: 1px solid rgba(255,255,255,0.15);
      transition: var(--transition);
      cursor: default;
      line-height: 1;
      filter: none;
    }
    .poster-badge.left  { left: 6px; }
    .poster-badge.right { right: 6px; }
    .poster-badge.clickable { cursor: pointer; }
    .poster-badge.clickable:hover {
      filter: none;
      background: rgba(0,0,0,0.9);
      border-color: rgba(255,255,255,0.4);
    }
    .poster-badge .badge-who {
      position: absolute;
      top: -7px;
      right: -7px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      font-family: 'Lora', serif;
      font-size: 0.5rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text);
      background: var(--bg);
      border: 1.5px solid var(--text);
    }
    .badge-who.peer-who { background: var(--bg); }
    .badge-who.greg-who { background: var(--bg); }
    .poster-badge .kc-face {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      filter: grayscale(0.15) contrast(1.1);
    }

    /* ───── Inline Reaction Pills ───── */
    .reaction-pills {
      display: flex; align-items: center; gap: 6px;
      margin-top: 6px; flex-wrap: wrap;
    }
    .reaction-pills-label {
      font-family: var(--mono); font-size: 0.6rem; font-weight: 600;
      text-transform: uppercase; letter-spacing: 0.06em;
      color: var(--text-muted); white-space: nowrap;
    }
    .reaction-pill {
      padding: 4px 6px; border: 1px solid var(--border); border-radius: 0;
      background: transparent; cursor: pointer;
      font-size: 1.1rem; line-height: 1;
      display: flex; align-items: center; justify-content: center;
      transition: var(--transition);
    }
    .reaction-pill:hover {
      background: var(--border-light); border-color: var(--text);
    }
    .reaction-pill.active {
      background: var(--text); border-color: var(--text);
    }
    .reaction-pill .kc-pill {
      width: 20px; height: 20px; border-radius: 50%;
      object-fit: cover; filter: grayscale(0.15) contrast(1.1);
    }
    .reaction-pill.active .kc-pill { filter: brightness(1.2); }

    /* Old inline .reaction kept for backwards compat but hidden */
    .reaction { display: none; }

    /* ───── Star Picker ───── */
    .star-picker-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--overlay-bg);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: fadeIn 0.2s ease;
    }

    .star-picker-modal {
      background: var(--bg);
      border-radius: 0;
      border: 1px solid var(--border);
      box-shadow: none;
      max-width: 380px;
      width: 90%;
      padding: 28px;
      animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-align: center;
    }

    .star-picker-title {
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 4px;
      letter-spacing: -0.01em;
      color: var(--text);
    }

    .star-picker-subtitle {
      font-size: 0.8125rem;
      color: var(--text-secondary);
      margin-bottom: 20px;
    }

    .star-picker-stars {
      display: flex;
      justify-content: center;
      gap: 2px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .star-btn {
      width: 38px;
      height: 38px;
      border: none;
      background: none;
      font-size: 1.5rem;
      cursor: pointer;
      border-radius: 0;
      transition: var(--transition);
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .star-btn:hover { background: var(--border-light); }
    .star-btn.active { color: var(--text); }

    .star-picker-display {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 20px;
      min-height: 1.5em;
    }

    .star-picker-actions { display: flex; gap: 10px; }

    .star-picker-actions button {
      flex: 1;
      padding: 10px 16px;
      border-radius: 0;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
      border: none;
      font-family: inherit;
    }

    .star-picker-cancel { background: var(--border-light); color: var(--text-secondary); }
    .star-picker-cancel:hover { background: var(--border); color: var(--text); }
    .star-picker-confirm { background: var(--accent); color: white; box-shadow: none; }
    .star-picker-confirm:hover { background: var(--accent-hover); box-shadow: none; }
    .star-picker-confirm:disabled { opacity: 0.4; cursor: not-allowed; }

    .star-picker-remove {
      width: 100%;
      margin-top: 8px;
      padding: 8px;
      border: none;
      background: none;
      color: var(--text-muted);
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      border-radius: 0;
      font-family: inherit;
      transition: var(--transition);
    }
    .star-picker-remove:hover { color: var(--text); background: var(--border-light); }

    /* ───── Discussion ───── */
    .discussion-trigger {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 0;
      margin-top: 16px;
      cursor: pointer;
      user-select: none;
      transition: var(--transition);
      color: var(--text-secondary);
      font-size: 0.8125rem;
      font-weight: 600;
      border-top: 1px solid var(--border-light);
    }
    .discussion-trigger:hover { color: var(--accent); }
    .discussion-trigger.has-notes { color: var(--text); }

    .discussion-count { display: flex; align-items: center; gap: 6px; }

    .chevron {
      font-size: 0.75rem;
      transition: transform 0.2s ease;
      opacity: 0.6;
    }
    .chevron.rotated { transform: rotate(180deg); }

    .discussion-section {
      display: none;
      padding: 16px 0;
      background: transparent;
      border-top: 1px solid var(--border);
    }
    .discussion-section.expanded { display: block; }

    .discussion-title {
      font-size: 0.6875rem;
      font-weight: 700;
      color: var(--text-muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      margin-bottom: 16px;
    }

    .note {
      background: var(--bg);
      padding: 16px;
      border-radius: 0;
      margin-bottom: 12px;
      border: 1px solid var(--border);
      box-shadow: none;
      transition: var(--transition);
    }
    .note:hover { border-color: var(--text-muted); }
    .note:last-of-type { margin-bottom: 0; }

    .note-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }

    .note-author-group { display: flex; align-items: center; gap: 8px; }

    .note-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: 'Lora', serif;
      font-size: 0.65rem;
      font-weight: 700;
      color: var(--text);
      background: transparent;
      border: 1.5px solid var(--text);
      flex-shrink: 0;
    }
    .note-avatar.greg { background: transparent; }
    .note-avatar.peer { background: transparent; }

    .note-author {
      font-size: 0.6875rem;
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }
    .note-author.greg { color: var(--text); }
    .note-author.peer { color: var(--text); }

    .note-meta { display: flex; align-items: center; gap: 10px; }
    .note-time { font-size: 0.6875rem; color: var(--text-muted); }

    .note-delete {
      font-size: 0.75rem;
      color: var(--text-muted);
      cursor: pointer;
      opacity: 0;
      transition: var(--transition);
      padding: 6px 10px;
      border-radius: 0;
    }
    .note:hover .note-delete { opacity: 0.5; }
    .note-delete:hover { opacity: 1 !important; background: var(--border-light); color: var(--text); }

    .note-text {
      font-size: 0.9375rem;
      line-height: 1.5;
      color: var(--text);
      letter-spacing: -0.01em;
    }

    .note-form { margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); }

    .note-input {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--border);
      font-family: inherit;
      font-size: 0.9375rem;
      resize: vertical;
      min-height: 80px;
      border-radius: 0;
      background: var(--bg);
      color: var(--text);
      transition: var(--transition);
      line-height: 1.5;
    }
    .note-input:focus {
      outline: none;
      border-color: var(--text);
    }

    .note-submit {
      background: var(--text);
      color: var(--bg);
      border: none;
      padding: 10px 20px;
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      margin-top: 10px;
      border-radius: 0;
      transition: var(--transition);
      font-family: inherit;
    }
    .note-submit:hover:not(:disabled) { opacity: 0.8; }
    .note-submit:active:not(:disabled) { opacity: 0.65; }
    .note-submit:disabled { opacity: 0.6; cursor: not-allowed; }
    .note-char-count {
      font-size: 0.65rem;
      color: var(--text-muted);
      text-align: right;
      margin-top: -4px;
    }

    /* (old .reaction-picker removed — replaced by inline .reaction-pills) */

    /* ───── Login Modal ───── */
    .modal-overlay {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--overlay-bg);
      backdrop-filter: blur(4px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      animation: fadeIn 0.2s ease;
    }
    .modal-overlay.visible { display: flex; }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .login-modal {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 0;
      max-width: 400px;
      width: 90%;
      padding: 32px;
      animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes entryHighlight {
      0% { outline: 2px solid var(--text); outline-offset: 2px; }
      100% { outline: 2px solid transparent; outline-offset: 2px; }
    }
    .entry.highlight-flash {
      animation: entryHighlight 1.8s ease-out forwards;
    }

    .modal-title { font-family: 'Playfair Display', serif; font-size: 1.5rem; font-weight: 400; margin-bottom: 8px; letter-spacing: -0.02em; color: var(--text); }
    .modal-subtitle { font-size: 0.9375rem; color: var(--text-secondary); margin-bottom: 28px; line-height: 1.5; }
    .reviewer-select { margin-bottom: 24px; }
    .reviewer-label { font-size: 0.8125rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 12px; display: block; }
    .reviewer-options { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .reviewer-options.has-admin { grid-template-columns: 1fr 1fr 1fr; }

    .reviewer-option {
      padding: 16px;
      border: 2px solid var(--border);
      border-radius: 0;
      cursor: pointer;
      transition: var(--transition);
      text-align: center;
      font-weight: 600;
      font-size: 0.9375rem;
      background: var(--bg);
      user-select: none;
    }
    .reviewer-option:hover { border-color: var(--text); background: var(--border-light); }
    .reviewer-option.selected { border-color: var(--accent); background: var(--peer-bg); color: var(--accent); }
    .reviewer-option.greg.selected { border-color: var(--greg); background: var(--greg-bg); color: var(--greg); }
    .reviewer-option.admin { font-size: 0.75rem; }
    .reviewer-option.admin.selected { border-color: var(--text-muted); background: var(--border-light); color: var(--text); }

    .password-field { margin-bottom: 24px; }
    .password-label { font-size: 0.8125rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px; display: block; }

    .password-input {
      width: 100%;
      padding: 12px 14px;
      border: 2px solid var(--border);
      border-radius: 0;
      font-family: inherit;
      font-size: 0.9375rem;
      transition: var(--transition);
      background: var(--bg);
      color: var(--text);
    }
    .password-input:focus { outline: none; border-color: var(--text); }

    .modal-actions { display: flex; gap: 12px; }

    .modal-btn {
      flex: 1; padding: 12px 20px; border-radius: 0; font-size: 0.9375rem;
      font-weight: 600; cursor: pointer; transition: var(--transition); border: none;
      font-family: inherit;
    }
    .modal-btn-primary { background: var(--text); color: var(--bg); }
    .modal-btn-primary:hover:not(:disabled) { opacity: 0.85; }
    .modal-btn-primary:active:not(:disabled) { opacity: 0.7; }
    .modal-btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
    .modal-btn-secondary { background: transparent; color: var(--text-secondary); border: 1px solid var(--border); }
    .modal-btn-secondary:hover { border-color: var(--text); color: var(--text); }

    .error-message { color: #dc2626; font-size: 0.8125rem; margin-top: 8px; display: none; }
    .error-message.visible { display: block; }

    /* ───── Skeleton Loading ───── */
    .skeleton-card { background: transparent; border-radius: 0; overflow: visible; border: none; }
    .skeleton-poster {
      aspect-ratio: 2/3;
      background: linear-gradient(90deg, var(--skeleton-from) 25%, var(--skeleton-to) 50%, var(--skeleton-from) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }
    .skeleton-content { padding: 20px; }
    .skeleton-line {
      height: 14px;
      background: linear-gradient(90deg, var(--skeleton-from) 25%, var(--skeleton-to) 50%, var(--skeleton-from) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 0;
      margin-bottom: 12px;
    }
    .skeleton-line.short { width: 60%; }
    .skeleton-line.medium { width: 80%; }

    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* ───── No Results ───── */
    .no-results { grid-column: 1 / -1; text-align: center; padding: 80px 20px; color: var(--text-secondary); }
    .no-results-icon { font-size: 3rem; margin-bottom: 16px; opacity: 0.5; }
    .no-results-text { font-size: 1.125rem; font-weight: 600; margin-bottom: 8px; }
    .no-results-hint { font-size: 0.9375rem; color: var(--text-muted); }

    /* ───── Load More ───── */
    .load-more-wrapper {
      grid-column: 1 / -1;
      text-align: center;
      padding: 32px 20px;
    }
    .load-more-btn {
      background: transparent;
      color: var(--text);
      border: 1px solid var(--text);
      padding: 12px 40px;
      border-radius: 0;
      font-family: inherit;
      font-size: 0.75rem;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      cursor: pointer;
      transition: var(--transition);
    }
    .load-more-btn:hover {
      background: var(--text);
      color: var(--bg);
    }
    .load-more-btn:active { opacity: 0.8; }
    .load-more-count {
      font-size: 0.8125rem;
      color: var(--text-muted);
      margin-top: 10px;
      font-weight: 500;
    }

    /* ───── Footer ───── */
    .site-footer {
      margin-top: 60px;
      padding: 24px 0;
      border-top: 1px solid var(--border-light);
      text-align: center;
    }
    .footer-support {
      display: inline-block;
      font-size: 0.7rem;
      color: var(--text-muted);
      text-decoration: none;
      padding: 8px 20px;
      border: 1px solid var(--border);
      border-radius: 0;
      transition: var(--transition);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }
    .footer-support:hover {
      color: var(--text);
      border-color: var(--text);
    }
    .footer-copy {
      font-size: 0.65rem;
      color: var(--text-muted);
      margin-top: 12px;
      opacity: 0.6;
    }
    .footer-tmdb {
      font-family: var(--mono);
      font-size: 0.6rem;
      color: var(--text-muted);
      opacity: 0.5;
      margin-top: 8px;
      letter-spacing: 0.04em;
    }
    .footer-tmdb a {
      color: var(--text-muted);
      text-decoration: none;
      border-bottom: 1px solid transparent;
      transition: border-color 0.2s, color 0.2s;
    }
    .footer-tmdb a:hover {
      color: var(--text-secondary);
      border-bottom-color: var(--text-secondary);
    }

    /* ───── Error Log ───── */
    #error-log {
      position: fixed; bottom: 16px; left: 16px; font-size: 0.75rem; color: #dc2626;
      background: var(--bg); padding: 12px 16px; z-index: 1000; max-width: 400px;
      border-radius: 0; box-shadow: none; border: 1px solid var(--border); display: none;
    }

    /* ───── Responsive: Tablet ───── */
    @media (max-width: 900px) {
      .grid { grid-template-columns: 1fr 1fr; gap: 24px; }
    }

    /* ───── Responsive: Mobile ───── */
    @media (max-width: 600px) {
      .container { padding: 0 16px; }

      .notif-dropdown { width: calc(100vw - 32px); right: auto; left: 0; }

      nav {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        padding: 16px 0;
        margin-bottom: 24px;
        position: relative;
      }

      .hamburger { display: block; }

      .nav-controls {
        display: none;
        position: absolute;
        top: 100%;
        left: 0; right: 0;
        flex-direction: column;
        align-items: stretch;
        background: var(--bg);
        border: 1px solid var(--border);
        border-radius: 0;
        padding: 8px;
        gap: 2px;
        z-index: 100;
      }
      .nav-controls.open { display: flex; }

      .nav-controls .nav-link {
        padding: 10px 14px; font-size: 0.8rem; border-radius: 0;
        text-decoration: none;
      }
      .nav-controls .nav-link:hover { background: var(--border-light); text-decoration: none; }

      .nav-controls .theme-toggle {
        width: 100%; border-radius: 0; justify-content: flex-start;
        padding: 10px 14px; gap: 8px; font-size: 0.8rem;
      }
      .nav-controls .sync-btn {
        width: 100%; justify-content: flex-start;
        padding: 10px 14px; border-radius: 0; font-size: 0.8rem;
        border: none;
      }
      .nav-controls .sync-btn.visible { display: flex; }
      .nav-controls .notif-wrapper { width: 100%; }
      .nav-controls .notif-wrapper .notif-bell {
        padding: 10px 14px; font-size: 0.8rem; display: flex; align-items: center; gap: 8px;
        border-radius: 0;
      }
      .nav-controls .notif-wrapper .notif-bell:hover { background: var(--border-light); }
      .nav-controls .auth-controls {
        width: 100%; flex-direction: column; gap: 2px;
      }
      .nav-controls .login-trigger,
      .nav-controls .logout-btn {
        padding: 10px 14px; font-size: 0.8rem; border-radius: 0; text-align: left;
      }

      .brand { font-size: 0.5rem; }
      .brand-monogram { width: 56px; height: 56px; border-width: 3px; }
      .brand-monogram .d, .brand-monogram .five { font-size: 2.75rem; }
      .brand-monogram .d { top: 0px; left: -1px; }
      .brand-monogram .five { top: 8px; left: 25px; }

      header { margin-bottom: 16px; }
      .page-title { font-size: 2.5rem; }
      .tagline { font-size: 0.75rem; }

      .stats-bar {
        display: flex;
        flex-wrap: wrap;
        overflow-x: auto;
        gap: 0;
        margin-bottom: 14px;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
      }
      .stats-bar::-webkit-scrollbar { display: none; }
      .stat-card {
        padding: 4px 10px;
      }
      .stat-card:first-child { padding-left: 0; }
      .stat-value { font-size: 0.75rem; }
      .stat-card:last-child .stat-value { font-size: 0.7rem; }
      .stat-label { font-size: 0.55rem; }

      .toolbar { gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
      .search-input { font-size: 0.875rem; padding: 10px 12px; }
      .search-wrapper { flex: 1; }
      .log-film-btn { font-size: 0.6rem; padding: 6px 10px; order: 2; }
      .backup-btn { font-size: 0.55rem; padding: 6px 8px; order: 3; }
      .sort-select { font-size: 0.7rem; order: 4; }

      .filter-chips { gap: 4px; }
      .filter-chip { font-size: 0.6rem; }

      .grid { grid-template-columns: repeat(2, 1fr); gap: 20px 16px; }

      .entry-content { padding: 10px 0 0; }
      .entry-title { font-size: 0.85rem; margin-bottom: 8px; }

      .discussion-section { padding: 14px; }
      .note { padding: 12px; }
      .note-input { min-height: 60px; font-size: 0.875rem; }

      .reaction-pill { font-size: 0.95rem; padding: 3px 5px; }
      .poster-badge { font-size: 1.4rem; padding: 5px 8px; bottom: 6px; }
      .poster-badge.left { left: 4px; }
      .poster-badge.right { right: 4px; }
      .poster-badge .kc-face { width: 28px; height: 28px; }
      .poster-badge .badge-who { width: 14px; height: 14px; font-size: 0.45rem; }

      .rating-value.editable { padding: 8px 12px; margin: -8px -12px; }
      .reaction-pills { margin-top: 8px; }
      .delete-film-btn, .add-queue-btn { opacity: 1; }
      .note-delete { opacity: 0.5; padding: 8px 12px; }

      .login-modal { padding: 24px 20px; }
      .modal-title { font-size: 1.25rem; }
      .modal-subtitle { font-size: 0.875rem; margin-bottom: 20px; }
      .reviewer-option { padding: 12px; font-size: 0.875rem; }

      .star-picker-modal { padding: 24px 20px; }
      .star-btn { width: 34px; height: 34px; font-size: 1.3rem; }

      .scroll-top-btn { bottom: 20px; right: 20px; width: 40px; height: 40px; }

      .toast-container { bottom: 16px; right: 16px; left: 16px; }
      .toast { max-width: 100%; }

    }

    /* ═══ Print Stylesheet — Catalog Page ═══ */
    @media print {
      * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }

      body { background: #fff !important; color: #1a1a1a !important; font-size: 10pt; }

      /* Hide interactive elements */
      nav, .hamburger, .nav-controls, .toolbar, .filter-chips, .scroll-top-btn,
      .toast-container, .pull-indicator, .sync-btn, .notif-wrapper, .auth-controls,
      .badges-section, .discussion-section, .reaction-pills, .poster-badge,
      .poster-info, .star-picker-overlay, .reveal-overlay, .reviewer-picker-overlay,
      .shortcuts-overlay, .reaction-picker-modal, #error-log, .new-badge,
      .search-wrapper, .sort-select, .search-clear, .log-film-btn, .log-film-overlay,
      .delete-film-btn, .add-queue-btn, .backup-btn, .confirm-overlay { display: none !important; }

      .container { max-width: 100%; padding: 0; }

      /* Header — editorial masthead */
      header { margin-bottom: 24pt; text-align: center; }
      .page-title { font-size: 28pt; margin-bottom: 6pt; }
      .tagline { font-size: 9pt; }

      /* Stats strip — single line */
      .stats-bar { justify-content: center; margin-bottom: 16pt; opacity: 1 !important; transform: none !important; }
      .stat-card { border-right-color: #ccc; }
      .stat-value { font-size: 8pt; }
      .stat-label { font-size: 6pt; }

      /* Pull quote */
      .pull-quote { margin-bottom: 16pt; page-break-after: avoid; }
      .pull-quote-title { font-size: 18pt; }

      /* Grid — compact catalog layout */
      .grid {
        grid-template-columns: repeat(4, 1fr) !important;
        gap: 12pt !important;
      }

      .entry { page-break-inside: avoid; border: none !important; }
      .poster-frame { border: 0.5pt solid #ccc !important; }
      .poster-frame img { max-height: 160pt; }

      .entry-content { padding: 4pt 0 0; }
      .entry-title { font-size: 8pt; margin-bottom: 2pt; }
      .entry-meta { font-size: 6pt; }
      .rating-value { font-size: 7pt; }

      /* Footer — colophon */
      .site-footer { margin-top: 24pt; border-top: 0.5pt solid #ccc; }
      .footer-support { display: none !important; }
      .footer-copy { font-size: 7pt; opacity: 1; }

      /* Page setup */
      @page {
        margin: 0.75in;
        size: letter;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <nav>
      <a href="/" class="brand"><span class="brand-monogram"><span class="d">D</span><span class="five">5</span></span>dufive</a>
      <button class="hamburger" id="hamburger" aria-label="Menu">&#9776;</button>
      <div class="nav-controls" id="nav-controls">
        <a href="/" class="nav-link active">The Ledger</a>
        <a href="watchlist.html" class="nav-link">The Queue</a>
        <button id="theme-toggle" class="theme-toggle" title="Toggle dark mode" aria-label="Toggle dark mode">
          <span id="theme-icon">&#9790;</span>
        </button>
        <button class="sync-btn" id="sync-btn" title="Sync latest from Letterboxd">
          <span class="sync-icon">&#x21bb;</span> Sync
        </button>
        <div class="notif-wrapper" id="notif-wrapper">
          <div class="notif-bell" id="notif-bell" title="Notifications">
            &#8226;
            <span class="notif-badge" id="notif-badge">0</span>
          </div>
          <div class="notif-dropdown" id="notif-dropdown">
            <div class="notif-header">Activity</div>
            <div id="notif-list"></div>
          </div>
        </div>
        <div class="auth-controls">
          <div id="auth-btn" class="login-trigger">Reviewer Login</div>
          <div id="logout-btn" class="logout-btn">Logout</div>
        </div>
      </div>
    </nav>

    <header>
      <h1 class="page-title">The Ledger.</h1>
      <p class="tagline">Unanimously Divided</p>
    </header>

    <div class="stats-bar" id="stats-bar">
      <div class="stat-card">
        <div class="stat-value" id="stat-total">&mdash;</div>
        <div class="stat-label">Total Films</div>
      </div>
      <div class="stat-card">
        <div class="stat-value greg-color" id="stat-greg-avg">&mdash;</div>
        <div class="stat-label">Greg Avg</div>
      </div>
      <div class="stat-card">
        <div class="stat-value peer-color" id="stat-peer-avg">&mdash;</div>
        <div class="stat-label">Peer Avg</div>
      </div>
      <div class="stat-card">
        <div class="stat-value accent-color" id="stat-agreement">&mdash;</div>
        <div class="stat-label">Agreement</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="stat-controversial">&mdash;</div>
        <div class="stat-label">Most Debated</div>
      </div>
    </div>

    <div class="toolbar">
      <div class="search-wrapper">
        <input type="text" class="search-input" id="search-input" placeholder="Search films..." autocomplete="off" />
        <button class="search-clear" id="search-clear" aria-label="Clear search">&times;</button>
      </div>
      <button class="log-film-btn" id="log-film-btn" style="display:none;">+ Log Film</button>
      <button class="backup-btn" id="backup-btn" style="display:none;">Backup</button>
      <select class="sort-select" id="sort-select">
        <option value="date">Newest First</option>
        <option value="greg-high">Greg: High &rarr; Low</option>
        <option value="greg-low">Greg: Low &rarr; High</option>
        <option value="peer-high">Peer: High &rarr; Low</option>
        <option value="peer-low">Peer: Low &rarr; High</option>
        <option value="gap">Biggest Disagreement</option>
      </select>
    </div>
    <div class="filter-chips" id="filter-chips">
      <div class="filter-chip active" data-filter="all">All</div>
      <div class="filter-chip" data-filter="greg-rated">Greg Rated</div>
      <div class="filter-chip" data-filter="peer-rated">Peer Rated</div>
      <div class="filter-chip" data-filter="both-rated">Both Rated</div>
      <div class="filter-chip" data-filter="peer-unrated">Peer Unrated</div>
      <div class="filter-chip" data-filter="greg-unrated">Greg Unrated</div>
    </div>

    <main class="grid" id="ledger-grid" style="margin-top: 24px;"></main>

    <footer class="site-footer">
      <a href="https://venmo.com/Greg-Dufore" target="_blank" rel="noopener" class="footer-support">Support the Ledger</a>
      <div class="footer-copy">DUFIVE &mdash; Consistently Inconsistent</div>
      <div class="footer-tmdb">Film metadata courtesy of <a href="https://www.themoviedb.org/" target="_blank" rel="noopener">The Movie Database (TMDB)</a></div>
    </footer>
  </div>

  <div id="error-log"></div>

  <!-- Toast Container -->
  <div class="toast-container" id="toast-container"></div>

  <!-- Pull to Refresh Indicator -->
  <div class="pull-indicator" id="pull-indicator">
    <div class="spinner"></div>
    <span>Refreshing...</span>
  </div>

  <!-- Scroll to Top -->
  <button class="scroll-top-btn" id="scroll-top" aria-label="Scroll to top">&uarr;</button>

  <!-- Log Film Modal -->
  <div id="log-film-modal" class="log-film-overlay">
    <div class="log-film-panel">
      <h2 class="log-film-title">Log a Film</h2>
      <input type="text" class="log-film-search" id="log-film-search" placeholder="Search TMDB for a title..." autocomplete="off" />
      <div class="log-film-results" id="log-film-results">
        <div class="log-film-hint">Type a film title to search</div>
      </div>
    </div>
  </div>

  <!-- Login Modal -->
  <div id="login-modal" class="modal-overlay">
    <div class="login-modal">
      <h2 class="modal-title">Reviewer Login</h2>
      <p class="modal-subtitle">Choose your profile and enter your access key to participate in ratings and discussions.</p>
      <div class="reviewer-select">
        <label class="reviewer-label">Select Reviewer</label>
        <div class="reviewer-options has-admin">
          <div class="reviewer-option greg" data-reviewer="greg">Greg</div>
          <div class="reviewer-option peer" data-reviewer="peer">Peer</div>
          <div class="reviewer-option admin" data-reviewer="admin">Admin</div>
        </div>
      </div>
      <div class="password-field">
        <label class="password-label">Access Key</label>
        <input type="password" id="password-input" class="password-input" placeholder="Enter your access key" autocomplete="off" />
        <div id="login-error" class="error-message">Incorrect access key. Please try again.</div>
      </div>
      <div class="modal-actions">
        <button class="modal-btn modal-btn-secondary" onclick="closeLoginModal()">Cancel</button>
        <button class="modal-btn modal-btn-primary" id="login-submit" disabled>Login</button>
      </div>
    </div>
  </div>

  <!-- Star Picker Modal -->
  <div id="star-picker" class="star-picker-overlay" style="display:none;"></div>

  <!-- Keyboard Shortcuts Help -->
  <div class="shortcuts-overlay" id="shortcuts-overlay">
    <div class="shortcuts-panel">
      <div class="shortcuts-title">
        Keyboard Shortcuts
        <button class="shortcuts-close" onclick="document.getElementById('shortcuts-overlay').classList.remove('open')">&times;</button>
      </div>
      <div class="shortcut-row"><span class="shortcut-desc">Focus search</span><span class="shortcut-key">/</span></div>
      <div class="shortcut-row"><span class="shortcut-desc">Toggle dark/light mode</span><span class="shortcut-key">T</span></div>
      <div class="shortcut-row"><span class="shortcut-desc">Scroll to top</span><span class="shortcut-key">G G</span></div>
      <div class="shortcut-row"><span class="shortcut-desc">Show this help</span><span class="shortcut-key">?</span></div>
      <div class="shortcut-row"><span class="shortcut-desc">Close any overlay</span><span class="shortcut-key">Esc</span></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    /* ═══════════════════════════════════════════
       CONFIG
    ═══════════════════════════════════════════ */
    const SB_URL = 'https://brgxorrpfberfcyeugzq.supabase.co';
    const SB_KEY = 'sb_publishable_VbVFBh-gtIBAbr9Qtp240w_GS8Kn4Jf';
    const AUTH_FUNCTION_URL = 'https://brgxorrpfberfcyeugzq.supabase.co/functions/v1/clever-task';
    const ACTIONS_FUNCTION_URL = 'https://brgxorrpfberfcyeugzq.supabase.co/functions/v1/bright-function';

    const KC_IMG = 'data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAASABIAAD/4QC8RXhpZgAATU0AKgAAAAgABQESAAMAAAABAAEAAAEaAAUAAAABAAAASgEbAAUAAAABAAAAUgEoAAMAAAABAAIAAIdpAAQAAAABAAAAWgAAAAAAAABIAAAAAQAAAEgAAAABAAeQAAAHAAAABDAyMjGRAQAHAAAABAECAwCgAAAHAAAABDAxMDCgAQADAAAAAQABAACgAgAEAAAAAQAAACigAwAEAAAAAQAAACikBgADAAAAAQAAAAAAAAAA/8AAEQgAKAAoAwEiAAIRAQMRAf/EAB8AAAEFAQEBAQEBAAAAAAAAAAABAgMEBQYHCAkKC//EALUQAAIBAwMCBAMFBQQEAAABfQECAwAEEQUSITFBBhNRYQcicRQygZGhCCNCscEVUtHwJDNicoIJChYXGBkaJSYnKCkqNDU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6g4SFhoeIiYqSk5SVlpeYmZqio6Slpqeoqaqys7S1tre4ubrCw8TFxsfIycrS09TV1tfY2drh4uPk5ebn6Onq8fLz9PX29/j5+v/EAB8BAAMBAQEBAQEBAQEAAAAAAAABAgMEBQYHCAkKC//EALURAAIBAgQEAwQHBQQEAAECdwABAgMRBAUhMQYSQVEHYXETIjKBCBRCkaGxwQkjM1LwFWJy0QoWJDThJfEXGBkaJicoKSo1Njc4OTpDREVGR0hJSlNUVVZXWFlaY2RlZmdoaWpzdHV2d3h5eoKDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uLj5OXm5+jp6vLz9PX29/j5+v/bAEMAAgICAgICAwICAwUDAwMFBgUFBQUGCAYGBgYGCAoICAgICAgKCgoKCgoKCgwMDAwMDA4ODg4ODw8PDw8PDw8PD//bAEMBAgICBAQEBwQEBxALCQsQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEP/dAAQAA//aAAwDAQACEQMRAD8A/DjwD8PvEHxE1aXTdDiJjs4XubucgmO3t4+WdsdT2VRyx4FfQvhqbwL4NuTp3hvw7DqV/bNmXUdRjS9kyoz8kHzQICcjA3N23HrXvUHgxfhH+ybZxwRtBrfjq4tPtsqcSmO5JdI89gsQAx6s3rX2V+y58H/Blj4f00T2UUyXMZeVpEDM8ueclh/9alzJK7HytuyPjHW/2i/iLNbxWGj2ttaW0Q2yQLZIyOT22uGAA6cCvG72Twt8Utag0DxX4TtNE1C8bYmoadCLCcO38TQ7hBKo6sCqtjowr+g4fCj4cDex0C0ZtuA3kgnH5V8HftOeCtNsrcX+l26WV9pZFzayRIFdHj5yOPQYqY1E9LFTpSSu2fjH8WvhJ4p+DvihvDniRFkjlXzrS7iyYLqAniRD/wChKeVP4E+XV+3/AMZfA8Px4/Zmttbe3jfXbXTY9Ws3iGMTJGGmjTuBIoYbfXHoK/JH/hTPxJ/6Adx/3waaYOPY/9Dz79pWdV+FVnpumWiz211LEYpst+48hPMiKhQclwNgBx1r6a+FZ8Q6T8PtJn8FaXFq8tvAFlWR1ysqqCQBuUZJ/wBoe2a+Zf2Z/Gui/GP4K6bpeqlbjUNESOxvI25ZXgGIJcdfmQA57kMPWvZfgp8QbTwTda1pE9wLuPSp5opBFyGaMnjbk4OMZHY55rF7WNV8Vz374efED40+IJ9Y/wCE28EW/h6wsLVpILoXQlFzMvPliP7y8dW6A9zXyz41vvjZ8Qbm5XxZ4dsdE0zc0RVJPPlMLKcnfkAHHAK55x2r6i174u31vov2+0t7TXF1KNlEMFysK2yEHkkqwZAAdz55bAAxzXzp8XPjHYaF4FnW4ljmFokXmTREZ5ODGX7kcj3GDilHfYub01Z3fw58Pt4X+H2geHb7bvsbGKKX+6SFyxP1zzXT+Tofpb/+OV80ftB/Hrwn4X+B2p+IvC2sW1/da7C1jppt5VcmSddrOADkeUm5jkDBAHevx9/4Xl8Tv+g3P/30atIOdLQ//9H8Qvht8U/Gvwm1yTX/AATffZLiaJoZVZRJHIjdmRsglTyp7H8a9V+HHx41vw34mvtd1C4N4dZlaW9WQ7TJI5yzZXAycnp+VfM9T2/+uX604ikfsp4v/aI+AXizStPS61K8s5hEp8mGOExRnA+Vw8TDAx2NfCvx0+NWneLLsaD4ZcrotoRgKAnnyKPvFRgADtnk14ZP9xf9yuHuP9a1VyKOqIUnLcfdXUl3J5knA7DsKrUUVBof/9k=';
    const REACTIONS = { fire: '\u{1F525}', agree: '\u{1F91D}', disagree: '\u{1F914}', costner: 'costner' };
    const PAGE_SIZE = 24; // Films shown per "page"

    // ───── TMDB API (for poster info reveal) ─────
    const TMDB_KEY = 'bfb6e869cd271ba3ac952a29f9279f09';
    const TMDB_BASE = 'https://api.themoviedb.org/3';
    const tmdbCache = {};

    async function fetchTMDBDetails(rawTitle, year) {
      // Decode HTML entities (&#39; &amp; etc.) before searching
      const txt = document.createElement('textarea');
      txt.innerHTML = rawTitle;
      let title = txt.value;

      // Strip trailing "(YYYY)" from title and use as year if not already set
      const yearMatch = title.match(/\s*\((\d{4})\)\s*$/);
      if (yearMatch) {
        if (!year) year = yearMatch[1];
        title = title.replace(/\s*\(\d{4}\)\s*$/, '').trim();
      }

      const cacheKey = title + '-' + (year || '');
      if (tmdbCache[cacheKey]) return tmdbCache[cacheKey];
      try {
        // Step 1: Search for the movie (try with year first, fallback without)
        let searchUrl = TMDB_BASE + '/search/movie?api_key=' + TMDB_KEY + '&query=' + encodeURIComponent(title);
        if (year) searchUrl += '&year=' + year;
        let searchRes = await fetch(searchUrl);
        if (!searchRes.ok) return null;
        let searchData = await searchRes.json();

        // If year-scoped search fails, retry without year
        if ((!searchData.results || searchData.results.length === 0) && year) {
          const fallbackUrl = TMDB_BASE + '/search/movie?api_key=' + TMDB_KEY + '&query=' + encodeURIComponent(title);
          searchRes = await fetch(fallbackUrl);
          if (!searchRes.ok) return null;
          searchData = await searchRes.json();
        }

        if (!searchData.results || searchData.results.length === 0) return null;
        const movieId = searchData.results[0].id;

        // Step 2: Get full details with credits
        const detailUrl = TMDB_BASE + '/movie/' + movieId + '?api_key=' + TMDB_KEY + '&append_to_response=credits';
        const detailRes = await fetch(detailUrl);
        if (!detailRes.ok) return null;
        const d = await detailRes.json();

        const director = d.credits?.crew?.find(c => c.job === 'Director')?.name || '';
        const genres = (d.genres || []).map(g => g.name).slice(0, 3);
        const runtime = d.runtime ? d.runtime + ' min' : '';
        const cast = (d.credits?.cast || []).slice(0, 4).map(c => c.name);
        const tagline = d.tagline || '';

        const posterPath = d.poster_path || searchData.results[0].poster_path || '';
        const result = {
          title: d.title || title,
          year: d.release_date ? d.release_date.substring(0, 4) : (year || ''),
          director: director,
          runtime: runtime,
          genres: genres,
          cast: cast,
          tagline: tagline,
          overview: d.overview || '',
          tmdb_id: movieId,
          posterUrl: posterPath ? 'https://image.tmdb.org/t/p/w500' + posterPath : ''
        };
        tmdbCache[cacheKey] = result;
        return result;
      } catch (e) {
        console.warn('TMDB fetch failed:', e);
        return null;
      }
    }

    async function fetchTMDBPoster(rawTitle, year) {
      const txt = document.createElement('textarea');
      txt.innerHTML = rawTitle;
      let title = txt.value;
      const ym = title.match(/\s*\((\d{4})\)\s*$/);
      if (ym) { if (!year) year = ym[1]; title = title.replace(/\s*\(\d{4}\)\s*$/, '').trim(); }
      const ck = 'poster-' + title + '-' + (year || '');
      if (tmdbCache[ck]) return tmdbCache[ck];
      try {
        let url = TMDB_BASE + '/search/movie?api_key=' + TMDB_KEY + '&query=' + encodeURIComponent(title);
        if (year) url += '&year=' + year;
        let r = await fetch(url); if (!r.ok) return null;
        let d = await r.json();
        if ((!d.results || !d.results.length) && year) {
          r = await fetch(TMDB_BASE + '/search/movie?api_key=' + TMDB_KEY + '&query=' + encodeURIComponent(title));
          if (!r.ok) return null; d = await r.json();
        }
        if (!d.results || !d.results.length || !d.results[0].poster_path) return null;
        const posterUrl = 'https://image.tmdb.org/t/p/w500' + d.results[0].poster_path;
        tmdbCache[ck] = posterUrl;
        return posterUrl;
      } catch (e) { return null; }
    }

    if (!window.supabase) {
      document.getElementById('ledger-grid').innerHTML =
        '<p style="text-align:center;padding:40px;color:var(--text-muted);">Loading failed — please refresh the page.</p>';
      throw new Error('Supabase library not loaded');
    }
    const supabaseClient = window.supabase.createClient(SB_URL, SB_KEY);
    const elGrid = document.getElementById('ledger-grid');
    const elAuthBtn = document.getElementById('auth-btn');
    const elLogoutBtn = document.getElementById('logout-btn');
    const elError = document.getElementById('error-log');
    const elSearch = document.getElementById('search-input');
    const elSort = document.getElementById('sort-select');

    let currentUser = localStorage.getItem('reviewer');
    let sessionToken = localStorage.getItem('session_token');
    let selectedReviewer = null;
    const isAdmin = () => currentUser === 'admin';
    // Admin can act as either reviewer
    const canActAs = (who) => currentUser === who || isAdmin();

    let cachedGregItems = [];
    let cachedPeerMap = {};
    let cachedReactions = {};
    let cachedNotesMap = {};
    let activeFilter = 'all';
    let visibleCount = PAGE_SIZE; // How many films currently shown
    let isInitialRender = true;

    /* ═══════════════════════════════════════════
       TOAST NOTIFICATIONS
    ═══════════════════════════════════════════ */
    function showToast(message, type = 'info', duration = 3000) {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;

      const icons = { success: '\u2714', error: '\u2718', info: '\u2139' };
      toast.innerHTML = `<span class="toast-icon">${icons[type] || icons.info}</span><span>${message}</span>`;

      container.appendChild(toast);

      setTimeout(() => {
        toast.classList.add('leaving');
        toast.addEventListener('animationend', () => toast.remove());
        setTimeout(() => { if (toast.parentNode) toast.remove(); }, 500);
      }, duration);
    }

    /* ═══════════════════════════════════════════
       DARK MODE
    ═══════════════════════════════════════════ */
    function getTheme() { return localStorage.getItem('dufive-theme') || 'light'; }
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('dufive-theme', theme);
      document.getElementById('theme-icon').innerHTML = theme === 'dark' ? '&#9788;' : '&#9790;';
    }
    setTheme(getTheme());

    // ───── Hamburger menu toggle ─────
    const elHamburger = document.getElementById('hamburger');
    const elNavControls = document.getElementById('nav-controls');
    elHamburger.addEventListener('click', (e) => {
      e.stopPropagation();
      elNavControls.classList.toggle('open');
    });
    document.addEventListener('click', (e) => {
      if (!e.target.closest('nav')) elNavControls.classList.remove('open');
      // Dismiss any open poster info panels when clicking outside
      if (!e.target.closest('.poster-frame')) {
        document.querySelectorAll('.poster-frame.revealed').forEach(pf => pf.classList.remove('revealed'));
      }
    });

    document.getElementById('theme-toggle').addEventListener('click', () => {
      const next = getTheme() === 'light' ? 'dark' : 'light';
      setTheme(next);
      showToast(`${next === 'dark' ? 'Dark' : 'Light'} mode enabled`, 'info', 1500);
    });

    /* ═══════════════════════════════════════════
       SCROLL TO TOP
    ═══════════════════════════════════════════ */
    const scrollTopBtn = document.getElementById('scroll-top');
    window.addEventListener('scroll', () => {
      scrollTopBtn.classList.toggle('visible', window.scrollY > 600);
    }, { passive: true });

    scrollTopBtn.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    /* ═══════════════════════════════════════════
       PULL TO REFRESH (mobile)
    ═══════════════════════════════════════════ */
    let pullStartY = 0;
    let isPulling = false;
    let isRefreshing = false;

    document.addEventListener('touchstart', (e) => {
      if (window.scrollY === 0 && !isRefreshing) {
        pullStartY = e.touches[0].clientY;
        isPulling = true;
      }
    }, { passive: true });

    document.addEventListener('touchmove', (e) => {
      if (!isPulling || isRefreshing) return;
      const diff = e.touches[0].clientY - pullStartY;
      if (diff > 80 && window.scrollY === 0) {
        document.getElementById('pull-indicator').classList.add('visible');
      }
    }, { passive: true });

    document.addEventListener('touchend', async () => {
      if (!isPulling) return;
      isPulling = false;
      const indicator = document.getElementById('pull-indicator');
      if (indicator.classList.contains('visible')) {
        isRefreshing = true;
        await loadArchive(true);
        indicator.classList.remove('visible');
        isRefreshing = false;
        showToast('Refreshed', 'success', 1500);
      }
    });

    /* ═══════════════════════════════════════════
       HELPERS
    ═══════════════════════════════════════════ */
    function setError(msg) {
      elError.textContent = msg || '';
      elError.style.display = msg ? 'block' : 'none';
    }

    function setAuthUI() {
      const elBackupBtn = document.getElementById('backup-btn');
      if (currentUser) {
        elAuthBtn.textContent = `${currentUser.toUpperCase()} \u2022 Online`;
        elAuthBtn.classList.remove('greg-active', 'peer-active', 'admin-active');
        elAuthBtn.classList.add(`${currentUser}-active`);
        elLogoutBtn.classList.add('visible');
        elNotifWrapper.classList.add('visible');
        elSyncBtn.classList.add('visible');
        elLogFilmBtn.style.display = '';
        elBackupBtn.style.display = isAdmin() ? '' : 'none';
      } else {
        elAuthBtn.textContent = 'Reviewer Login';
        elAuthBtn.classList.remove('greg-active', 'peer-active', 'admin-active');
        elLogoutBtn.classList.remove('visible');
        elNotifWrapper.classList.remove('visible');
        elNotifDropdown.classList.remove('open');
        elSyncBtn.classList.remove('visible');
        elLogFilmBtn.style.display = 'none';
        elBackupBtn.style.display = 'none';
      }
    }

    function starsFromNumeric(n) {
      const num = Number(n);
      if (!Number.isFinite(num) || num <= 0) return null;
      const full = Math.floor(num);
      const half = (num - full) >= 0.5 ? '\u00BD' : '';
      const empty = 5 - full - (half ? 1 : 0);
      return '\u2726'.repeat(full) + half + '\u2727'.repeat(Math.max(0, empty));
    }

    function timeAgo(dateString) {
      const date = new Date(dateString);
      const now = new Date();
      const seconds = Math.floor((now - date) / 1000);
      if (seconds < 60) return 'Just now';
      if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
      if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
      if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    function decodeHtml(html) {
      const txt = document.createElement('textarea');
      txt.innerHTML = html;
      return txt.value;
    }

    /* ═══════════════════════════════════════════
       NOTIFICATION BELL
    ═══════════════════════════════════════════ */
    const elSyncBtn = document.getElementById('sync-btn');
    const elNotifWrapper = document.getElementById('notif-wrapper');
    const elNotifBell = document.getElementById('notif-bell');
    const elNotifBadge = document.getElementById('notif-badge');
    const elNotifDropdown = document.getElementById('notif-dropdown');
    const elNotifList = document.getElementById('notif-list');

    function getNotifSeenKey() {
      return currentUser ? `dufive-notif-seen-${currentUser}` : null;
    }
    function getNotifSeen() {
      const key = getNotifSeenKey();
      if (!key) return null;
      const ts = localStorage.getItem(key);
      return ts || '2000-01-01T00:00:00Z';
    }
    function markNotifSeen() {
      const key = getNotifSeenKey();
      if (key) localStorage.setItem(key, new Date().toISOString());
    }

    async function fetchNotifications() {
      if (!currentUser) { elNotifWrapper.classList.remove('visible'); return; }
      elNotifWrapper.classList.add('visible');

      // Admin sees all activity; greg/peer see the other user's activity
      const otherUser = isAdmin() ? null : (currentUser === 'peer' ? 'greg' : 'peer');
      const since = getNotifSeen();
      const items = [];

      // Ratings by the other user (admin sees all)
      try {
        let q = supabaseClient.from('ratings')
          .select('movie_key, movie_title, rating, reviewer, created_at')
          .gt('created_at', since)
          .order('created_at', { ascending: false })
          .limit(20);
        if (otherUser) q = q.eq('reviewer', otherUser);
        const { data } = await q;
        (data || []).forEach(r => {
          items.push({
            author: r.reviewer,
            text: `rated <strong>${decodeHtml(r.movie_title || r.movie_key)}</strong> ${starsFromNumeric(r.rating) || r.rating}`,
            movieKey: r.movie_key,
            date: r.created_at
          });
        });
      } catch (e) { console.error('Notif ratings error:', e); }

      // Reactions by the other user (admin sees all)
      try {
        let q = supabaseClient.from('rating_reactions')
          .select('movie_key, reactor, reaction, created_at')
          .gt('created_at', since)
          .order('created_at', { ascending: false })
          .limit(20);
        if (otherUser) q = q.eq('reactor', otherUser);
        const { data } = await q;
        (data || []).forEach(r => {
          const emoji = REACTIONS[r.reaction] === 'costner' ? '🤠' : (REACTIONS[r.reaction] || r.reaction);
          items.push({
            author: r.reactor,
            text: `reacted ${emoji} to a film`,
            movieKey: r.movie_key,
            date: r.created_at
          });
        });
      } catch (e) { console.error('Notif reactions error:', e); }

      // Notes by the other user (admin sees all)
      try {
        let q = supabaseClient.from('film_arguments')
          .select('movie_key, author, argument, created_at')
          .gt('created_at', since)
          .order('created_at', { ascending: false })
          .limit(20);
        if (otherUser) q = q.eq('author', otherUser);
        const { data } = await q;
        (data || []).forEach(n => {
          items.push({
            author: otherUser,
            text: `posted a note: "${n.argument?.substring(0, 60)}${n.argument?.length > 60 ? '...' : ''}"`,
            movieKey: n.movie_key,
            date: n.created_at
          });
        });
      } catch (e) { console.error('Notif notes error:', e); }

      // Enrich movie titles for reactions/notes
      const keysToEnrich = items.filter(i => i.text.includes('a film')).map(i => i.movieKey);
      if (keysToEnrich.length > 0) {
        try {
          const { data: films } = await supabaseClient
            .from('greg_films')
            .select('movie_key, title')
            .in('movie_key', keysToEnrich);
          const titleMap = {};
          (films || []).forEach(f => { titleMap[f.movie_key] = f.title; });
          items.forEach(i => {
            if (titleMap[i.movieKey]) {
              i.text = i.text.replace('a film', `<strong>${decodeHtml(titleMap[i.movieKey])}</strong>`);
            }
          });
        } catch (e) {}
      }

      // Sort by date, newest first
      items.sort((a, b) => new Date(b.date) - new Date(a.date));

      // Update badge
      const count = items.length;
      elNotifBadge.textContent = count > 99 ? '99+' : count;
      elNotifBadge.classList.toggle('has-count', count > 0);

      // Render dropdown items
      elNotifList.innerHTML = '';
      if (items.length === 0) {
        elNotifList.innerHTML = '<div class="notif-empty">No new activity' + (otherUser ? ' from ' + (otherUser === 'greg' ? 'Greg' : 'Peer') : '') + '</div>';
      } else {
        items.slice(0, 30).forEach(item => {
          const el = document.createElement('div');
          el.className = 'notif-item';
          const authorName = item.author === 'greg' ? 'Greg' : 'Peer';
          el.innerHTML = `
            <div class="notif-avatar ${item.author}">${item.author === 'greg' ? 'G' : 'P'}</div>
            <div>
              <div class="notif-text"><strong>${authorName}</strong> ${item.text}</div>
              <div class="notif-time">${timeAgo(item.date)}</div>
            </div>`;
          el.onclick = () => {
            // Search for the film — use movie_key with hyphens replaced as spaces
            const searchTerm = item.movieKey.replace(/-/g, ' ');
            elSearch.value = searchTerm;
            elSearch.dispatchEvent(new Event('input'));
            elNotifDropdown.classList.remove('open');
            window.scrollTo({ top: 0, behavior: 'smooth' });
          };
          elNotifList.appendChild(el);
        });
      }
    }

    // Toggle dropdown
    elNotifBell.addEventListener('click', (e) => {
      e.stopPropagation();
      const isOpen = elNotifDropdown.classList.toggle('open');
      if (isOpen) {
        // Mark as seen when opened
        markNotifSeen();
        elNotifBadge.classList.remove('has-count');
      }
    });
    document.addEventListener('click', (e) => {
      if (!elNotifDropdown.contains(e.target) && e.target !== elNotifBell) {
        elNotifDropdown.classList.remove('open');
      }
    });

    /* ═══════════════════════════════════════════
       ACHIEVEMENT BADGES
    ═══════════════════════════════════════════ */
    async function fetchBadges() {
      try {
        const { data, error } = await supabaseClient
          .from('achievements')
          .select('reviewer, badge_key, badge_name, badge_icon, badge_desc, earned_at')
          .order('earned_at', { ascending: true });

        if (error || !data || data.length === 0) return;

        const gregBadges = data.filter(b => b.reviewer === 'greg');
        const peerBadges = data.filter(b => b.reviewer === 'peer');

        function renderRow(badges, containerId, label, cssClass) {
          const container = document.getElementById(containerId);
          if (!container) return;
          container.innerHTML = `<span class="badges-row-label ${cssClass}">${label}</span>`;
          if (badges.length === 0) {
            container.innerHTML += '<span class="no-badges">No badges yet</span>';
          } else {
            badges.forEach(b => {
              const chip = document.createElement('span');
              chip.className = 'badge-chip';
              chip.title = b.badge_desc || b.badge_name;
              chip.innerHTML = `<span class="badge-icon">${b.badge_icon}</span><span class="badge-name">${b.badge_name}</span>`;
              container.appendChild(chip);
            });
          }
        }

        renderRow(gregBadges, 'badges-greg', 'Greg', 'greg');
        renderRow(peerBadges, 'badges-peer', 'Peer', 'peer');
        const badgesEl = document.getElementById('badges-section');
        if (badgesEl) badgesEl.style.display = 'flex';
      } catch (e) {
        console.log('Badges fetch error:', e);
      }
    }

    /* ═══════════════════════════════════════════
       NEW SINCE LAST VISIT
    ═══════════════════════════════════════════ */
    function getLastVisit() {
      const ts = localStorage.getItem('dufive-last-visit');
      return ts ? new Date(ts) : null;
    }
    function setLastVisit() {
      localStorage.setItem('dufive-last-visit', new Date().toISOString());
    }
    function isNewSinceLastVisit(dateString) {
      const lastVisit = getLastVisit();
      if (!lastVisit) return false;
      return new Date(dateString) > lastVisit;
    }

    /* ═══════════════════════════════════════════
       SKELETON LOADER
    ═══════════════════════════════════════════ */
    function showSkeletons(count) {
      elGrid.innerHTML = '';
      for (let i = 0; i < count; i++) {
        const card = document.createElement('div');
        card.className = 'skeleton-card';
        card.innerHTML = `
          <div class="skeleton-poster"></div>
          <div class="skeleton-content">
            <div class="skeleton-line medium"></div>
            <div class="skeleton-line short"></div>
            <div class="skeleton-line short"></div>
          </div>`;
        elGrid.appendChild(card);
      }
    }

    /* ═══════════════════════════════════════════
       STATS DASHBOARD
    ═══════════════════════════════════════════ */
    function computeStats(gregItems, peerMap) {
      const total = gregItems.length;
      let gregSum = 0, gregCount = 0, peerSum = 0, peerCount = 0;
      let agreeCount = 0, bothRated = 0, maxGap = 0;
      let controversialTitle = '\u2014', controversialKey = null;

      gregItems.forEach(entry => {
        const movieKey = getMovieKey(entry);
        const gregR = Number(entry.gregRating);
        const peerR = Number(peerMap[movieKey]);

        if (Number.isFinite(gregR) && gregR > 0) { gregSum += gregR; gregCount++; }
        if (Number.isFinite(peerR) && peerR > 0) { peerSum += peerR; peerCount++; }

        if (Number.isFinite(gregR) && gregR > 0 && Number.isFinite(peerR) && peerR > 0) {
          bothRated++;
          const gap = Math.abs(gregR - peerR);
          if (gap <= 0.5) agreeCount++;
          if (gap > maxGap) {
            maxGap = gap;
            controversialTitle = decodeHtml(entry.title);
            controversialKey = movieKey;
          }
        }
      });

      const gregAvg = gregCount > 0 ? (gregSum / gregCount).toFixed(1) : '\u2014';
      const peerAvg = peerCount > 0 ? (peerSum / peerCount).toFixed(1) : '\u2014';
      const agreePct = bothRated > 0 ? Math.round((agreeCount / bothRated) * 100) + '%' : '\u2014';

      document.getElementById('stat-total').textContent = total;
      document.getElementById('stat-greg-avg').textContent = gregAvg !== '\u2014' ? gregAvg + ' \u2726' : '\u2014';
      document.getElementById('stat-peer-avg').textContent = peerAvg !== '\u2014' ? peerAvg + ' \u2726' : '\u2014';
      document.getElementById('stat-agreement').textContent = agreePct;

      const controversialEl = document.getElementById('stat-controversial');
      controversialEl.textContent = controversialTitle;
      controversialEl.title = controversialTitle;

      // Make clickable — search for the film and scroll to it
      const statCard = controversialEl.closest('.stat-card');
      if (controversialKey) {
        statCard.style.cursor = 'pointer';
        statCard.onclick = () => {
          elSearch.value = controversialTitle;
          elSearch.dispatchEvent(new Event('input'));
          elSearch.focus();
          window.scrollTo({ top: elGrid.offsetTop - 80, behavior: 'smooth' });
        };
      }

      document.getElementById('stats-bar').classList.add('visible');

      // Pull quote removed — element no longer in DOM
    }

    /* ═══════════════════════════════════════════
       DATA FETCHING
    ═══════════════════════════════════════════ */
    async function fetchPeerRatings() {
      const { data, error } = await supabaseClient
        .from('ratings').select('movie_key,movie_title,rating')
        .eq('reviewer', 'peer');
      if (error) throw new Error('Ratings Error: ' + error.message);
      const map = Object.create(null);
      (data || []).forEach(r => { if (r?.movie_key) map[r.movie_key] = r.rating; });
      return map;
    }

    async function fetchGregWebRatings() {
      const { data, error } = await supabaseClient
        .from('ratings').select('movie_key,rating')
        .eq('reviewer', 'greg');
      if (error) { console.error('Greg web ratings error:', error); return Object.create(null); }
      const map = Object.create(null);
      (data || []).forEach(r => { if (r?.movie_key) map[r.movie_key] = r.rating; });
      return map;
    }

    const EMPTY_POSTER = 'empty-poster'; // Letterboxd placeholder token

    // Fix Letterboxd CDN poster URLs for hotlinking.
    // Both film-poster/ and sm/upload/ URLs work at the 0-230-0-345-crop size.
    // We only need to filter out empty-poster placeholders.
    function fixPosterUrl(url) {
      if (!url || url.includes(EMPTY_POSTER)) return null;
      return url;
    }

    async function fetchGregFilms() {
      // Supabase caps responses at max-rows (default 1000).
      // Paginate with .range() to fetch ALL films in batches.
      const BATCH = 1000;
      let allData = [];
      let from = 0;
      let keepGoing = true;
      while (keepGoing) {
        const { data, error } = await supabaseClient
          .from('greg_films')
          .select('id, movie_key, title, poster_url, greg_rating, letterboxd_url, updated_at, watched_date')
          .order('id', { ascending: true })
          .range(from, from + BATCH - 1);
        if (error) throw new Error('Greg Films Error: ' + error.message);
        const rows = data || [];
        allData = allData.concat(rows);
        keepGoing = rows.length === BATCH;
        from += BATCH;
      }
      // Normalise into the shape the rest of the code expects
      return allData.map(f => ({
        title: f.title,
        movieKey: f.movie_key,
        posterUrl: fixPosterUrl(f.poster_url),
        gregRating: f.greg_rating,
        link: f.letterboxd_url || '',
        pubDate: f.updated_at,
        sortId: f.id,
        watchedDate: f.watched_date || null
      }));
    }

    async function fetchReactions() {
      const { data, error } = await supabaseClient.from('rating_reactions').select('*');
      if (error) throw new Error('Reactions Error: ' + error.message);
      const map = {};
      (data || []).forEach(r => {
        if (!map[r.movie_key]) map[r.movie_key] = {};
        map[r.movie_key][r.reactor] = r.reaction;
      });
      return map;
    }

    async function fetchNotes() {
      const { data, error } = await supabaseClient
        .from('film_arguments').select('*')
        .order('created_at', { ascending: true });
      if (error) throw new Error('Notes Error: ' + error.message);
      const map = {};
      (data || []).forEach(note => {
        if (!map[note.movie_key]) map[note.movie_key] = [];
        map[note.movie_key].push(note);
      });
      return map;
    }

    /* ═══════════════════════════════════════════
       SEARCH / SORT / FILTER
    ═══════════════════════════════════════════ */
    function getMovieKey(entry) {
      return entry.movieKey || entry.link?.split('/film/')[1]?.replace('/', '') || entry.title;
    }

    function getFilteredAndSorted() {
      let items = [...cachedGregItems];
      const searchTerm = elSearch.value.trim().toLowerCase();
      const sortBy = elSort.value;

      if (searchTerm) {
        items = items.filter(e => decodeHtml(e.title).toLowerCase().includes(searchTerm));
      }

      if (activeFilter === 'greg-rated') {
        items = items.filter(e => {
          const gR = Number(e.gregRating);
          return Number.isFinite(gR) && gR > 0;
        });
      } else if (activeFilter === 'peer-rated') {
        items = items.filter(e => {
          const pR = Number(cachedPeerMap[getMovieKey(e)]);
          return Number.isFinite(pR) && pR > 0;
        });
      } else if (activeFilter === 'both-rated') {
        items = items.filter(e => {
          const pR = Number(cachedPeerMap[getMovieKey(e)]);
          const gR = Number(e.gregRating);
          return Number.isFinite(gR) && gR > 0 && Number.isFinite(pR) && pR > 0;
        });
      } else if (activeFilter === 'peer-unrated') {
        items = items.filter(e => {
          const pR = Number(cachedPeerMap[getMovieKey(e)]);
          return !Number.isFinite(pR) || pR <= 0;
        });
      } else if (activeFilter === 'greg-unrated') {
        items = items.filter(e => {
          const gR = Number(e.gregRating);
          return !Number.isFinite(gR) || gR <= 0;
        });
      }

      items.sort((a, b) => {
        const gA = Number(a.gregRating) || 0;
        const gB = Number(b.gregRating) || 0;
        const pA = Number(cachedPeerMap[getMovieKey(a)]) || 0;
        const pB = Number(cachedPeerMap[getMovieKey(b)]) || 0;

        switch (sortBy) {
          case 'date': {
            // Newest first — use watched_date from Letterboxd diary
            // Films with a diary date sort by date descending (newest first).
            // Films without a diary date fall to the end, sorted by sortId.
            const dateA = a.watchedDate ? new Date(a.watchedDate).getTime() : 0;
            const dateB = b.watchedDate ? new Date(b.watchedDate).getTime() : 0;
            if (dateA && dateB) return dateB - dateA;
            if (dateA && !dateB) return -1;
            if (!dateA && dateB) return 1;
            return (a.sortId || 0) - (b.sortId || 0);
          }
          case 'greg-high': {
            // Rated films first, then by rating desc, then alphabetical
            if (gA > 0 && gB <= 0) return -1;
            if (gB > 0 && gA <= 0) return 1;
            return gB - gA || a.title.localeCompare(b.title);
          }
          case 'greg-low': {
            // Rated films first, then by rating asc, then alphabetical
            if (gA > 0 && gB <= 0) return -1;
            if (gB > 0 && gA <= 0) return 1;
            return gA - gB || a.title.localeCompare(b.title);
          }
          case 'peer-high': {
            if (pA > 0 && pB <= 0) return -1;
            if (pB > 0 && pA <= 0) return 1;
            if (pA <= 0 && pB <= 0) return a.title.localeCompare(b.title);
            return pB - pA || a.title.localeCompare(b.title);
          }
          case 'peer-low': {
            if (pA > 0 && pB <= 0) return -1;
            if (pB > 0 && pA <= 0) return 1;
            if (pA <= 0 && pB <= 0) return a.title.localeCompare(b.title);
            return pA - pB || a.title.localeCompare(b.title);
          }
          case 'gap': {
            const gapA = (gA > 0 && pA > 0) ? Math.abs(gA - pA) : -1;
            const gapB = (gB > 0 && pB > 0) ? Math.abs(gB - pB) : -1;
            return gapB - gapA;
          }
          default: return 0;
        }
      });

      return items;
    }

    function rerender(resetPage = true) {
      if (resetPage) visibleCount = PAGE_SIZE;
      const items = getFilteredAndSorted();
      renderLedger(items, cachedPeerMap, cachedReactions, cachedNotesMap);
    }

    const elSearchClear = document.getElementById('search-clear');
    let searchDebounce;
    elSearch.addEventListener('input', () => {
      clearTimeout(searchDebounce);
      elSearchClear.classList.toggle('visible', elSearch.value.length > 0);
      searchDebounce = setTimeout(() => rerender(true), 200);
    });
    elSearchClear.addEventListener('click', () => {
      elSearch.value = '';
      elSearchClear.classList.remove('visible');
      rerender(true);
      elSearch.focus();
    });
    elSort.addEventListener('change', () => rerender(true));

    document.querySelectorAll('.filter-chip').forEach(chip => {
      chip.addEventListener('click', () => {
        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        activeFilter = chip.dataset.filter;
        rerender(true);
      });
    });

    /* ═══════════════════════════════════════════
       SYNC BUTTON
       ═══════════════════════════════════════════ */
    elSyncBtn.addEventListener('click', async () => {
      if (elSyncBtn.classList.contains('syncing')) return;
      elSyncBtn.classList.add('syncing');
      elSyncBtn.querySelector('.sync-icon').textContent = '\u21bb';

      try {
        // Step 1: Sync films from Letterboxd grid + diary
        const syncRes = await fetch(SB_URL + '/functions/v1/sync-letterboxd', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: '{}'
        });
        const syncData = await syncRes.json().catch(() => ({}));
        console.log('[Sync]', syncData);

        // Step 2: Reload all data from DB
        const [gregItems, peerMap, reactions, notesMap] = await Promise.all([
          fetchGregFilms(), fetchPeerRatings(), fetchReactions(), fetchNotes()
        ]);
        cachedGregItems = gregItems;
        cachedPeerMap = peerMap;
        cachedReactions = reactions;
        cachedNotesMap = notesMap;
        rerender(true);

        showToast('Synced ' + (syncData.synced || 0) + ' films from Letterboxd');
      } catch (err) {
        console.error('[Sync] Error:', err);
        showToast('Sync failed — try again');
      } finally {
        elSyncBtn.classList.remove('syncing');
      }
    });

    /* ═══════════════════════════════════════════
       RENDER
    ═══════════════════════════════════════════ */
    function renderLedger(gregItems, peerMap, reactions, notesMap) {
      elGrid.innerHTML = '';

      if (gregItems.length === 0) {
        elGrid.innerHTML = `
          <div class="no-results">
            <div class="no-results-icon">—</div>
            <div class="no-results-text">No films found</div>
            <div class="no-results-hint">Try adjusting your search or filters.</div>
          </div>`;
        return;
      }

      const totalFiltered = gregItems.length;
      const pageItems = gregItems.slice(0, visibleCount);

      pageItems.forEach((entry, index) => {
        const title = entry.title;
        const movieKey = getMovieKey(entry);
        const notes = notesMap[movieKey] || [];
        const hasNewNotes = notes.some(n => isNewSinceLastVisit(n.created_at));

        const gregR = Number(entry.gregRating) || 0;
        const peerR = Number(peerMap[movieKey]) || 0;

        const card = document.createElement('div');
        card.className = isInitialRender ? 'entry' : 'entry no-animate';
        card.dataset.movieKey = movieKey;

        // New badge
        if (hasNewNotes) {
          const badge = document.createElement('div');
          badge.className = 'new-badge';
          badge.textContent = 'NEW';
          card.appendChild(badge);
        }

        // Poster with fallback
        const posterFrame = document.createElement('div');
        posterFrame.className = 'poster-frame';

        // ── Poster corner reaction badges ──
        const peerReactionToGreg = reactions[movieKey]?.peer;
        const gregReactionToPeer = reactions[movieKey]?.greg;

        function makeBadge(reactionKey, who, side) {
          const badge = document.createElement('div');
          badge.className = 'poster-badge ' + side + (canActAs(who) ? ' clickable' : '');
          badge.title = (who === 'peer' ? "Peer" : "Greg") + "'s reaction: " + reactionKey;
          if (reactionKey === 'costner') {
            badge.innerHTML = `<img class="kc-face" src="${KC_IMG}" alt="Costner">`;
          } else {
            badge.textContent = REACTIONS[reactionKey];
          }
          const whoTag = document.createElement('span');
          whoTag.className = 'badge-who ' + (who === 'peer' ? 'peer-who' : 'greg-who');
          whoTag.textContent = who === 'peer' ? 'P' : 'G';
          badge.appendChild(whoTag);
          if (canActAs(who)) {
            badge.dataset.hasReaction = 'true';
            badge.title += ' (click to remove)';
            badge.onclick = (e) => { e.stopPropagation(); deleteReaction(movieKey, who); };
          }
          return badge;
        }

        if (peerReactionToGreg && REACTIONS[peerReactionToGreg]) {
          posterFrame.appendChild(makeBadge(peerReactionToGreg, 'peer', 'left'));
        }
        if (gregReactionToPeer && REACTIONS[gregReactionToPeer]) {
          posterFrame.appendChild(makeBadge(gregReactionToPeer, 'greg', 'right'));
        }

        if (entry.posterUrl) {
          const img = document.createElement('img');
          img.alt = decodeHtml(title);
          img.loading = 'lazy';
          img.src = entry.posterUrl;
          img.onerror = function() {
            // Stored URL broken — try TMDB as fallback
            this.style.display = 'none';
            fetchTMDBPoster(title, entry.year || movieKey.match(/-(\d{4})$/)?.[1] || '').then(tmdbUrl => {
              if (tmdbUrl) {
                const tmdbImg = document.createElement('img');
                tmdbImg.alt = decodeHtml(title);
                tmdbImg.src = tmdbUrl;
                tmdbImg.style.cssText = 'width:100%;height:100%;object-fit:cover;';
                posterFrame.appendChild(tmdbImg);
              } else {
                const fallback = document.createElement('div');
                fallback.className = 'poster-fallback';
                fallback.innerHTML = `<div><div class="poster-fallback-icon">D5</div><div class="poster-fallback-text">${decodeHtml(title)}</div></div>`;
                posterFrame.appendChild(fallback);
              }
            });
          };
          posterFrame.appendChild(img);
        } else {
          // No stored poster — try TMDB
          const placeholder = document.createElement('div');
          placeholder.className = 'poster-fallback';
          placeholder.innerHTML = `<div><div class="poster-fallback-icon">D5</div><div class="poster-fallback-text">${decodeHtml(title)}</div></div>`;
          posterFrame.appendChild(placeholder);
          fetchTMDBPoster(title, entry.year || movieKey.match(/-(\d{4})$/)?.[1] || '').then(tmdbUrl => {
            if (tmdbUrl) {
              const img = document.createElement('img');
              img.alt = decodeHtml(title);
              img.src = tmdbUrl;
              img.style.cssText = 'width:100%;height:100%;object-fit:cover;';
              placeholder.replaceWith(img);
            }
          });
        }

        // Info overlay (populated on first click via TMDB)
        const infoPanel = document.createElement('div');
        infoPanel.className = 'poster-info';
        posterFrame.appendChild(infoPanel);

        const content = document.createElement('div');
        content.className = 'entry-content';

        const h2 = document.createElement('h2');
        h2.className = 'entry-title';
        h2.textContent = decodeHtml(title);

        const ratingsContainer = document.createElement('div');
        ratingsContainer.className = 'ratings-container';

        // Greg rating row with avatar
        const gregRow = document.createElement('div');
        gregRow.className = 'rating-row';

        const gregLabelGroup = document.createElement('div');
        gregLabelGroup.className = 'rating-label-group';
        gregLabelGroup.innerHTML = '<div class="avatar greg-avatar">G</div><span class="rating-label">Greg</span>';

        // Greg rating: show Letterboxd rating, allow Greg to edit via app
        // Blind mode: when Peer is logged in and hasn't rated this film,
        // hide Greg's rating so Peer isn't influenced.
        const peerHasRated = peerMap[movieKey] > 0;
        const blindMode = currentUser === 'peer' && !peerHasRated;
        const gregStars = starsFromNumeric(entry.gregRating);
        const gregValSpan = document.createElement('span');

        if (blindMode && gregStars) {
          gregValSpan.className = 'rating-value blind-rating';
          gregValSpan.textContent = '???';
          gregValSpan.title = 'Rate this film first to reveal Greg\u2019s rating';
        } else if (gregStars) {
          gregValSpan.className = 'rating-value' + (canActAs('greg') ? ' editable' : '');
          gregValSpan.textContent = gregStars;
          if (canActAs('greg')) {
            gregValSpan.onclick = () => showStarPicker(movieKey, title, entry.gregRating, 'greg');
          }
        } else {
          gregValSpan.className = 'rating-value';
          const unrated = document.createElement('span');
          unrated.className = 'unrated-prompt' + (canActAs('greg') ? ' clickable' : '');
          unrated.textContent = canActAs('greg') ? 'Tap to rate' : '\u2014';
          if (canActAs('greg')) {
            unrated.onclick = () => showStarPicker(movieKey, title, null, 'greg');
          }
          gregValSpan.appendChild(unrated);
        }

        gregRow.appendChild(gregLabelGroup);
        gregRow.appendChild(gregValSpan);
        ratingsContainer.appendChild(gregRow);

        // Peer rating row with avatar
        const peerRow = document.createElement('div');
        peerRow.className = 'rating-row';

        const peerLabelGroup = document.createElement('div');
        peerLabelGroup.className = 'rating-label-group';
        peerLabelGroup.innerHTML = '<div class="avatar peer-avatar">P</div><span class="rating-label">Peer</span>';

        const peerStars = starsFromNumeric(peerMap[movieKey]);
        const peerRatingSpan = document.createElement('span');

        if (peerStars) {
          peerRatingSpan.className = 'rating-value' + (canActAs('peer') ? ' editable' : '');
          peerRatingSpan.textContent = peerStars;
          if (canActAs('peer')) {
            peerRatingSpan.onclick = () => showStarPicker(movieKey, title, peerMap[movieKey], 'peer');
          }
        } else {
          peerRatingSpan.className = 'rating-value';
          const unrated = document.createElement('span');
          unrated.className = 'unrated-prompt' + (canActAs('peer') ? ' clickable' : '');
          unrated.textContent = canActAs('peer') ? 'Tap to rate' : '\u2014';
          if (canActAs('peer')) {
            unrated.onclick = () => showStarPicker(movieKey, title, null, 'peer');
          }
          peerRatingSpan.appendChild(unrated);
        }

        peerRow.appendChild(peerLabelGroup);
        peerRow.appendChild(peerRatingSpan);
        ratingsContainer.appendChild(peerRow);

        /* comparison bars removed – stars already convey the rating */

        content.appendChild(h2);
        content.appendChild(ratingsContainer);

        // Inline reaction pills (always visible when logged in)
        if (canActAs('peer')) {
          content.appendChild(buildReactionPills('React to Greg', movieKey, 'peer', peerReactionToGreg));
        }
        if (canActAs('greg')) {
          content.appendChild(buildReactionPills('React to Peer', movieKey, 'greg', gregReactionToPeer));
        }

        // Discussion
        if (currentUser || notes.length > 0) {
          const trigger = document.createElement('div');
          trigger.className = 'discussion-trigger' + (notes.length > 0 ? ' has-notes' : '');
          const countSpan = document.createElement('span');
          countSpan.className = 'discussion-count';
          countSpan.textContent = notes.length > 0 ? `Discussion (${notes.length})` : 'Add note';
          const chevron = document.createElement('span');
          chevron.className = 'chevron';
          chevron.textContent = '\u25BC';
          trigger.appendChild(countSpan);
          trigger.appendChild(chevron);

          const discussionSection = document.createElement('div');
          discussionSection.className = 'discussion-section';

          if (notes.length > 0) {
            const discussionTitle = document.createElement('div');
            discussionTitle.className = 'discussion-title';
            discussionTitle.textContent = 'Discussion';
            discussionSection.appendChild(discussionTitle);

            notes.forEach(note => {
              const noteEl = document.createElement('div');
              noteEl.className = 'note';

              const noteHeader = document.createElement('div');
              noteHeader.className = 'note-header';

              const authorGroup = document.createElement('div');
              authorGroup.className = 'note-author-group';

              const noteAvatar = document.createElement('div');
              noteAvatar.className = `note-avatar ${note.author}`;
              noteAvatar.textContent = note.author === 'greg' ? 'G' : 'P';

              const noteAuthor = document.createElement('div');
              noteAuthor.className = `note-author ${note.author}`;
              noteAuthor.textContent = note.author.toUpperCase();

              authorGroup.appendChild(noteAvatar);
              authorGroup.appendChild(noteAuthor);

              const noteMeta = document.createElement('div');
              noteMeta.className = 'note-meta';

              const noteTime = document.createElement('span');
              noteTime.className = 'note-time';
              noteTime.textContent = timeAgo(note.created_at);
              noteMeta.appendChild(noteTime);

              if (currentUser && (note.author === currentUser || isAdmin())) {
                const delBtn = document.createElement('span');
                delBtn.className = 'note-delete';
                delBtn.textContent = '\u2715';
                delBtn.onclick = (e) => { e.stopPropagation(); deleteNote(note.id); };
                noteMeta.appendChild(delBtn);
              }

              noteHeader.appendChild(authorGroup);
              noteHeader.appendChild(noteMeta);

              const noteText = document.createElement('div');
              noteText.className = 'note-text';
              noteText.textContent = note.argument;

              noteEl.appendChild(noteHeader);
              noteEl.appendChild(noteText);
              discussionSection.appendChild(noteEl);
            });
          }

          if (currentUser) {
            const form = document.createElement('div');
            form.className = 'note-form';

            const input = document.createElement('textarea');
            input.className = 'note-input';
            input.placeholder = `Share your thoughts as ${currentUser.toUpperCase()}...`;
            input.maxLength = 200;

            const charCount = document.createElement('div');
            charCount.className = 'note-char-count';
            charCount.textContent = '0 / 200';
            input.addEventListener('input', () => {
              charCount.textContent = `${input.value.length} / 200`;
              charCount.style.color = input.value.length >= 180 ? 'var(--text)' : '';
            });

            const submit = document.createElement('button');
            submit.className = 'note-submit';
            submit.textContent = 'Post Note';
            submit.onclick = async (e) => {
              e.stopPropagation();
              if (!input.value.trim()) return;
              submit.disabled = true;
              submit.textContent = 'Posting...';
              await submitNote(movieKey, input.value.trim());
              submit.disabled = false;
              submit.textContent = 'Post Note';
            };

            form.appendChild(input);
            form.appendChild(charCount);
            form.appendChild(submit);
            discussionSection.appendChild(form);
          }

          trigger.onclick = (e) => {
            e.stopPropagation();
            const isExpanded = discussionSection.classList.toggle('expanded');
            chevron.classList.toggle('rotated', isExpanded);
          };

          content.appendChild(trigger);
          card.appendChild(posterFrame);
          card.appendChild(content);
          card.appendChild(discussionSection);
        } else {
          card.appendChild(posterFrame);
          card.appendChild(content);
        }

        // Delete film button (logged-in only)
        if (currentUser) {
          const delBtn = document.createElement('button');
          delBtn.className = 'delete-film-btn';
          delBtn.textContent = 'Delete';
          delBtn.onclick = (e) => {
            e.stopPropagation();
            showDeleteFilmModal(title, movieKey);
          };
          card.appendChild(delBtn);
        }

        // Add to Queue / Rewatch button (logged-in only)
        // Films on The Ledger have already been watched, so this is a "Rewatch" action
        if (currentUser) {
          const queueBtn = document.createElement('button');
          queueBtn.className = 'add-queue-btn';
          queueBtn.textContent = '\u21BB Rewatch';
          queueBtn.onclick = async (e) => {
            e.stopPropagation();
            queueBtn.disabled = true;
            queueBtn.textContent = 'Adding\u2026';
            try {
              const assignTo = isAdmin() ? 'both' : currentUser;
              const res = await authenticatedRequest('watchlist_add', movieKey, {
                title: title,
                posterUrl: entry.posterUrl || null,
                assignedTo: assignTo,
                priority: 'medium',
                isRewatch: true
              });
              if (!res) throw new Error('Request failed');
              showToast('Added to The Queue for rewatch', 'success', 2000);
              queueBtn.textContent = '\u2713 Queued';
              setTimeout(() => { queueBtn.textContent = '\u21BB Rewatch'; queueBtn.disabled = false; }, 2000);
            } catch (err) {
              showToast('Failed to add to queue', 'error');
              queueBtn.textContent = '\u21BB Rewatch';
              queueBtn.disabled = false;
            }
          };
          card.appendChild(queueBtn);
        }

        // Click poster to reveal TMDB info (fade dissolve)
        posterFrame.style.cursor = 'pointer';
        posterFrame.addEventListener('click', async (e) => {
          if (e.target.closest('.poster-badge')) return;
          // Close any other open poster-info panels
          document.querySelectorAll('.poster-frame.revealed').forEach(pf => {
            if (pf !== posterFrame) pf.classList.remove('revealed');
          });

          posterFrame.classList.toggle('revealed');

          if (posterFrame.classList.contains('revealed')) {
            const info = posterFrame.querySelector('.poster-info');
            if (!info.dataset.loaded) {
              info.innerHTML = '<div class="poster-info-loading">Loading\u2026</div>';
              const year = entry.year || movieKey.match(/-(\d{4})$/)?.[1] || '';
              const data = await fetchTMDBDetails(title, year);
              if (data) {
                const genreHtml = data.genres.map(g => '<span class="poster-info-genre">' + g + '</span>').join('');
                const metaParts = [data.director, data.runtime, data.year].filter(Boolean);
                const castLine = data.cast.length ? data.cast.join(', ') : '';
                info.innerHTML =
                  '<div class="poster-info-title">' + data.title + '</div>' +
                  '<div class="poster-info-meta">' + metaParts.join(' \u2022 ') + '</div>' +
                  (castLine ? '<div class="poster-info-cast">' + castLine + '</div>' : '') +
                  (genreHtml ? '<div class="poster-info-genres">' + genreHtml + '</div>' : '') +
                  (data.tagline ? '<div class="poster-info-tagline">\u201C' + data.tagline + '\u201D</div>' : '') +
                  (data.overview ? '<div class="poster-info-synopsis">' + data.overview + '</div>' : '');
              } else {
                info.innerHTML = '<div class="poster-info-loading">No details found</div>';
              }
              info.dataset.loaded = 'true';
            }
          }
        });

        elGrid.appendChild(card);
      });

      // Load More button
      if (visibleCount < totalFiltered) {
        const remaining = totalFiltered - visibleCount;
        const wrapper = document.createElement('div');
        wrapper.className = 'load-more-wrapper';

        const btn = document.createElement('button');
        btn.className = 'load-more-btn';
        btn.textContent = `Load More Films`;
        btn.onclick = () => {
          const scrollPos = window.scrollY;
          visibleCount += PAGE_SIZE;
          rerender(false);
          window.scrollTo(0, scrollPos);
        };

        const count = document.createElement('div');
        count.className = 'load-more-count';
        count.textContent = `Showing ${pageItems.length} of ${totalFiltered} films \u2022 ${remaining} more`;

        wrapper.appendChild(btn);
        wrapper.appendChild(count);
        elGrid.appendChild(wrapper);
      } else if (totalFiltered > PAGE_SIZE) {
        // Show "all loaded" indicator
        const count = document.createElement('div');
        count.className = 'load-more-wrapper';
        const countText = document.createElement('div');
        countText.className = 'load-more-count';
        countText.textContent = `All ${totalFiltered} films loaded`;
        count.appendChild(countText);
        elGrid.appendChild(count);
      }
    }

    /* ═══════════════════════════════════════════
       SHAREABLE DEBATE CARD (Canvas)
    ═══════════════════════════════════════════ */
    async function generateShareCard(entry) {
      const movieKey = getMovieKey(entry);
      const title = decodeHtml(entry.title);
      const gregR = Number(entry.gregRating) || 0;
      const peerR = Number(peerMap[movieKey]) || 0;
      const gap = Math.abs(gregR - peerR);

      const W = 1080, H = 1080;
      const canvas = document.createElement('canvas');
      canvas.width = W; canvas.height = H;
      const ctx = canvas.getContext('2d');

      // Dark background gradient
      const grad = ctx.createLinearGradient(0, 0, W, H);
      grad.addColorStop(0, '#0a0a0a');
      grad.addColorStop(1, '#1a1a2e');
      ctx.fillStyle = grad;
      ctx.fillRect(0, 0, W, H);

      // Subtle accent border
      ctx.strokeStyle = 'rgba(255,255,255,0.06)';
      ctx.lineWidth = 2;
      ctx.strokeRect(40, 40, W - 80, H - 80);

      // Load poster if available
      let posterImg = null;
      if (entry.posterUrl) {
        try {
          posterImg = await new Promise((resolve, reject) => {
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = () => resolve(img);
            img.onerror = () => resolve(null);
            img.src = entry.posterUrl;
          });
        } catch(e) { posterImg = null; }
      }

      // Draw poster
      if (posterImg) {
        const pw = 240, ph = 360;
        const px = (W - pw) / 2, py = 100;
        ctx.save();
        ctx.beginPath();
        ctx.roundRect(px, py, pw, ph, 12);
        ctx.clip();
        ctx.drawImage(posterImg, px, py, pw, ph);
        ctx.restore();
        // poster shadow
        ctx.shadowColor = 'rgba(0,0,0,0.5)';
        ctx.shadowBlur = 30;
        ctx.shadowOffsetY = 10;
        ctx.beginPath();
        ctx.roundRect(px, py, pw, ph, 12);
        ctx.strokeStyle = 'rgba(255,255,255,0.08)';
        ctx.lineWidth = 1;
        ctx.stroke();
        ctx.shadowColor = 'transparent';
      }

      const textY = posterImg ? 500 : 200;

      // Movie title
      ctx.fillStyle = '#ffffff';
      ctx.textAlign = 'center';
      ctx.font = '400 42px "Playfair Display", serif';
      // Wrap long titles
      const words = title.split(' ');
      let lines = []; let line = '';
      for (const w of words) {
        const test = line ? line + ' ' + w : w;
        if (ctx.measureText(test).width > W - 160) { lines.push(line); line = w; }
        else line = test;
      }
      if (line) lines.push(line);
      lines.forEach((l, i) => {
        ctx.fillText(l, W / 2, textY + i * 52);
      });

      const ratingsY = textY + lines.length * 52 + 60;

      // Greg rating
      ctx.font = '600 22px "Instrument Sans", sans-serif';
      ctx.fillStyle = '#94a3b8';
      ctx.fillText('GREG', W / 2 - 180, ratingsY);
      ctx.font = '36px "Instrument Sans", sans-serif';
      ctx.fillStyle = '#fbbf24';
      ctx.fillText(gregR > 0 ? starsFromNumeric(gregR) : '—', W / 2 - 180, ratingsY + 48);

      // VS
      ctx.font = 'bold 28px "Instrument Sans", sans-serif';
      ctx.fillStyle = '#475569';
      ctx.fillText('VS', W / 2, ratingsY + 30);

      // Peer rating
      ctx.font = '600 22px "Instrument Sans", sans-serif';
      ctx.fillStyle = '#94a3b8';
      ctx.fillText('PEER', W / 2 + 180, ratingsY);
      ctx.font = '36px "Instrument Sans", sans-serif';
      ctx.fillStyle = '#fbbf24';
      ctx.fillText(peerR > 0 ? starsFromNumeric(peerR) : '—', W / 2 + 180, ratingsY + 48);

      // Gap badge
      if (gregR > 0 && peerR > 0) {
        const gapY = ratingsY + 110;
        let gapColor = '#8c8580';
        let gapText = `${gap}✦ gap`;
        if (gap === 0) { gapColor = '#6b6660'; gapText = 'Perfect Agreement'; }
        else if (gap <= 1) { gapColor = '#6b6660'; }
        else if (gap >= 3) { gapColor = '#1a1a1a'; gapText = `${gap}✦ gap — Big Debate`; }

        ctx.font = 'bold 24px "Instrument Sans", sans-serif';
        ctx.fillStyle = gapColor;
        ctx.fillText(gapText, W / 2, gapY);
      }

      // DUFIVE branding
      ctx.font = 'bold 20px "Instrument Sans", sans-serif';
      ctx.fillStyle = 'rgba(255,255,255,0.25)';
      ctx.fillText('dufive.com', W / 2, H - 60);

      // Download or share
      canvas.toBlob(async (blob) => {
        if (navigator.share && navigator.canShare) {
          try {
            const file = new File([blob], `dufive-${movieKey}.png`, { type: 'image/png' });
            if (navigator.canShare({ files: [file] })) {
              await navigator.share({ files: [file], title: `${title} — DUFIVE Debate`, text: `Greg: ${gregR}/10 vs Peer: ${peerR}/10` });
              return;
            }
          } catch(e) { /* fall through to download */ }
        }
        // Fallback: download
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `dufive-${movieKey}.png`;
        document.body.appendChild(a); a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast('Debate card downloaded!');
      }, 'image/png');
    }

    /* ═══════════════════════════════════════════
       STAR PICKER
    ═══════════════════════════════════════════ */
    function showStarPicker(movieKey, movieTitle, currentRating, actingAs) {
      if (!currentUser) return;
      // actingAs: which reviewer this rating is for (used by admin)
      const ratingAs = actingAs || currentUser;

      const overlay = document.getElementById('star-picker');
      let selectedValue = currentRating ? Number(currentRating) : null;

      function buildStarDisplay(val) {
        if (!val || val <= 0) return 'Select a rating';
        return starsFromNumeric(val) + ` (${val})`;
      }

      function renderPicker() {
        overlay.innerHTML = `
          <div class="star-picker-modal">
            <div class="star-picker-title">${decodeHtml(movieTitle)}</div>
            <div class="star-picker-subtitle">Select your rating</div>
            <div class="star-picker-stars" id="star-buttons"></div>
            <div class="star-picker-display" id="star-display">${buildStarDisplay(selectedValue)}</div>
            <div class="star-picker-actions">
              <button class="star-picker-cancel" id="star-cancel">Cancel</button>
              <button class="star-picker-confirm" id="star-confirm" ${!selectedValue ? 'disabled' : ''}>Confirm</button>
            </div>
            ${currentRating ? '<button class="star-picker-remove" id="star-remove">Remove rating</button>' : ''}
          </div>`;

        const starsContainer = document.getElementById('star-buttons');
        for (let val = 0.5; val <= 5; val += 0.5) {
          const btn = document.createElement('button');
          btn.className = 'star-btn';
          btn.textContent = val % 1 !== 0 ? '\u00BD' : '\u2726';
          if (selectedValue && val <= selectedValue) btn.classList.add('active');
          btn.onclick = () => {
            selectedValue = val;
            starsContainer.querySelectorAll('.star-btn').forEach((b, i) => {
              b.classList.toggle('active', (i + 1) * 0.5 <= val);
            });
            document.getElementById('star-display').textContent = buildStarDisplay(val);
            document.getElementById('star-confirm').disabled = false;
          };
          starsContainer.appendChild(btn);
        }

        document.getElementById('star-cancel').onclick = () => { overlay.style.display = 'none'; };
        document.getElementById('star-confirm').onclick = async () => {
          overlay.style.display = 'none';
          if (selectedValue) await submitRating(movieKey, movieTitle, selectedValue, ratingAs);
        };

        const removeBtn = document.getElementById('star-remove');
        if (removeBtn) {
          removeBtn.onclick = async () => {
            overlay.style.display = 'none';
            await submitRating(movieKey, movieTitle, 0, ratingAs);
          };
        }

        overlay.onclick = (e) => {
          if (e.target === overlay) overlay.style.display = 'none';
        };
      }

      renderPicker();
      overlay.style.display = 'flex';
    }

    /* ═══════════════════════════════════════════
       REACTION PILLS
    ═══════════════════════════════════════════ */
    function buildReactionPills(label, movieKey, reactor, currentReaction) {
      const row = document.createElement('div');
      row.className = 'reaction-pills';
      const lbl = document.createElement('span');
      lbl.className = 'reaction-pills-label';
      lbl.textContent = label;
      row.appendChild(lbl);

      Object.entries(REACTIONS).forEach(([key, emoji]) => {
        const pill = document.createElement('span');
        pill.className = 'reaction-pill' + (currentReaction === key ? ' active' : '');
        pill.title = key === 'costner' ? 'Costner Award (terrible movie)' : key;
        if (key === 'costner') {
          pill.innerHTML = `<img class="kc-pill" src="${KC_IMG}" alt="Costner Award">`;
        } else {
          pill.textContent = emoji;
        }
        pill.onclick = (e) => {
          e.stopPropagation();
          if (currentReaction === key) {
            deleteReaction(movieKey, reactor);
          } else {
            saveReaction(movieKey, reactor, key);
          }
        };
        row.appendChild(pill);
      });
      return row;
    }

    /* ═══════════════════════════════════════════
       AUTHENTICATED ACTIONS
    ═══════════════════════════════════════════ */
    async function authenticatedRequest(action, movieKey, data) {
      if (!sessionToken) {
        showToast('Session expired. Please login again.', 'error');
        logout(true);
        return null;
      }

      const res = await fetch(ACTIONS_FUNCTION_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${sessionToken}`
        },
        body: JSON.stringify({ action, movieKey, data })
      });

      if (res.status === 401) {
        showToast('Session expired. Please login again.', 'error');
        logout(true);
        return null;
      }

      if (!res.ok) {
        let errorMsg = 'Request failed (status ' + res.status + ')';
        try { const errorData = await res.json(); errorMsg = errorData.error || errorMsg; } catch (_) {}
        throw new Error(errorMsg);
      }

      return await res.json();
    }

    async function saveReaction(movieKey, reactor, reaction) {
      try {
        const payload = { reaction };
        if (isAdmin()) payload.actingAs = reactor;
        await authenticatedRequest('save_reaction', movieKey, payload);
        showToast('Reaction saved', 'success', 2000);
        await loadArchive(true);
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }

    async function deleteReaction(movieKey, reactor) {
      try {
        const payload = {};
        if (isAdmin()) payload.actingAs = reactor;
        await authenticatedRequest('delete_reaction', movieKey, payload);
        showToast('Reaction removed', 'info', 2000);
        await loadArchive(true);
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }

    async function submitNote(movieKey, text) {
      if (!text.trim()) return showToast('Please enter a note.', 'error');
      try {
        await authenticatedRequest('post_note', movieKey, { text });
        showToast('Note posted', 'success', 2000);
        await loadArchive(true);
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }

    async function deleteNote(noteId) {
      if (!confirm('Delete this note?')) return;
      try {
        await authenticatedRequest('delete_note', '', { noteId });
        showToast('Note deleted', 'info', 2000);
        await loadArchive(true);
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }

    async function submitRating(movieKey, movieTitle, rating, actingAs) {
      if (!currentUser) return;
      const who = actingAs || currentUser;
      // Check if this is a blind-mode reveal (Peer rating for the first time)
      const wasPeerBlind = who === 'peer' && rating > 0 && !(cachedPeerMap[movieKey] > 0);
      // Find Greg's hidden rating before the re-render
      let gregHiddenRating = 0;
      if (wasPeerBlind) {
        const gregEntry = cachedGregItems.find(e => getMovieKey(e) === movieKey);
        if (gregEntry) gregHiddenRating = Number(gregEntry.gregRating) || 0;
      }
      try {
        const payload = { rating, movieTitle };
        if (isAdmin() && actingAs) payload.actingAs = actingAs;
        await authenticatedRequest('rate', movieKey, payload);

        if (wasPeerBlind && gregHiddenRating > 0) {
          // Show dramatic reveal
          showRatingReveal(movieTitle, rating, gregHiddenRating, movieKey);
        } else {
          showToast(rating > 0 ? `Rated ${decodeHtml(movieTitle)} ${starsFromNumeric(rating)} as ${who.toUpperCase()}` : 'Rating removed', 'success', 2500);
        }
        await loadArchive(true);
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }

    function showRatingReveal(movieTitle, peerRating, gregRating, movieKey) {
      const gap = Math.abs(gregRating - peerRating);
      let gapColor, gapText;
      if (gap === 0) { gapColor = 'var(--text-secondary)'; gapText = 'Perfect Agreement'; }
      else if (gap <= 1) { gapColor = 'var(--text-secondary)'; gapText = `Only ${gap}✦ apart`; }
      else if (gap >= 3) { gapColor = 'var(--text)'; gapText = `${gap}✦ gap — Big Debate`; }
      else { gapColor = 'var(--text-muted)'; gapText = `${gap}✦ gap`; }

      const overlay = document.createElement('div');
      overlay.className = 'reveal-overlay';
      overlay.innerHTML = `
        <div class="reveal-card">
          <div class="reveal-title">Rating Reveal</div>
          <div class="reveal-movie">${decodeHtml(movieTitle)}</div>
          <div class="reveal-ratings">
            <div class="reveal-col">
              <div class="reveal-name">You rated</div>
              <div class="reveal-stars">${starsFromNumeric(peerRating)}</div>
            </div>
            <div class="reveal-vs">VS</div>
            <div class="reveal-col">
              <div class="reveal-name">Greg rated</div>
              <div class="reveal-hidden" id="reveal-greg-stars">???</div>
            </div>
          </div>
          <div class="reveal-gap" id="reveal-gap" style="color:${gapColor}"></div>
          <button class="reveal-close-btn" id="reveal-close-btn">Nice!</button>
        </div>
      `;

      document.body.appendChild(overlay);
      document.body.style.overflow = 'hidden';

      // Animate the reveal after delay
      setTimeout(() => {
        const el = document.getElementById('reveal-greg-stars');
        if (el) el.textContent = starsFromNumeric(gregRating);
      }, 900);

      setTimeout(() => {
        const el = document.getElementById('reveal-gap');
        if (el) el.textContent = gapText;
      }, 1300);

      document.getElementById('reveal-close-btn').onclick = () => {
        overlay.remove();
        document.body.style.overflow = '';
      };
      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) { overlay.remove(); document.body.style.overflow = ''; }
      });
    }

    /* ═══════════════════════════════════════════
       MAIN LOAD
    ═══════════════════════════════════════════ */
    async function loadArchive(preserveScroll = false) {
      setError('');
      const scrollY = preserveScroll ? window.scrollY : 0;

      if (!preserveScroll) showSkeletons(6);

      try {
        const [peerMap, gregItems, gregWebMap, reactions, notesMap] = await Promise.all([
          fetchPeerRatings(),
          fetchGregFilms(),
          fetchGregWebRatings(),
          fetchReactions(),
          fetchNotes()
        ]);

        // Merge Greg's website ratings into gregItems — website rating takes priority
        // over the Letterboxd rating so the daily sync can't overwrite manual changes.
        gregItems.forEach(entry => {
          const webRating = gregWebMap[entry.movieKey];
          if (webRating != null && webRating > 0) {
            entry.gregRating = webRating;
          }
        });

        cachedGregItems = gregItems;
        cachedPeerMap = peerMap;
        cachedReactions = reactions;
        cachedNotesMap = notesMap;

        computeStats(gregItems, peerMap);

        const items = getFilteredAndSorted();
        renderLedger(items, peerMap, reactions, notesMap);

        setLastVisit();
        isInitialRender = false;

        if (preserveScroll) window.scrollTo(0, scrollY);
      } catch (e) {
        setError(e?.message || String(e));
        console.error('Error:', e);
      }
    }

    /* ═══════════════════════════════════════════
       LOGIN / LOGOUT
    ═══════════════════════════════════════════ */
    function showLoginModal() {
      if (currentUser) return;

      const modal = document.getElementById('login-modal');
      const passwordInput = document.getElementById('password-input');

      selectedReviewer = null;
      passwordInput.value = '';
      document.getElementById('login-error').classList.remove('visible');
      document.querySelectorAll('.reviewer-option').forEach(opt => opt.classList.remove('selected'));
      document.getElementById('login-submit').disabled = true;

      modal.classList.add('visible');
    }

    function closeLoginModal() {
      document.getElementById('login-modal').classList.remove('visible');
      selectedReviewer = null;
    }

    function selectReviewer(reviewer) {
      selectedReviewer = reviewer;
      document.querySelectorAll('.reviewer-option').forEach(opt => opt.classList.remove('selected'));
      document.querySelector(`.reviewer-option[data-reviewer="${reviewer}"]`).classList.add('selected');
      document.getElementById('login-submit').disabled = !document.getElementById('password-input').value;
      document.getElementById('password-input').focus();
    }

    async function attemptLogin() {
      const password = document.getElementById('password-input').value;
      const errorMsg = document.getElementById('login-error');
      const submitBtn = document.getElementById('login-submit');

      if (!selectedReviewer) return showToast('Please select a reviewer', 'error');
      if (!password) return showToast('Please enter an access key', 'error');

      submitBtn.disabled = true;
      submitBtn.textContent = 'Logging in...';

      try {
        const res = await fetch(`${AUTH_FUNCTION_URL}?action=login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ reviewer: selectedReviewer, password })
        });

        const data = await res.json();

        if (!res.ok || data.error) {
          errorMsg.classList.add('visible');
          document.getElementById('password-input').value = '';
          document.getElementById('password-input').focus();
          submitBtn.disabled = false;
          submitBtn.textContent = 'Login';
          return;
        }

        currentUser = data.reviewer;
        sessionToken = data.token;
        localStorage.setItem('reviewer', data.reviewer);
        localStorage.setItem('session_token', data.token);

        closeLoginModal();
        setAuthUI();
        showToast(`Logged in as ${data.reviewer.toUpperCase()}`, 'success');
        fetchNotifications();
        await loadArchive();
      } catch (e) {
        showToast('Login failed: ' + e.message, 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Login';
      }
    }

    async function logout(silent = false) {
      if (!silent && !confirm('Log out?')) return;

      try {
        if (sessionToken) {
          await fetch(`${AUTH_FUNCTION_URL}?action=logout`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${sessionToken}` }
          });
        }
      } catch (e) { console.error('Logout error:', e); }

      currentUser = null;
      sessionToken = null;
      localStorage.removeItem('reviewer');
      localStorage.removeItem('session_token');
      setAuthUI();
      if (!silent) showToast('Logged out', 'info', 2000);
      loadArchive();
    }

    /* ═══════════════════════════════════════════
       DELETE FILM (CONFIRMATION MODAL)
    ═══════════════════════════════════════════ */
    function showConfirmModal(titleText, subtitleText, onConfirm) {
      const existing = document.getElementById('confirm-modal');
      if (existing) existing.remove();

      const overlay = document.createElement('div');
      overlay.className = 'confirm-overlay';
      overlay.id = 'confirm-modal';

      overlay.innerHTML = `
        <div class="confirm-panel">
          <div class="confirm-title">${titleText}</div>
          <div class="confirm-subtitle">${subtitleText}</div>
          <div class="confirm-actions">
            <button class="confirm-btn secondary" id="confirm-cancel">Cancel</button>
            <button class="confirm-btn primary" id="confirm-ok">Confirm</button>
          </div>
        </div>
      `;

      document.body.appendChild(overlay);

      function dismiss() { overlay.remove(); document.removeEventListener('keydown', onKey); }

      document.getElementById('confirm-cancel').onclick = dismiss;
      document.getElementById('confirm-ok').onclick = () => { dismiss(); onConfirm(); };
      overlay.addEventListener('click', (e) => { if (e.target === overlay) dismiss(); });

      function onKey(e) { if (e.key === 'Escape') dismiss(); }
      document.addEventListener('keydown', onKey);
    }

    function showDeleteFilmModal(filmTitle, movieKey) {
      showConfirmModal(
        'Remove \u201C' + filmTitle + '\u201D from The Ledger?',
        'This will delete all ratings, reactions, and notes for this film.',
        () => deleteFilm(movieKey, filmTitle)
      );
    }

    async function deleteFilm(movieKey, filmTitle) {
      try {
        const result = await authenticatedRequest('delete_film', movieKey, {});
        if (result) {
          showToast('Film removed', 'info', 2500);
          await loadArchive(false);
        }
      } catch (e) {
        showToast('Error: ' + e.message, 'error');
      }
    }

    /* ═══════════════════════════════════════════
       LOG FILM FEATURE
    ═══════════════════════════════════════════ */
    const elLogFilmBtn = document.getElementById('log-film-btn');
    const elLogFilmModal = document.getElementById('log-film-modal');
    const elLogFilmSearch = document.getElementById('log-film-search');
    const elLogFilmResults = document.getElementById('log-film-results');
    let logFilmDebounce = null;

    function openLogFilmModal() {
      elLogFilmModal.classList.add('visible');
      elLogFilmSearch.value = '';
      elLogFilmResults.innerHTML = '<div class="log-film-hint">Type a film title to search</div>';
      setTimeout(() => elLogFilmSearch.focus(), 100);
    }

    function closeLogFilmModal() {
      elLogFilmModal.classList.remove('visible');
      elLogFilmSearch.value = '';
      elLogFilmResults.innerHTML = '<div class="log-film-hint">Type a film title to search</div>';
    }

    elLogFilmBtn.addEventListener('click', openLogFilmModal);

    elLogFilmModal.addEventListener('click', (e) => {
      if (e.target === elLogFilmModal) closeLogFilmModal();
    });

    function generateMovieKey(title) {
      return title.toLowerCase()
        .replace(/['']/g, '')
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '');
    }

    elLogFilmSearch.addEventListener('input', () => {
      clearTimeout(logFilmDebounce);
      const q = elLogFilmSearch.value.trim();
      if (q.length < 2) {
        elLogFilmResults.innerHTML = '<div class="log-film-hint">Type a film title to search</div>';
        return;
      }
      elLogFilmResults.innerHTML = '<div class="log-film-hint">Searching...</div>';
      logFilmDebounce = setTimeout(() => searchTMDBForLogFilm(q), 400);
    });

    async function searchTMDBForLogFilm(query) {
      try {
        const url = TMDB_BASE + '/search/movie?api_key=' + TMDB_KEY + '&query=' + encodeURIComponent(query);
        const resp = await fetch(url);
        const json = await resp.json();
        const results = (json.results || []).slice(0, 10);

        if (results.length === 0) {
          elLogFilmResults.innerHTML = '<div class="log-film-hint">No results found</div>';
          return;
        }

        elLogFilmResults.innerHTML = '';
        results.forEach(movie => {
          const row = document.createElement('div');
          row.className = 'log-film-row';

          const year = movie.release_date ? movie.release_date.substring(0, 4) : '';

          if (movie.poster_path) {
            row.innerHTML = `
              <img class="log-film-poster" src="https://image.tmdb.org/t/p/w92${movie.poster_path}" alt="" loading="lazy" />
              <div class="log-film-info">
                <div class="log-film-info-title">${movie.title}</div>
                <div class="log-film-info-year">${year}</div>
              </div>`;
          } else {
            row.innerHTML = `
              <div class="log-film-poster-empty">—</div>
              <div class="log-film-info">
                <div class="log-film-info-title">${movie.title}</div>
                <div class="log-film-info-year">${year}</div>
              </div>`;
          }

          row.addEventListener('click', () => handleLogFilmSelect(movie));
          elLogFilmResults.appendChild(row);
        });
      } catch (err) {
        console.error('[Log Film] TMDB search error:', err);
        elLogFilmResults.innerHTML = '<div class="log-film-hint">Search failed — try again</div>';
      }
    }

    async function handleLogFilmSelect(movie) {
      const movieKey = generateMovieKey(movie.title);
      const year = movie.release_date ? movie.release_date.substring(0, 4) : '';

      // Check if film already exists in the ledger
      const existing = cachedGregItems.find(e => getMovieKey(e) === movieKey);
      if (existing) {
        closeLogFilmModal();
        showToast('Already in the ledger', 'info', 2500);

        // Clear search + filters so the film is visible
        elSearch.value = '';
        elSearch.dispatchEvent(new Event('input'));
        document.querySelector('.filter-chip[data-filter="all"]')?.click();

        // Wait a tick for rerender then scroll to the card
        requestAnimationFrame(() => {
          const targetCard = document.querySelector(`.entry[data-movie-key="${movieKey}"]`);
          if (targetCard) {
            targetCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            targetCard.classList.add('highlight-flash');
            targetCard.addEventListener('animationend', () => {
              targetCard.classList.remove('highlight-flash');
            }, { once: true });
          }
        });
        return;
      }

      // New film — submit to backend
      const posterUrl = movie.poster_path ? `https://image.tmdb.org/t/p/w342${movie.poster_path}` : null;
      const watchedDate = new Date().toISOString().substring(0, 10);

      try {
        elLogFilmResults.innerHTML = '<div class="log-film-hint">Adding film...</div>';
        const result = await authenticatedRequest('add_film', movieKey, {
          title: movie.title,
          posterUrl,
          year,
          watchedDate
        });

        if (result) {
          closeLogFilmModal();
          showToast('Film added', 'success', 2500);
          await loadArchive(false);
        }
      } catch (err) {
        if (err.message && err.message.includes('already')) {
          // Backend 409 duplicate guard
          closeLogFilmModal();
          showToast('Already in the ledger', 'info', 2500);
          await loadArchive(true);
        } else {
          showToast('Error: ' + err.message, 'error');
          elLogFilmResults.innerHTML = '<div class="log-film-hint">Failed — try again</div>';
        }
      }
    }

    /* ═══════════════════════════════════════════
       ADMIN BACKUP DOWNLOAD
    ═══════════════════════════════════════════ */
    (function initBackupBtn() {
      const btn = document.getElementById('backup-btn');
      if (!btn) return;

      const BACKUP_TABLES = [
        'greg_films', 'ratings', 'rating_reactions',
        'film_arguments', 'watchlist', 'achievements', 'weekly_recaps'
      ];

      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        if (!isAdmin()) return;
        btn.disabled = true;
        btn.textContent = 'Exporting\u2026';

        try {
          const tables = {};
          for (const table of BACKUP_TABLES) {
            const BATCH = 1000;
            let allRows = [];
            let from = 0;
            while (true) {
              const { data, error } = await supabaseClient
                .from(table)
                .select('*')
                .range(from, from + BATCH - 1);
              if (error) { console.warn('Backup read error on ' + table, error); break; }
              if (!data || data.length === 0) break;
              allRows = allRows.concat(data);
              if (data.length < BATCH) break;
              from += BATCH;
            }
            tables[table] = allRows;
          }

          const backup = {
            created_at: new Date().toISOString(),
            version: '1.0',
            tables
          };

          const json = JSON.stringify(backup, null, 2);
          const blob = new Blob([json], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const dateStr = new Date().toISOString().split('T')[0];
          const a = document.createElement('a');
          a.href = url;
          a.download = 'dufive-backup-' + dateStr + '.json';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);

          const totalRows = Object.values(tables).reduce((s, t) => s + t.length, 0);
          showToast('Backup downloaded (' + totalRows + ' rows)', 'success', 3000);
        } catch (err) {
          showToast('Backup failed: ' + err.message, 'error');
        }

        btn.textContent = 'Backup';
        btn.disabled = false;
      });
    })();

    /* ═══════════════════════════════════════════
       INIT
    ═══════════════════════════════════════════ */
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.reviewer-option').forEach(option => {
        option.addEventListener('click', () => selectReviewer(option.dataset.reviewer));
      });

      const passwordInput = document.getElementById('password-input');
      passwordInput.addEventListener('input', () => {
        document.getElementById('login-submit').disabled = !selectedReviewer || !passwordInput.value.length;
        document.getElementById('login-error').classList.remove('visible');
      });

      passwordInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && selectedReviewer && passwordInput.value) attemptLogin();
      });

      document.getElementById('login-submit').addEventListener('click', attemptLogin);

      document.getElementById('login-modal').addEventListener('click', (e) => {
        if (e.target.id === 'login-modal') closeLoginModal();
      });

      let lastKeyTime = 0, lastKey = '';
      document.addEventListener('keydown', (e) => {
        const tag = document.activeElement.tagName;
        const inInput = tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT';

        if (e.key === 'Escape') {
          if (elLogFilmModal.classList.contains('visible')) { closeLogFilmModal(); return; }
          const sc = document.getElementById('shortcuts-overlay');
          if (sc.classList.contains('open')) { sc.classList.remove('open'); return; }
          const revealedPosters = document.querySelectorAll('.poster-frame.revealed');
          if (revealedPosters.length) { revealedPosters.forEach(pf => pf.classList.remove('revealed')); return; }
          if (document.getElementById('login-modal').classList.contains('visible')) closeLoginModal();
          const sp = document.getElementById('star-picker');
          if (sp.style.display === 'flex') sp.style.display = 'none';
          return;
        }
        if (inInput) return;
        if (e.key === '/' && !e.ctrlKey && !e.metaKey) {
          e.preventDefault(); elSearch.focus(); return;
        }
        if (e.key === '?' && !e.ctrlKey && !e.metaKey) {
          e.preventDefault();
          document.getElementById('shortcuts-overlay').classList.toggle('open');
          return;
        }
        if (e.key === 't' && !e.ctrlKey && !e.metaKey) {
          document.querySelector('.theme-toggle')?.click();
          return;
        }
        // GG to scroll to top
        if (e.key === 'g') {
          const now = Date.now();
          if (lastKey === 'g' && now - lastKeyTime < 500) {
            window.scrollTo({ top: 0, behavior: 'smooth' });
            lastKey = ''; return;
          }
          lastKey = 'g'; lastKeyTime = now; return;
        }
        lastKey = '';
      });
    });

    elAuthBtn.addEventListener('click', showLoginModal);
    elLogoutBtn.addEventListener('click', () => logout(false));

    setAuthUI();
    fetchNotifications();
    fetchBadges();
    loadArchive();

    // ─── Realtime: live updates when the other person rates/reacts/notes ───
    supabaseClient
      .channel('ledger-live')
      .on('postgres_changes', { event: '*', schema: 'public', table: 'ratings' }, () => {
        loadArchive(true);
        fetchNotifications();
      })
      .on('postgres_changes', { event: '*', schema: 'public', table: 'rating_reactions' }, () => {
        loadArchive(true);
      })
      .on('postgres_changes', { event: '*', schema: 'public', table: 'film_arguments' }, () => {
        loadArchive(true);
        fetchNotifications();
      })
      .subscribe();

    // ─── Scroll-triggered card entrance animations ───
    const cardObserver = new IntersectionObserver((entries) => {
      entries.forEach((entry, i) => {
        if (entry.isIntersecting) {
          // stagger each card in the batch by 60ms
          setTimeout(() => entry.target.classList.add('visible'), i * 60);
          cardObserver.unobserve(entry.target);
        }
      });
    }, { threshold: 0.08, rootMargin: '0px 0px -40px 0px' });

    // Re-observe cards after each render
    const origAppendChild = elGrid.appendChild.bind(elGrid);
    elGrid.appendChild = function(child) {
      origAppendChild(child);
      if (child.classList && child.classList.contains('entry')) {
        cardObserver.observe(child);
      }
      return child;
    };

    // ─── Register Service Worker for PWA ───
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js').catch(() => {});
    }
  </script>
</body>
</html>
